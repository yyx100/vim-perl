<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
 <head>
  <title>[untitled]</title>
  <link rel="stylesheet" type="text/css" href="../../t/vim_syntax.css" />
 </head>
 <body>

<pre><span class="synStatement">package</span><span class="synType"> Moose::Meta::Role::Application::ToRole</span>;
<span class="synPreProc">BEGIN </span>{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Role::Application::ToRole::</span><span class="synIdentifier">AUTHORITY</span> = <span class="synString">'cpan:STEVAN'</span>;
}
{
  <span class="synIdentifier">$</span><span class="synType">Moose::Meta::Role::Application::ToRole::</span><span class="synIdentifier">VERSION</span> = <span class="synString">'2.1005'</span>;
}

<span class="synStatement">use strict</span>;
<span class="synStatement">use warnings</span>;
<span class="synStatement">use </span>metaclass;

<span class="synStatement">use </span>Scalar::Util    <span class="synString">'blessed'</span>;

<span class="synStatement">use base</span> <span class="synString">'Moose::Meta::Role::Application'</span>;

<span class="synKeyword">sub </span><span class="synFunction">apply </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$self-&gt;SUPER</span>::apply(<span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>);
    <span class="synIdentifier">$role2-&gt;add_role</span>(<span class="synIdentifier">$role1</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">check_role_exclusions </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synConditional">if</span> ( <span class="synIdentifier">$role2-&gt;excludes_role</span>(<span class="synIdentifier">$role1-&gt;name</span>) ) {
        <span class="synStatement">require</span> Moose;
        Moose-&gt;throw_error(<span class="synString">&quot;Conflict detected: &quot;</span> . <span class="synIdentifier">$role2-&gt;name</span> . <span class="synString">&quot; excludes role '&quot;</span> . <span class="synIdentifier">$role1-&gt;name</span> . <span class="synString">&quot;'&quot;</span>);
    }
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$excluded_role_name</span> (<span class="synIdentifier">$role1-&gt;get_excluded_roles_list</span>) {
        <span class="synConditional">if</span> ( <span class="synIdentifier">$role2-&gt;does_role</span>(<span class="synIdentifier">$excluded_role_name</span>) ) {
            <span class="synStatement">require</span> Moose;
            Moose-&gt;throw_error(<span class="synString">&quot;The role &quot;</span> . <span class="synIdentifier">$role2-&gt;name</span> . <span class="synString">&quot; does the excluded role '</span><span class="synIdentifier">$excluded_role_name</span><span class="synString">'&quot;</span>);
        }
        <span class="synIdentifier">$role2-&gt;add_excluded_roles</span>(<span class="synIdentifier">$excluded_role_name</span>);
    }
}

<span class="synKeyword">sub </span><span class="synFunction">check_required_methods </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$required_method</span> (<span class="synIdentifier">$role1-&gt;get_required_method_list</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$required_method_name</span> = <span class="synIdentifier">$required_method-&gt;name</span>;

        <span class="synStatement">next</span> <span class="synConditional">if</span> <span class="synIdentifier">$self-&gt;is_aliased_method</span>(<span class="synIdentifier">$required_method_name</span>);

        <span class="synIdentifier">$role2-&gt;add_required_methods</span>(<span class="synIdentifier">$required_method</span>)
            <span class="synConditional">unless</span> <span class="synIdentifier">$role2-&gt;find_method_by_name</span>(<span class="synIdentifier">$required_method_name</span>);
    }
}

<span class="synKeyword">sub </span><span class="synFunction">check_required_attributes </span>{

}

<span class="synKeyword">sub </span><span class="synFunction">apply_attributes </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$attribute_name</span> (<span class="synIdentifier">$role1-&gt;get_attribute_list</span>) {
        <span class="synComment"># it if it has one already</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$role2-&gt;has_attribute</span>(<span class="synIdentifier">$attribute_name</span>) &amp;&amp;
            <span class="synComment"># make sure we haven't seen this one already too</span>
            <span class="synIdentifier">$role2-&gt;get_attribute</span>(<span class="synIdentifier">$attribute_name</span>) != <span class="synIdentifier">$role1-&gt;get_attribute</span>(<span class="synIdentifier">$attribute_name</span>)) {

            <span class="synStatement">my</span> <span class="synIdentifier">$role2_name</span> = <span class="synIdentifier">$role2-&gt;name</span>;

            <span class="synStatement">require</span> Moose;
            Moose-&gt;throw_error( <span class="synString">&quot;Role '&quot;</span>
                    . <span class="synIdentifier">$role1-&gt;name</span>
                    . <span class="synString">&quot;' has encountered an attribute conflict&quot;</span>
                    . <span class="synString">&quot; while being composed into '</span><span class="synIdentifier">$role2_name</span><span class="synString">'.&quot;</span>
                    . <span class="synString">&quot; This is a fatal error and cannot be disambiguated.&quot;</span>
                    . <span class="synString">&quot; The conflicting attribute is named '</span><span class="synIdentifier">$attribute_name</span><span class="synString">'.&quot;</span> );
        }
        <span class="synConditional">else</span> {
            <span class="synIdentifier">$role2-&gt;add_attribute</span>(
                <span class="synIdentifier">$role1-&gt;get_attribute</span>(<span class="synIdentifier">$attribute_name</span>)-&gt;clone
            );
        }
    }
}

<span class="synKeyword">sub </span><span class="synFunction">apply_methods </span>{
    <span class="synStatement">my</span> ( <span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span> ) = <span class="synIdentifier">@_</span>;
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$method</span> ( <span class="synIdentifier">$role1-&gt;_get_local_methods</span> ) {

        <span class="synStatement">my</span> <span class="synIdentifier">$method_name</span> = <span class="synIdentifier">$method-&gt;name</span>;

        <span class="synStatement">next</span> <span class="synConditional">if</span> <span class="synIdentifier">$method-&gt;isa</span>(<span class="synString">'Class::MOP::Method::Meta'</span>);

        <span class="synConditional">unless</span> ( <span class="synIdentifier">$self-&gt;is_method_excluded</span>(<span class="synIdentifier">$method_name</span>) ) {

            <span class="synStatement">my</span> <span class="synIdentifier">$role2_method</span> = <span class="synIdentifier">$role2-&gt;get_method</span>(<span class="synIdentifier">$method_name</span>);
            <span class="synConditional">if</span> (   <span class="synIdentifier">$role2_method</span>
                &amp;&amp; <span class="synIdentifier">$role2_method-&gt;body</span> != <span class="synIdentifier">$method-&gt;body</span> ) {

                <span class="synComment"># method conflicts between roles used to result in the method</span>
                <span class="synComment"># becoming a requirement but now are permitted just like</span>
                <span class="synComment"># for classes, hence no code in this branch anymore.</span>
            }
            <span class="synConditional">else</span> {
                <span class="synIdentifier">$role2-&gt;add_method</span>(
                    <span class="synIdentifier">$method_name</span>,
                    <span class="synIdentifier">$method</span>,
                );
            }
        }

        <span class="synStatement">next</span> <span class="synConditional">unless</span> <span class="synIdentifier">$self-&gt;is_method_aliased</span>(<span class="synIdentifier">$method_name</span>);

        <span class="synStatement">my</span> <span class="synIdentifier">$aliased_method_name</span> = <span class="synIdentifier">$self-&gt;get_method_aliases-&gt;{$method_name}</span>;

        <span class="synStatement">my</span> <span class="synIdentifier">$role2_method</span> = <span class="synIdentifier">$role2-&gt;get_method</span>(<span class="synIdentifier">$aliased_method_name</span>);

        <span class="synConditional">if</span> (   <span class="synIdentifier">$role2_method</span>
            &amp;&amp; <span class="synIdentifier">$role2_method-&gt;body</span> != <span class="synIdentifier">$method-&gt;body</span> ) {

            <span class="synStatement">require</span> Moose;
            Moose-&gt;throw_error(
                <span class="synString">&quot;Cannot create a method alias if a local method of the same name exists&quot;</span>
            );
        }

        <span class="synIdentifier">$role2-&gt;add_method</span>(
            <span class="synIdentifier">$aliased_method_name</span>,
            <span class="synIdentifier">$role1-&gt;get_method</span>(<span class="synIdentifier">$method_name</span>)
        );

        <span class="synConditional">if</span> ( !<span class="synIdentifier">$role2-&gt;has_method</span>(<span class="synIdentifier">$method_name</span>) ) {
            <span class="synIdentifier">$role2-&gt;add_required_methods</span>(<span class="synIdentifier">$method_name</span>)
                <span class="synConditional">unless</span> <span class="synIdentifier">$self-&gt;is_method_excluded</span>(<span class="synIdentifier">$method_name</span>);
        }
    }
}

<span class="synKeyword">sub </span><span class="synFunction">apply_override_method_modifiers </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$method_name</span> (<span class="synIdentifier">$role1-&gt;get_method_modifier_list</span>(<span class="synString">'override'</span>)) {
        <span class="synComment"># it if it has one already then ...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$role2-&gt;has_method</span>(<span class="synIdentifier">$method_name</span>)) {
            <span class="synComment"># if it is being composed into another role</span>
            <span class="synComment"># we have a conflict here, because you cannot</span>
            <span class="synComment"># combine an overridden method with a locally</span>
            <span class="synComment"># defined one</span>
            <span class="synStatement">require</span> Moose;
            Moose-&gt;throw_error(<span class="synString">&quot;Role '&quot;</span> . <span class="synIdentifier">$role1-&gt;name</span> . <span class="synString">&quot;' has encountered an 'override' method conflict &quot;</span> .
                    <span class="synString">&quot;during composition (A local method of the same name as been found). This &quot;</span> .
                    <span class="synString">&quot;is fatal error.&quot;</span>);
        }
        <span class="synConditional">else</span> {
            <span class="synComment"># if we are a role, we need to make sure</span>
            <span class="synComment"># we don't have a conflict with the role</span>
            <span class="synComment"># we are composing into</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$role2-&gt;has_override_method_modifier</span>(<span class="synIdentifier">$method_name</span>) &amp;&amp;
                <span class="synIdentifier">$role2-&gt;get_override_method_modifier</span>(<span class="synIdentifier">$method_name</span>) != <span class="synIdentifier">$role2-&gt;get_override_method_modifier</span>(<span class="synIdentifier">$method_name</span>)) {

                <span class="synStatement">require</span> Moose;
                Moose-&gt;throw_error(<span class="synString">&quot;Role '&quot;</span> . <span class="synIdentifier">$role1-&gt;name</span> . <span class="synString">&quot;' has encountered an 'override' method conflict &quot;</span> .
                        <span class="synString">&quot;during composition (Two 'override' methods of the same name encountered). &quot;</span> .
                        <span class="synString">&quot;This is fatal error.&quot;</span>);
            }
            <span class="synConditional">else</span> {
                <span class="synComment"># if there is no conflict,</span>
                <span class="synComment"># just add it to the role</span>
                <span class="synIdentifier">$role2-&gt;add_override_method_modifier</span>(
                    <span class="synIdentifier">$method_name</span>,
                    <span class="synIdentifier">$role1-&gt;get_override_method_modifier</span>(<span class="synIdentifier">$method_name</span>)
                );
            }
        }
    }
}

<span class="synKeyword">sub </span><span class="synFunction">apply_method_modifiers </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$self</span>, <span class="synIdentifier">$modifier_type</span>, <span class="synIdentifier">$role1</span>, <span class="synIdentifier">$role2</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$add</span> = <span class="synString">&quot;add_</span><span class="synIdentifier">${modifier_type}</span><span class="synString">_method_modifier&quot;</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$get</span> = <span class="synString">&quot;get_</span><span class="synIdentifier">${modifier_type}</span><span class="synString">_method_modifiers&quot;</span>;
    <span class="synRepeat">foreach</span> <span class="synStatement">my</span> <span class="synIdentifier">$method_name</span> (<span class="synIdentifier">$role1-&gt;get_method_modifier_list</span>(<span class="synIdentifier">$modifier_type</span>)) {
        <span class="synIdentifier">$role2-&gt;$add</span>(
            <span class="synIdentifier">$method_name</span>,
            <span class="synIdentifier">$_</span>
        ) <span class="synRepeat">foreach</span> <span class="synIdentifier">$role1-&gt;$get</span>(<span class="synIdentifier">$method_name</span>);
    }
}


<span class="synNumber">1</span>;

<span class="synComment"># ABSTRACT: Compose a role into another role</span>

<span class="synComment">__END__</span>

<span class="synStatement">=pod</span>

<span class="synStatement">=head1</span><span class="synString"> NAME</span>

<span class="synperlPOD">Moose::Meta::Role::Application::ToRole - Compose a role into another role</span>

<span class="synStatement">=head1</span><span class="synString"> VERSION</span>

<span class="synperlPOD">version 2.1005</span>

<span class="synStatement">=head1</span><span class="synString"> DESCRIPTION</span>

<span class="synStatement">=head2</span><span class="synString"> METHODS</span>

<span class="synStatement">=over</span><span class="synperlPOD"> </span><span class="synNumber">4</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;new&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;meta&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;apply&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;check_role_exclusions&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;check_required_methods&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;check_required_attributes&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;apply_attributes&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;apply_methods&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;apply_method_modifiers&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">B&lt;apply_override_method_modifiers&gt;</span>

<span class="synStatement">=back</span>

<span class="synStatement">=head1</span><span class="synString"> BUGS</span>

<span class="synperlPOD">See </span><span class="synIdentifier">L&lt;Moose/BUGS&gt;</span><span class="synperlPOD"> for details on reporting bugs.</span>

<span class="synStatement">=head1</span><span class="synString"> AUTHOR</span>

<span class="synperlPOD">Moose is maintained by the Moose Cabal, along with the help of many contributors. See </span><span class="synIdentifier">L&lt;Moose/CABAL&gt;</span><span class="synperlPOD"> and </span><span class="synIdentifier">L&lt;Moose/CONTRIBUTORS&gt;</span><span class="synperlPOD"> for details.</span>

<span class="synStatement">=head1</span><span class="synString"> COPYRIGHT AND LICENSE</span>

<span class="synperlPOD">This software is copyright (c) 2013 by Infinity Interactive, Inc..</span>

<span class="synperlPOD">This is free software; you can redistribute it and/or modify it under</span>
<span class="synperlPOD">the same terms as the Perl 5 programming language system itself.</span>

<span class="synStatement">=cut</span>
</pre>

 </body>
</html>
