<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
 <head>
  <title>[untitled]</title>
  <link rel="stylesheet" type="text/css" href="../../t/vim_syntax.css" />
 </head>
 <body>

<pre><span class="synStatement">package</span><span class="synType"> Regexp::Debugger</span>;

<span class="synStatement">use warnings</span>;
<span class="synStatement">use strict</span>;
<span class="synStatement">eval</span> <span class="synString">&quot;use feature 'evalbytes'&quot;</span>;         <span class="synComment"># Experimental fix for Perl 5.16</span>

<span class="synStatement">our</span> <span class="synIdentifier">$VERSION</span> = <span class="synString">'0.001016'</span>;

<span class="synComment"># Handle Perl 5.18's new-found caution...</span>
<span class="synStatement">no if</span> <span class="synIdentifier">$]</span> &gt;= <span class="synFloat">5.018</span>, <span class="synString">warnings</span> =&gt; <span class="synString">&quot;experimental::smartmatch&quot;</span>;

<span class="synComment"># Give an accurate warning if used with an antique Perl...</span>
<span class="synPreProc">BEGIN </span>{
    <span class="synConditional">if</span> (<span class="synIdentifier">$]</span> &lt; <span class="synFloat">5.010001</span>) {
        <span class="synStatement">die</span> <span class="synStatement">sprintf</span> <span class="synString">&quot;Regexp::Debugger requires Perl v5.10.1 or later (at %s line %s)</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>,
                     (<span class="synStatement">caller</span> <span class="synNumber">2</span>)[<span class="synFloat">1..2</span>];
    }
}

<span class="synStatement">use </span><span class="synFloat">5.010001</span>; <span class="synComment"># ...activate all the tasty 5.10 goodies</span>

<span class="synStatement">use </span>List::Util <span class="synString">qw&lt; min max first sum &gt;</span>;

<span class="synComment"># Track configurable options lexically...</span>
<span class="synStatement">my</span> <span class="synIdentifier">@config</span>;

<span class="synComment"># Track debugging history in various formats...</span>
<span class="synStatement">my</span> <span class="synIdentifier">%history_of</span>;

<span class="synComment"># Persistent information within debugger...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$prev_regex_pos</span>;   <span class="synComment"># ...track where we were previously in the regex</span>
<span class="synStatement">my</span> <span class="synIdentifier">$prev_str_pos</span>;     <span class="synComment"># ...track where we were previously in the string</span>
<span class="synStatement">my</span> <span class="synIdentifier">%capture</span>;          <span class="synComment"># ...track capture groups within regex</span>
<span class="synStatement">my</span> <span class="synIdentifier">$pre_is_pending</span>;   <span class="synComment"># ...did we try something last event?</span>
<span class="synStatement">my</span> <span class="synIdentifier">$interaction_quit</span>; <span class="synComment"># ...did we get a quit request?</span>
<span class="synStatement">my</span> <span class="synIdentifier">$interaction_mode</span>; <span class="synComment"># ...step-by-step, jump to match, or continue?</span>
<span class="synStatement">my</span> <span class="synIdentifier">$display_mode</span>;     <span class="synComment"># ...how is the match being visualized at present?</span>


<span class="synComment"># Colours for heatmaps...</span>
<span class="synStatement">my</span> <span class="synIdentifier">@DEF_HEAT_COLOUR</span> = (
    <span class="synString">'white  on_black'</span>,    <span class="synComment">#  0-20  percentile</span>
    <span class="synString">'cyan   on_blue'</span>,     <span class="synComment"># 20-40  percentile</span>
    <span class="synString">'blue   on_cyan'</span>,     <span class="synComment"># 40-60  percentile</span>
    <span class="synString">'red    on_yellow'</span>,   <span class="synComment"># 60-80  percentile</span>
    <span class="synString">'yellow on_red'</span>,      <span class="synComment"># 80-100 percentile</span>
);

<span class="synComment"># Colours for detailed regex descriptions...</span>
<span class="synStatement">my</span> <span class="synIdentifier">%DESCRIPTION_COLOUR</span> = (
    <span class="synString">desc_sep_col</span>   =&gt; <span class="synString">'blue on_black underline'</span>,
    <span class="synString">desc_regex_col</span> =&gt; <span class="synString">'white on_black'</span>,
    <span class="synString">desc_text_col</span>  =&gt; <span class="synString">'cyan on_black'</span>,
);

<span class="synComment"># Colour for error messages...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$ERR_COL</span> = <span class="synString">'red'</span>;


<span class="synComment"># Default config which any explicit config modifies...</span>
<span class="synStatement">my</span> <span class="synIdentifier">@SHOW_WS_OPTIONS</span> = <span class="synString">qw&lt; compact  visible  original &gt;</span>;
<span class="synStatement">my</span> <span class="synIdentifier">%DEFAULT_CONFIG</span> = (
    <span class="synComment"># How debugging info is displayed initially...</span>
    <span class="synString">display_mode</span>  =&gt; <span class="synString">'visual'</span>,

    <span class="synComment"># Colour scheme for debugging info...</span>
    <span class="synString">info_col</span>  =&gt; <span class="synString">'       white on_black'</span>,
    <span class="synString">try_col</span>   =&gt; <span class="synString">'bold magenta on_black'</span>,
    <span class="synString">match_col</span> =&gt; <span class="synString">'   bold cyan on_black'</span>,
    <span class="synString">fail_col</span>  =&gt; <span class="synString">'      yellow on_red'</span>,
    <span class="synString">ws_col</span>    =&gt; <span class="synString">'   bold blue underline'</span>,

    <span class="synComment"># Colour scheme for regex descriptions...</span>
    <span class="synIdentifier">%DESCRIPTION_COLOUR</span>,

    <span class="synComment"># Where debugging info is written to (undef --&gt; STDOUT)...</span>
    <span class="synString">save_to_fh</span>    =&gt; <span class="synOperator">undef</span>,

    <span class="synComment"># How whitespace is managed...</span>
    <span class="synString">show_ws</span>       =&gt; <span class="synIdentifier">$SHOW_WS_OPTIONS[</span><span class="synNumber">0</span><span class="synIdentifier">]</span>,
);

<span class="synComment"># The current config...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$lexical_config</span> = \<span class="synIdentifier">%DEFAULT_CONFIG</span>;
<span class="synComment"># Simulate print() and say() on appropriate filehandle...</span>
<span class="synKeyword">sub </span><span class="synFunction">_print </span>{
    <span class="synConditional">if</span> (!<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>) {
        <span class="synStatement">no warnings</span> <span class="synString">'utf8'</span>;
        <span class="synStatement">print</span> <span class="synIdentifier">@_</span>;
    }
}

<span class="synKeyword">sub </span><span class="synFunction">_say </span>{
    <span class="synConditional">if</span> (!<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>) {
        <span class="synStatement">no warnings</span> <span class="synString">'utf8'</span>;
        <span class="synStatement">say</span> <span class="synIdentifier">@_</span>;
    }
}

<span class="synComment"># How should matches be indicated???</span>
<span class="synStatement">my</span> <span class="synIdentifier">$MATCH_DRAG</span> = <span class="synString">' '</span>;

<span class="synComment"># Will heatmaps be visible???</span>
<span class="synStatement">my</span> <span class="synIdentifier">$heatmaps_invisible</span>;

<span class="synComment"># Indent unit for hierarchical display...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$INDENT</span> = <span class="synString">q{  }</span>;

<span class="synComment"># Simulate Term::ANSIColor badly (if necessary)...</span>
<span class="synPreProc">CHECK </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$can_color</span>
        = ( <span class="synIdentifier">$^O</span> <span class="synOperator">ne</span> <span class="synString">'MSWin32'</span> <span class="synOperator">or</span> <span class="synStatement">eval</span> { <span class="synStatement">require</span> Win32::Console::ANSI } )
          &amp;&amp; <span class="synStatement">eval</span> { <span class="synStatement">require</span> Term::ANSIColor };

    <span class="synConditional">if</span> ( !<span class="synIdentifier">$can_color</span> ) {
        *Term::ANSIColor::colored = <span class="synKeyword">sub </span>{ <span class="synStatement">return</span> <span class="synStatement">shift</span> };
        <span class="synIdentifier">$MATCH_DRAG</span>         = <span class="synString">'_'</span>;
        <span class="synIdentifier">$heatmaps_invisible</span> = <span class="synNumber">1</span>;
    }
}

<span class="synComment"># Load the module...</span>
<span class="synKeyword">sub </span><span class="synFunction">import </span>{
    <span class="synStatement">use </span>Carp;

    <span class="synComment"># Don't need the module name...</span>
    <span class="synStatement">shift</span>;

    <span class="synComment"># Export re 'eval' semantics...</span>
    <span class="synIdentifier">$^H</span> |= <span class="synNumber">0x00200000</span>;

    <span class="synComment"># Unpack the arguments...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">@_</span> % <span class="synNumber">2</span>) {
        croak <span class="synString">'Odd number of configuration args after &quot;use Regexp::Debugger&quot;'</span>;
    }
    <span class="synStatement">my</span> <span class="synIdentifier">%arg</span> = <span class="synIdentifier">@_</span>;

    <span class="synComment"># Creat a new lexically scoped config and remember its index...</span>
    <span class="synStatement">push</span> <span class="synIdentifier">@config</span>, { <span class="synIdentifier">%DEFAULT_CONFIG</span> };
    <span class="synIdentifier">$^H</span>{<span class="synString">'Regexp::Debugger::lexical_scope'</span>} = <span class="synIdentifier">$#config</span>;

    _load_config(\<span class="synIdentifier">%arg</span>);

    <span class="synComment"># Signal lexical scoping (active, unless something was exported)...</span>
    <span class="synIdentifier">$^H</span>{<span class="synString">'Regexp::Debugger::active'</span>} = <span class="synNumber">1</span>;

    <span class="synComment"># Process any regexes in module's active lexical scope...</span>
    <span class="synStatement">use overload</span>;
    overload::constant(
        <span class="synString">qr</span> =&gt; <span class="synKeyword">sub </span>{
            <span class="synStatement">my</span> (<span class="synIdentifier">$raw</span>, <span class="synIdentifier">$cooked</span>, <span class="synIdentifier">$type</span>) = <span class="synIdentifier">@_</span>;

            <span class="synStatement">my</span> <span class="synIdentifier">$lexical_scope</span> = (<span class="synStatement">caller</span> <span class="synNumber">1</span>)[<span class="synNumber">10</span>]{<span class="synString">'Regexp::Debugger::lexical_scope'</span>};

            <span class="synComment"># In active scope and really a regex and interactivity possible...</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$is_interactive</span> = <span class="synOperator">defined</span> <span class="synIdentifier">$arg{</span><span class="synString">save_to</span><span class="synIdentifier">}</span> || <span class="synStatement">-t</span> *STDIN &amp;&amp; <span class="synStatement">-t</span> *STDOUT;
            <span class="synConditional">if</span> (_module_is_active() &amp;&amp; <span class="synIdentifier">$type</span> =~ <span class="synStatement">/</span><span class="synString">qq</span><span class="synSpecial">?</span><span class="synStatement">/</span> &amp;&amp; <span class="synIdentifier">$is_interactive</span>) {
                <span class="synStatement">return</span> <span class="synOperator">bless</span> {<span class="synString">cooked</span>=&gt;<span class="synIdentifier">$cooked</span>, <span class="synString">lexical_scope</span>=&gt;<span class="synIdentifier">$lexical_scope</span>}, <span class="synString">'Regexp::Debugger::Precursor'</span>;
            }
            <span class="synComment"># Ignore everything else...</span>
            <span class="synConditional">else</span> {
                <span class="synStatement">return</span> <span class="synIdentifier">$cooked</span>;
            }
        }
    );
}

<span class="synComment"># Deactivate module's regex effect when it is &quot;anti-imported&quot; with 'no'...</span>
<span class="synKeyword">sub </span><span class="synFunction">unimport </span>{
    <span class="synComment"># Signal lexical (non-)scoping...</span>
    <span class="synIdentifier">$^H</span>{<span class="synString">'Regexp::Debugger::active'</span>} = <span class="synNumber">0</span>;
}

<span class="synComment"># Encapsulate the hoopy user-defined pragma interface...</span>
<span class="synKeyword">sub </span><span class="synFunction">_module_is_active </span>{
    <span class="synStatement">return</span> (<span class="synStatement">caller</span> <span class="synNumber">1</span>)[<span class="synNumber">10</span>]-&gt;{<span class="synString">'Regexp::Debugger::active'</span>};
}

<span class="synComment"># Load ~/.rxrx config...</span>
<span class="synKeyword">sub </span><span class="synFunction">_load_config </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$explicit_config_ref</span> = <span class="synStatement">shift</span>();
    <span class="synStatement">my</span> <span class="synIdentifier">%config</span>;

    <span class="synComment"># Work out where to look...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$home_dir</span> = <span class="synIdentifier">$ENV{</span><span class="synString">HOME</span><span class="synIdentifier">}</span>;
    <span class="synConditional">if</span> (!<span class="synIdentifier">$home_dir</span> &amp;&amp; <span class="synStatement">eval</span> { <span class="synStatement">require</span> File::HomeDir } ) {
        <span class="synIdentifier">$home_dir</span> = File::HomeDir-&gt;my_home;
    }

    <span class="synComment"># Find config file...</span>
<span class="synLabel">    CONFIG_FILE:</span>
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$config_file</span> ( <span class="synString">'.rxrx'</span>, ( <span class="synIdentifier">$home_dir</span> ? <span class="synString">&quot;</span><span class="synIdentifier">$home_dir</span><span class="synString">/.rxrx&quot;</span> : () ) ) {

        <span class="synComment"># Is this a readable config file???</span>
        <span class="synStatement">open</span> <span class="synStatement">my</span> <span class="synIdentifier">$fh</span>, <span class="synString">'&lt;'</span>, <span class="synIdentifier">$config_file</span>
            <span class="synOperator">or</span> <span class="synStatement">next</span> CONFIG_FILE;

        <span class="synComment"># Read and parse config file...</span>
<span class="synLabel">        CONFIG_LINE:</span>
        <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$config_line</span> (&lt;<span class="synIdentifier">$fh</span>&gt;) {
            <span class="synConditional">if</span> (<span class="synIdentifier">$config_line</span> =~ <span class="synStatement">/</span><span class="synString">^</span><span class="synSpecial">\s*(.*?)\s*[:=]\s*(.*?)\s*</span><span class="synString">$</span><span class="synStatement">/</span>) {
                <span class="synIdentifier">$config{$1}</span> = <span class="synIdentifier">$2</span>;
            }
        }

        <span class="synStatement">last</span> CONFIG_FILE;
    }

    <span class="synComment"># Make any explicit args override .rxrxrc config...</span>
    <span class="synIdentifier">%config</span> = (<span class="synString">display</span> =&gt; <span class="synString">'visual'</span>, <span class="synIdentifier">%config</span>, <span class="synIdentifier">%{$explicit_config_ref}</span>);

    <span class="synComment"># Configure colour scheme for displays...</span>
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$colour</span> (<span class="synStatement">grep</span> <span class="synStatement">/</span><span class="synString">_col$</span><span class="synStatement">/</span>, <span class="synStatement">keys</span> <span class="synIdentifier">%DEFAULT_CONFIG</span>) {
        <span class="synConditional">if</span> (<span class="synStatement">exists</span> <span class="synIdentifier">$config{$colour}</span>) {
            <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{$colour}</span> = <span class="synIdentifier">$config{$colour}</span>
        }
    }

    <span class="synComment"># Configure how whitespace is displayed...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$show_ws</span> = <span class="synIdentifier">$config{</span><span class="synString">show_ws</span><span class="synIdentifier">}</span>;
    <span class="synConditional">if</span> (<span class="synOperator">defined</span> <span class="synIdentifier">$show_ws</span>) {
        <span class="synConditional">if</span> (<span class="synIdentifier">$show_ws</span> ~~ <span class="synIdentifier">@SHOW_WS_OPTIONS</span>) {
            <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">show_ws</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$show_ws</span>;
        }
        <span class="synConditional">else</span> {
            croak <span class="synString">&quot;Unknown 'show_ws' option: '</span><span class="synIdentifier">$show_ws</span><span class="synString">'&quot;</span>;
        }
    }

    <span class="synComment"># Configure heatmap colour scheme...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@heatmap_cols</span> =
        <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$config{$_}</span> <span class="synStatement">}</span>
        <span class="synStatement">sort</span> <span class="synStatement">{</span>
            <span class="synComment"># Sort numerically (if feasible), else alphabetically...</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$a_key</span> = <span class="synIdentifier">$a</span> =~ <span class="synStatement">/</span><span class="synSpecial">(\d+)</span><span class="synStatement">/</span> ? <span class="synIdentifier">$1</span> : <span class="synOperator">undef</span>;
            <span class="synStatement">my</span> <span class="synIdentifier">$b_key</span> = <span class="synIdentifier">$b</span> =~ <span class="synStatement">/</span><span class="synSpecial">(\d+)</span><span class="synStatement">/</span> ? <span class="synIdentifier">$1</span> : <span class="synOperator">undef</span>;
            <span class="synOperator">defined</span> <span class="synIdentifier">$a_key</span> &amp;&amp; <span class="synOperator">defined</span> <span class="synIdentifier">$b_key</span>
                ? <span class="synIdentifier">$a_key</span> &lt;=&gt; <span class="synIdentifier">$b_key</span>
                : <span class="synIdentifier">$a</span>     <span class="synOperator">cmp</span> <span class="synIdentifier">$b</span>;
        <span class="synStatement">}</span>
        <span class="synStatement">grep</span> <span class="synStatement">{</span> <span class="synStatement">/</span><span class="synString">^heatmap</span><span class="synStatement">/</span> <span class="synStatement">}</span>
        <span class="synStatement">keys</span> <span class="synIdentifier">%config</span>;

    <span class="synConditional">if</span> (!<span class="synIdentifier">@heatmap_cols</span>) {
        <span class="synIdentifier">@heatmap_cols</span> = <span class="synIdentifier">@DEF_HEAT_COLOUR</span>;
    }

    <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">heatmap_col</span><span class="synIdentifier">}</span> = \<span class="synIdentifier">@heatmap_cols</span>;


    <span class="synComment"># Configure initial display mode...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$display</span> = <span class="synIdentifier">$config{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
    <span class="synConditional">if</span> (<span class="synOperator">defined</span> <span class="synIdentifier">$display</span>) {
        <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display_mode</span><span class="synIdentifier">}</span>
            = <span class="synIdentifier">$display</span> =~ <span class="synStatement">m{</span><span class="synString">^events</span><span class="synStatement">}i</span>  ? <span class="synString">'events'</span>
            : <span class="synIdentifier">$display</span> =~ <span class="synStatement">m{</span><span class="synString">^heatmap</span><span class="synStatement">}i</span> ? <span class="synString">'heatmap'</span>
            : <span class="synIdentifier">$display</span> =~ <span class="synStatement">m{</span><span class="synString">^visual</span><span class="synStatement">}i</span>  ? <span class="synString">'visual'</span>
            : <span class="synIdentifier">$display</span> =~ <span class="synStatement">m{</span><span class="synString">^JSON</span><span class="synStatement">}i</span>    ? <span class="synString">'JSON'</span>
            : croak <span class="synString">&quot;Unknown 'display' option: '</span><span class="synIdentifier">$display</span><span class="synString">'&quot;</span>;
    }

    <span class="synComment"># Configure destination of debugging info...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$save_to</span> = <span class="synIdentifier">$config{</span><span class="synString">save_to</span><span class="synIdentifier">}</span>;
    <span class="synConditional">if</span> (<span class="synOperator">defined</span> <span class="synIdentifier">$save_to</span>) {
        <span class="synStatement">use </span>Scalar::Util <span class="synString">qw&lt; openhandle &gt;</span>;
        <span class="synConditional">if</span> (openhandle(<span class="synIdentifier">$save_to</span>)) {
            <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$save_to</span>;
        }
        <span class="synConditional">elsif</span> (!<span class="synOperator">ref</span> <span class="synIdentifier">$save_to</span>) {
            <span class="synStatement">my</span> (<span class="synIdentifier">$mode</span>, <span class="synIdentifier">$filename</span>) = <span class="synIdentifier">$save_to</span> =~ <span class="synStatement">m{</span><span class="synString"> </span><span class="synSpecial">(</span><span class="synString">&gt;{0,2}</span><span class="synSpecial">)</span><span class="synString"> </span><span class="synSpecial">(.*)</span><span class="synString"> </span><span class="synStatement">}x</span>;
            <span class="synStatement">open</span> <span class="synStatement">my</span> <span class="synIdentifier">$fh</span>, <span class="synIdentifier">$mode</span>||<span class="synString">'&gt;'</span>, <span class="synIdentifier">$filename</span>
                <span class="synOperator">or</span> croak <span class="synString">&quot;Invalid 'save_to' option: '</span><span class="synIdentifier">$save_to</span><span class="synString">'</span><span class="synSpecial">\n</span><span class="synString">(</span><span class="synIdentifier">$!</span><span class="synString">)&quot;</span>;
            <span class="synIdentifier">$config[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$fh</span>;
        }
        <span class="synConditional">else</span> {
            croak <span class="synString">&quot;Invalid 'save_to' option: &quot;</span>, <span class="synOperator">ref</span>(<span class="synIdentifier">$save_to</span>);
        }
    }
}


<span class="synComment"># General memory for each state of each regex...</span>
<span class="synComment"># (structure is: $state{REGEX_NUM}{STATE_NUMBER}{ATTRIBUTE})</span>
<span class="synStatement">my</span> <span class="synIdentifier">%state</span>;
<span class="synStatement">my</span> <span class="synIdentifier">$next_regex_ID</span> = <span class="synNumber">0</span>;


<span class="synComment">#=====[ COMPILE-TIME INTERIM REPRESENTATION OF REGEXES ]===================</span>
{
    <span class="synStatement">package</span><span class="synType"> Regexp::Debugger::Precursor</span>;

    <span class="synComment"># Only translate precursors once...</span>
    <span class="synStatement">state</span> <span class="synIdentifier">%regex_cache</span>;

    <span class="synStatement">use overload</span> (
        <span class="synComment"># Concatenation/interpolation just concatenates to the precursor...</span>
        <span class="synString">q{.}</span> =&gt; <span class="synKeyword">sub </span>{
            <span class="synStatement">my</span> (<span class="synIdentifier">$x</span>, <span class="synIdentifier">$y</span>, <span class="synIdentifier">$reversed</span>) = <span class="synIdentifier">@_</span>;

            <span class="synComment"># Where are we from???</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$lexical_scope</span> = <span class="synIdentifier">$x-&gt;{</span><span class="synString">lexical_scope</span><span class="synIdentifier">}</span> // <span class="synNumber">0</span>;

            <span class="synComment"># Reorder if necessary...</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$reversed</span>) { (<span class="synIdentifier">$y</span>,<span class="synIdentifier">$x</span>) = (<span class="synIdentifier">$x</span>,<span class="synIdentifier">$y</span>); }

            <span class="synComment"># Unpack if objects...</span>
            <span class="synConditional">if</span> (<span class="synOperator">ref</span> <span class="synIdentifier">$x</span>) { <span class="synIdentifier">$x</span> = <span class="synStatement">eval</span>{ <span class="synIdentifier">$x-&gt;{</span><span class="synString">cooked</span><span class="synIdentifier">}</span> } // <span class="synIdentifier">$x</span> }
            <span class="synConditional">if</span> (<span class="synOperator">ref</span> <span class="synIdentifier">$y</span>) { <span class="synIdentifier">$y</span> = <span class="synStatement">eval</span>{ <span class="synIdentifier">$y-&gt;{</span><span class="synString">cooked</span><span class="synIdentifier">}</span> } // <span class="synIdentifier">$y</span> }

            <span class="synComment"># Undo overeager \Q if necessary...</span>
               <span class="synConditional">if</span> (<span class="synIdentifier">$x</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\\\(\\\?\\\#</span><span class="synString">R_d</span><span class="synSpecial">\\</span><span class="synString">:</span><span class="synSpecial">(\d+)\\\)</span><span class="synStatement">}</span>) { <span class="synIdentifier">$x</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">Q'</span> . <span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>     . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$x</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\(\?\#</span><span class="synString">R_D:</span><span class="synSpecial">(\d+)\)</span><span class="synStatement">}</span>)           { <span class="synIdentifier">$x</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">U'</span> . <span class="synStatement">uc</span>(<span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>) . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$x</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\(\?\#</span><span class="synString">r_d:</span><span class="synSpecial">(\d+)\)</span><span class="synStatement">}</span>)           { <span class="synIdentifier">$x</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">L'</span> . <span class="synStatement">lc</span>(<span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>) . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }
               <span class="synConditional">if</span> (<span class="synIdentifier">$y</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\\\(\\\?\\\#</span><span class="synString">R_d</span><span class="synSpecial">\\</span><span class="synString">:</span><span class="synSpecial">(\d+)\\\)</span><span class="synStatement">}</span>) { <span class="synIdentifier">$y</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">Q'</span> . <span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>     . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$y</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\(\?\#</span><span class="synString">R_D:</span><span class="synSpecial">(\d+)\)</span><span class="synStatement">}</span>)           { <span class="synIdentifier">$y</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">U'</span> . <span class="synStatement">uc</span>(<span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>) . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$y</span> =~ <span class="synStatement">m{</span><span class="synString">^</span><span class="synSpecial">\(\?\#</span><span class="synString">r_d:</span><span class="synSpecial">(\d+)\)</span><span class="synStatement">}</span>)           { <span class="synIdentifier">$y</span> = <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">L'</span> . <span class="synStatement">lc</span>(<span class="synIdentifier">$state{$1}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>) . <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">E'</span> }

            <span class="synComment"># Do the concatenation...</span>
            <span class="synIdentifier">$x</span> .= <span class="synIdentifier">$y</span>//<span class="synString">q{}</span>;

            <span class="synComment"># Rebless as a precursor object...</span>
            <span class="synStatement">return</span> <span class="synOperator">bless</span> {<span class="synString">cooked</span>=&gt;<span class="synIdentifier">$x</span>, <span class="synString">lexical_scope</span>=&gt;<span class="synIdentifier">$lexical_scope</span>}, <span class="synString">'Regexp::Debugger::Precursor'</span>;
        },

        <span class="synComment"># Using as a string (i.e. matching) preprocesses the precursor...</span>
        <span class="synString">q{&quot;&quot;}</span> =&gt; <span class="synKeyword">sub </span>{
            <span class="synStatement">my</span> (<span class="synIdentifier">$obj</span>) = <span class="synIdentifier">@_</span>;

            <span class="synStatement">use </span>Scalar::Util <span class="synString">qw&lt; refaddr &gt;</span>;
            <span class="synStatement">return</span> <span class="synIdentifier">$regex_cache{</span><span class="synperlVarMember"> refaddr(</span><span class="synIdentifier">$obj</span><span class="synperlVarMember">) </span><span class="synIdentifier">}</span>
                //= Regexp::Debugger::_build_debugging_regex( <span class="synIdentifier">@{$obj}{</span><span class="synString">'cooked'</span><span class="synperlVarMember">, </span><span class="synString">'lexical_scope'</span><span class="synIdentifier">}</span> );
        },

        <span class="synComment"># Everything else, as usual...</span>
        <span class="synString">fallback</span> =&gt; <span class="synNumber">1</span>,
    );
}


<span class="synComment">#=====[ Augment a regex with debugging statements ]================</span>


<span class="synComment"># Build code insertions for before and after elements in a regex...</span>
<span class="synComment"># (the final $^R ensure these extra code blocks are &quot;transparent&quot;)</span>


<span class="synKeyword">sub </span><span class="synFunction">_build_event </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$event_ID</span>, <span class="synIdentifier">$event_desc_ref</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$event_desc_ref-&gt;{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span>  //= <span class="synString">q{}</span>;
    <span class="synIdentifier">$state{$regex_ID}{$event_ID}</span> = <span class="synIdentifier">$event_desc_ref</span>;

    <span class="synStatement">return</span> <span class="synString">qq{(?{Regexp::Debugger::_report_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">, pos()); </span><span class="synSpecial">\$</span><span class="synString">^R })(?=)}</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_build_whitespace_event </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$construct</span>,<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$event_ID</span>, <span class="synIdentifier">$event_desc_ref</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$event_desc_ref-&gt;{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span>  //= <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">%event_desc_copy</span> = <span class="synIdentifier">%{$event_desc_ref}</span>;
    <span class="synIdentifier">$state{$regex_ID}{$event_ID}</span>   = { <span class="synIdentifier">%event_desc_copy</span>, <span class="synString">event_type</span> =&gt; <span class="synString">'pre'</span> };
    <span class="synIdentifier">$state{$regex_ID}{$event_ID</span><span class="synperlVarMember">+</span><span class="synNumber">1</span><span class="synIdentifier">}</span> = { <span class="synIdentifier">%event_desc_copy</span>, <span class="synString">event_type</span> =&gt; <span class="synString">'post'</span>, <span class="synString">msg</span> =&gt; <span class="synString">'Matched'</span> };

    <span class="synStatement">return</span> <span class="synString">qq{(?&gt;(?{local </span><span class="synSpecial">\$</span><span class="synString">Regexp::Debugger::prevpos=pos})</span><span class="synIdentifier">$construct</span><span class="synString">(?{</span>
<span class="synString">            if (defined </span><span class="synSpecial">\$</span><span class="synString">Regexp::Debugger::prevpos &amp;&amp; </span><span class="synSpecial">\$</span><span class="synString">Regexp::Debugger::prevpos &lt; pos){</span>
<span class="synString">                Regexp::Debugger::_report_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">, </span><span class="synSpecial">\$</span><span class="synString">Regexp::Debugger::prevpos);</span>
<span class="synString">                Regexp::Debugger::_report_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">+1, pos());</span>
<span class="synString">            }</span><span class="synSpecial">\$</span><span class="synString">^R })|(?{</span>
<span class="synString">                Regexp::Debugger::_report_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">, pos());</span>
<span class="synString">            </span><span class="synSpecial">\$</span><span class="synString">^R</span>
<span class="synString">            })(?!))}</span>;
}


<span class="synComment"># Translate lookaround markers...</span>
<span class="synStatement">my</span> <span class="synIdentifier">%LOOKTYPE</span> = (
    <span class="synString">'(?='</span>  =&gt; <span class="synString">'positive lookahead'</span>,
    <span class="synString">'(?!'</span>  =&gt; <span class="synString">'negative lookahead'</span>,
    <span class="synString">'(?&lt;='</span> =&gt; <span class="synString">'positive lookbehind'</span>,
    <span class="synString">'(?&lt;!'</span> =&gt; <span class="synString">'negative lookbehind'</span>,
);

<span class="synKeyword">sub </span><span class="synFunction">_build_debugging_regex </span>{
    <span class="synStatement">my</span> ( <span class="synIdentifier">$raw_regex</span>, <span class="synIdentifier">$lexical_scope</span> ) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$lexical_scope</span> //= <span class="synNumber">0</span>;

    <span class="synComment"># How does this regexp show whitespace???</span>
    <span class="synStatement">our</span> <span class="synIdentifier">$show_ws</span> = <span class="synIdentifier">$config[$lexical_scope]{</span><span class="synString">show_ws</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Build a clean, compacted version of the regex in this var...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$clean_regex</span> = <span class="synString">q{}</span>;

    <span class="synComment"># Track nested parentheticals so we can correctly mark each ')'...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@paren_stack</span> = ( {} );

    <span class="synComment"># Give this regex a unique ID...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_ID</span> = <span class="synIdentifier">$next_regex_ID</span>++;

    <span class="synComment"># Remember raw data in case of over-eager quotemeta'ing...</span>
    <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$raw_regex</span>;

    <span class="synComment"># Remember location of regex...</span>
    <span class="synStatement">my</span> (<span class="synIdentifier">$filename</span>, <span class="synIdentifier">$end_line</span>) = (<span class="synStatement">caller</span> <span class="synNumber">1</span>)[<span class="synNumber">1</span>,<span class="synNumber">2</span>];
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_lines</span> = <span class="synIdentifier">$raw_regex</span> =~ <span class="synStatement">tr/</span><span class="synString">\n</span><span class="synStatement">//</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$start_line</span> = <span class="synIdentifier">$end_line</span> - <span class="synIdentifier">$regex_lines</span>;
    <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span>
        = <span class="synIdentifier">$start_line</span> == <span class="synIdentifier">$end_line</span> ? <span class="synString">qq{'</span><span class="synIdentifier">$filename</span><span class="synString">' line </span><span class="synIdentifier">$start_line</span><span class="synString">}</span>
                                   : <span class="synString">qq{'</span><span class="synIdentifier">$filename</span><span class="synString">' lines </span><span class="synIdentifier">$start_line</span><span class="synString">-</span><span class="synIdentifier">$end_line</span><span class="synString">}</span>;

    <span class="synComment"># Track each inserted debugging statement...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$next_event_ID</span> = <span class="synNumber">0</span>;

    <span class="synComment"># Track capture groups...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$next_capture_group</span> = <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$max_capture_group</span>  = <span class="synNumber">0</span>;

    <span class="synComment"># Track named capture aliases...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@capture_names_for</span>;

    <span class="synComment"># Track \Q...\E</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$in_quote</span> = <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$shared_quote_pos</span>;

    <span class="synComment"># Describe construct...</span>
    <span class="synStatement">our</span> <span class="synIdentifier">$construct_desc</span>;
    <span class="synStatement">our</span> <span class="synIdentifier">$quantifier_desc</span>;

    <span class="synComment"># Translate each component...</span>
    <span class="synStatement">use re</span> <span class="synString">'eval'</span>;
    <span class="synIdentifier">$raw_regex</span> =~ <span class="synStatement">s{</span>
<span class="synString">        # Set-up</span><span class="synSpecial">...</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = q{}; </span><span class="synIdentifier">$construct_desc</span><span class="synString"> = q{}; }</span><span class="synSpecial">)</span>

<span class="synString">        # Match the next construct</span><span class="synSpecial">...</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;construct&gt;</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;start&gt;               </span><span class="synSpecial">\A</span><span class="synString">   </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;end&gt;                 </span><span class="synSpecial">\z</span><span class="synString">   </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;quote_start&gt;</span>
<span class="synString">                </span><span class="synSpecial">(??</span><span class="synString">{!</span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">in_quote</span><span class="synString"> ? q{} : q{(?!)} }</span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">\\</span><span class="synString">Q</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">in_quote</span><span class="synString"> = 1}</span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        | </span><span class="synSpecial">(??</span><span class="synString">{</span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">in_quote</span><span class="synString"> ? q{} : q{(?!)} }</span><span class="synSpecial">)</span>
<span class="synString">          </span><span class="synSpecial">(</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;quote_space&gt;    </span><span class="synSpecial">\s++</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">          |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;quote_end&gt;      </span><span class="synSpecial">\\</span><span class="synString">E  </span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">in_quote</span><span class="synString"> = 0}</span><span class="synSpecial">)</span>
<span class="synString">          |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;quote_nonspace&gt; </span><span class="synSpecial">\S</span><span class="synString">   </span><span class="synSpecial">)</span>
<span class="synString">          </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;case_start&gt;</span>
<span class="synString">                </span><span class="synSpecial">\\</span><span class="synString">U   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an auto-uppercased sequence'}</span><span class="synSpecial">)</span>
<span class="synString">            |   </span><span class="synSpecial">\\</span><span class="synString">L   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an auto-lowercased sequence'}</span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;case_end&gt;</span>
<span class="synString">                </span><span class="synSpecial">\\</span><span class="synString">E</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = '';}</span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;closing_paren&gt;       </span><span class="synSpecial">[)]</span><span class="synString">  </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;whitespace&gt;</span>
<span class="synString">                </span><span class="synSpecial">(?(?</span><span class="synString">{ </span><span class="synIdentifier">$show_ws</span><span class="synString"> eq 'compact' }</span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">&lt;whitespace_chars&gt;</span>
<span class="synString">                        </span><span class="synSpecial">(</span><span class="synString"> </span><span class="synSpecial">(?:</span><span class="synString"> </span><span class="synSpecial">\s</span><span class="synString"> | </span><span class="synSpecial">(?&amp;COMMENT)</span><span class="synString"> </span><span class="synSpecial">)+</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?!</span><span class="synString"> </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString"> </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = q{} }</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString">}</span><span class="synSpecial">)</span>
<span class="synString">                    |</span>
<span class="synString">                        </span><span class="synSpecial">(</span><span class="synString"> </span><span class="synSpecial">\s</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString">}</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">(?!)</span>
<span class="synString">                </span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?(?</span><span class="synString">{ </span><span class="synIdentifier">$show_ws</span><span class="synString"> eq 'visible' }</span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">&lt;whitespace_chars&gt;</span>
<span class="synString">                        </span><span class="synSpecial">(</span><span class="synString"> [^</span><span class="synSpecial">\S\n\t</span><span class="synString">]</span><span class="synSpecial">+</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?!</span><span class="synString"> </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString"> </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = q{} }</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString">}</span><span class="synSpecial">)</span>
<span class="synString">                    |</span>
<span class="synString">                        </span><span class="synSpecial">(</span><span class="synString"> [^</span><span class="synSpecial">\S\n\t</span><span class="synString">] </span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString">}</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">(?!)</span>
<span class="synString">                </span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?(?</span><span class="synString">{ </span><span class="synIdentifier">$show_ws</span><span class="synString"> eq 'original'}</span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">&lt;whitespace_chars&gt;</span>
<span class="synString">                        </span><span class="synSpecial">(</span><span class="synString"> [^</span><span class="synSpecial">\S\n\t</span><span class="synString">] </span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString">}</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">(?!)</span>
<span class="synString">                </span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;newline_char&gt;  </span><span class="synSpecial">\n</span><span class="synString">  </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a literal newline character'}</span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;tab_char&gt;      </span><span class="synSpecial">\t</span><span class="synString">  </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a literal tab character'}</span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;break_comment&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(][?][#]</span><span class="synString"> </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">(?</span><span class="synString">i: BREAK </span><span class="synSpecial">)</span><span class="synString"> </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">[)]</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;comment&gt;</span>
<span class="synString">                </span><span class="synSpecial">(?&amp;COMMENT)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;modifier_set&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">(?&amp;MODIFIERS)</span><span class="synString"> </span><span class="synSpecial">[)]</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;zero_width&gt;</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_anchor&gt;</span>
<span class="synString">                    </span><span class="synSpecial">\^</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at start of string (or line)'}</span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">\$</span>
<span class="synString">                        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at end of string (or final newline)'}</span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">\\</span><span class="synString">  </span><span class="synSpecial">(?:</span>
<span class="synString">                            A   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at start of string'}</span><span class="synSpecial">)</span>
<span class="synString">                        |</span>
<span class="synString">                            B   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'not at an identifier boundary'}</span><span class="synSpecial">)</span>
<span class="synString">                        |</span>
<span class="synString">                            b   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at an identifier boundary'}</span><span class="synSpecial">)</span>
<span class="synString">                        |</span>
<span class="synString">                            G   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at previous match position'}</span><span class="synSpecial">)</span>
<span class="synString">                        |</span>
<span class="synString">                            Z   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at end of string (or final newline)'}</span><span class="synSpecial">)</span>
<span class="synString">                        |</span>
<span class="synString">                            z   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'at end of string'}</span><span class="synSpecial">)</span>
<span class="synString">                        </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;matchable_code_block&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?][?]</span><span class="synString"> </span><span class="synSpecial">(?&amp;CODEBLOCK)</span><span class="synString"> </span><span class="synSpecial">[)]</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;code_block&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">(?&amp;CODEBLOCK)</span><span class="synString"> </span><span class="synSpecial">[)]</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            # Control verbs like </span><span class="synSpecial">(*PRUNE)</span><span class="synString"> and </span><span class="synSpecial">(*MARK:name)...</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;control&gt;</span>
<span class="synString">                </span><span class="synSpecial">\(\*</span><span class="synString"> [</span><span class="synSpecial">[:upper:]]*+</span><span class="synString"> </span><span class="synSpecial">(?:</span><span class="synString"> : </span><span class="synSpecial">[^)]++</span><span class="synString"> </span><span class="synSpecial">)?</span><span class="synString"> </span><span class="synSpecial">\)</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;noncapturing_paren&gt;     </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">(?&amp;MODIFIERS)?</span><span class="synString"> : </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;lookaround_paren&gt;       </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">[&lt;]?[=!]</span><span class="synString">         </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;non_backtracking_paren&gt; </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">[&gt;]</span><span class="synString">              </span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-backtracking group'}</span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;branch_reset_paren&gt;     </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">[|]</span><span class="synString">              </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;capturing_paren&gt;        </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">(?!</span><span class="synString"> </span><span class="synSpecial">[?])</span><span class="synString">             </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;define_block&gt;           </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">[(]</span><span class="synString"> DEFINE </span><span class="synSpecial">[)]</span><span class="synString">   </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;conditional_paren&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">[(]</span>
<span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">&lt;condition&gt;</span>
<span class="synString">                        </span><span class="synSpecial">\d+</span>
<span class="synString">                    |   R  </span><span class="synSpecial">\d*</span>
<span class="synString">                    |   R&amp; </span><span class="synSpecial">(?&amp;IDENTIFIER)</span>
<span class="synString">                    |   &lt; </span><span class="synSpecial">(?&amp;IDENTIFIER)</span><span class="synString"> &gt;</span>
<span class="synString">                    |   ' </span><span class="synSpecial">(?&amp;IDENTIFIER)</span><span class="synString"> '</span>
<span class="synString">                    |   </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">(?&amp;CODEBLOCK)</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">[)]</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;conditional_paren&gt; </span><span class="synSpecial">(?</span><span class="synString">&lt;pending_condition&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> </span><span class="synSpecial">(?=</span><span class="synString"> </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> &lt;</span><span class="synSpecial">?</span><span class="synString"> </span><span class="synSpecial">[=!]</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">            </span><span class="synSpecial">))</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;named_capturing_paren&gt;</span>
<span class="synString">                </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString"> P</span><span class="synSpecial">?</span><span class="synString"> &lt; </span><span class="synSpecial">(?</span><span class="synString">&lt;capture_name&gt; </span><span class="synSpecial">(?&amp;IDENTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString"> &gt;</span>
<span class="synString">              | </span><span class="synSpecial">[(]</span><span class="synString"> </span><span class="synSpecial">[?]</span><span class="synString">    ' </span><span class="synSpecial">(?</span><span class="synString">&lt;capture_name&gt; </span><span class="synSpecial">(?&amp;IDENTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString"> '</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;_alternation&gt;        </span><span class="synSpecial">[|]</span><span class="synString">  </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;keep_marker&gt;         </span><span class="synSpecial">\\</span><span class="synString">K  </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;atom&gt;</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_self_matching&gt;  </span><span class="synSpecial">\w</span><span class="synString">{2,}  </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">(?!</span><span class="synString"> </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = ''; </span><span class="synIdentifier">$construct_desc</span><span class="synString"> = qq{a literal sequence (&quot;</span><span class="synIdentifier">$+</span><span class="synString">{_self_matching}&quot;)}}</span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = '';}</span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_self_matching&gt;  </span><span class="synSpecial">(?&amp;NONMETA)</span><span class="synString">   </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = qq{a literal '</span><span class="synIdentifier">$+</span><span class="synString">{_self_matching}' character}}</span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = '';}</span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_metacharacter&gt;</span>
<span class="synString">                    </span><span class="synSpecial">[.]</span><span class="synString">                             </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'any character (except newline)'}</span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">\\</span>
<span class="synString">                    </span><span class="synSpecial">(?:</span><span class="synString"> </span><span class="synSpecial">(</span><span class="synString">0</span><span class="synSpecial">[0-7]++)</span><span class="synString">                  </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a literal '&quot;.chr(oct(</span><span class="synIdentifier">$^N</span><span class="synString">)).&quot;' character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | </span><span class="synSpecial">(\d++)</span><span class="synString">                      </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what was captured in </span><span class="synSpecial">\$</span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | a                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an alarm/bell character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | c </span><span class="synSpecial">([A-Z])</span><span class="synString">                   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a CTRL-</span><span class="synIdentifier">$^N</span><span class="synString"> character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | C                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a C-language octet'}</span><span class="synSpecial">)</span>
<span class="synString">                      | d                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a digit'}</span><span class="synSpecial">)</span>
<span class="synString">                      | D                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-digit'}</span><span class="synSpecial">)</span>
<span class="synString">                      | e                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an escape character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | f                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a form-feed character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | g      </span><span class="synSpecial">(\d+)</span><span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what was captured in </span><span class="synSpecial">\$</span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | g    - </span><span class="synSpecial">(\d+)</span><span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString"> == 1 ? &quot;what was captured by the nearest preceding capture group&quot;</span>
<span class="synString">                                                                                  : &quot;what was captured </span><span class="synIdentifier">$^N</span><span class="synString"> capture groups back&quot; }</span><span class="synSpecial">)</span>
<span class="synString">                      | g </span><span class="synSpecial">\{</span><span class="synString">   </span><span class="synSpecial">(\d+)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">             </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what was captured in </span><span class="synSpecial">\$</span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | g </span><span class="synSpecial">\{</span><span class="synString"> - </span><span class="synSpecial">(\d+)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">             </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString"> == 1 ? &quot;what was captured by the nearest preceding capture group&quot;</span>
<span class="synString">                                                                                  : &quot;what was captured </span><span class="synIdentifier">$^N</span><span class="synString"> capture groups back&quot; }</span><span class="synSpecial">)</span>
<span class="synString">                      | g </span><span class="synSpecial">\{</span><span class="synString"> </span><span class="synSpecial">(\w++)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">              </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what the named capture &lt;</span><span class="synIdentifier">$^N</span><span class="synString">&gt; matched&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | h                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a horizontal whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | H                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-horizontal-whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | k </span><span class="synSpecial">\&lt;</span><span class="synString"> </span><span class="synSpecial">(\w++)</span><span class="synString"> </span><span class="synSpecial">\&gt;</span><span class="synString">              </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what the named capture &lt;</span><span class="synIdentifier">$^N</span><span class="synString">&gt; matched&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | n                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a newline character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | N </span><span class="synSpecial">\{</span><span class="synString"> </span><span class="synSpecial">(</span><span class="synString">[^</span><span class="synSpecial">\}</span><span class="synString">]</span><span class="synSpecial">++)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a single </span><span class="synSpecial">\L</span><span class="synIdentifier">$^N</span><span class="synSpecial">\E</span><span class="synString"> character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | N                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-newline character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | p </span><span class="synSpecial">(\w++)</span><span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a character matching the Unicode property: </span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | P </span><span class="synSpecial">(\w++)</span><span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a character not matching the Unicode property: </span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | P </span><span class="synSpecial">\{</span><span class="synString"> </span><span class="synSpecial">(</span><span class="synString">[^</span><span class="synSpecial">\}</span><span class="synString">]</span><span class="synSpecial">++)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a character not matching the Unicode property: </span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | p </span><span class="synSpecial">\{</span><span class="synString"> </span><span class="synSpecial">(</span><span class="synString">[^</span><span class="synSpecial">\}</span><span class="synString">]</span><span class="synSpecial">++)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a character matching the Unicode property: </span><span class="synIdentifier">$^N</span><span class="synString">&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | r                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a return character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | R                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an end-of-line sequence'}</span><span class="synSpecial">)</span>
<span class="synString">                      | S                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | s                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | t                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a tab character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | V                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a non-vertical-whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | v                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a vertical whitespace character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | w                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an identifier character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | W                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'an non-identifier character'}</span><span class="synSpecial">)</span>
<span class="synString">                      | x    </span><span class="synSpecial">([0-9A-Za-z]++)</span><span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a literal '&quot;.chr(oct('0x'.</span><span class="synIdentifier">$^N</span><span class="synString">)).&quot;' character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | x </span><span class="synSpecial">\{</span><span class="synString"> </span><span class="synSpecial">([0-9A-Za-z ]++)</span><span class="synString"> </span><span class="synSpecial">\}</span><span class="synString">    </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a literal '&quot;.chr(oct('0x'.</span><span class="synIdentifier">$^N</span><span class="synString">)).&quot;' character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                      | X                           </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a Unicode grapheme cluster'}</span><span class="synSpecial">)</span>
<span class="synString">                      | </span><span class="synSpecial">(.)</span><span class="synString">                         </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a literal '</span><span class="synIdentifier">$^N</span><span class="synString">' character&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                |</span>
<span class="synString">                    </span><span class="synSpecial">[(][?]</span><span class="synString"> P = </span><span class="synSpecial">(\w++)</span><span class="synString"> </span><span class="synSpecial">[)]</span><span class="synString">    # PCRE version of </span><span class="synSpecial">\k&lt;NAME&gt;</span>
<span class="synString">                    </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;what the named capture &lt;</span><span class="synIdentifier">$^N</span><span class="synString">&gt; matched&quot;}</span><span class="synSpecial">)</span>

<span class="synString">                </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = '';}</span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_charset&gt;  </span><span class="synSpecial">(?&amp;CHARSET)</span><span class="synString">  </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = substr(</span><span class="synIdentifier">$+</span><span class="synString">{_charset},0,2) eq '[^'</span>
<span class="synString">                                        ? 'any character not listed'</span>
<span class="synString">                                        : 'any of the listed characters'</span>
<span class="synString">                }</span><span class="synSpecial">)</span>
<span class="synString">            |</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = '';}</span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;_named_subpattern_call&gt;</span>
<span class="synString">                    </span><span class="synSpecial">[(][?]</span>
<span class="synString">                    </span><span class="synSpecial">(?:</span>
<span class="synString">                        </span><span class="synSpecial">[&amp;]</span><span class="synString"> </span><span class="synSpecial">((?&amp;IDENTIFIER))</span><span class="synString">   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a call to the subpattern named &lt;</span><span class="synIdentifier">$^N</span><span class="synString">&gt;&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                    |   P&gt;  </span><span class="synSpecial">((?&amp;IDENTIFIER))</span><span class="synString">   </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = &quot;a call to the subpattern named &lt;</span><span class="synIdentifier">$^N</span><span class="synString">&gt;&quot;}</span><span class="synSpecial">)</span>
<span class="synString">                    |   </span><span class="synSpecial">[+]?</span><span class="synString"> </span><span class="synSpecial">(\d++)</span><span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a call to subpattern number </span><span class="synIdentifier">$^N</span><span class="synString">'}</span><span class="synSpecial">)</span>
<span class="synString">                    |   </span><span class="synSpecial">[-]</span><span class="synString">  </span><span class="synSpecial">(\d++)</span><span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = </span><span class="synIdentifier">$^N</span><span class="synString"> == 1 ? &quot;a call to the nearest preceding subpattern&quot;</span>
<span class="synString">                                                                             : &quot;a call to the subpattern </span><span class="synIdentifier">$^N</span><span class="synString"> back&quot; }</span><span class="synSpecial">)</span>
<span class="synString">                    |   R                      </span><span class="synSpecial">(?</span><span class="synString">{</span><span class="synIdentifier">$construct_desc</span><span class="synString"> = 'a recursive call to the current regex'}</span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">)</span>
<span class="synString">                    </span><span class="synSpecial">[)]</span>
<span class="synString">                </span><span class="synSpecial">)</span>
<span class="synString">                </span><span class="synSpecial">(?</span><span class="synString">&lt;quantifier&gt; </span><span class="synSpecial">(?&amp;QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">            </span><span class="synSpecial">)</span>
<span class="synString">        |</span>
<span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">&lt;misc&gt;        </span><span class="synSpecial">.</span><span class="synString">    </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">)</span>

<span class="synString">    </span><span class="synSpecial">(?(</span><span class="synString">DEFINE</span><span class="synSpecial">)</span>
<span class="synString">        # Miscellaneous useful pattern fragments</span><span class="synSpecial">...</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;COMMENT&gt;    </span><span class="synSpecial">[(][?][#]</span><span class="synString"> </span><span class="synSpecial">(?!</span><span class="synString"> </span><span class="synSpecial">\s*</span><span class="synString"> BREAK </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString"> </span><span class="synSpecial">.*?</span><span class="synString"> </span><span class="synSpecial">[)]</span><span class="synString"> | </span><span class="synSpecial">\#</span><span class="synString"> [^</span><span class="synSpecial">\n</span><span class="synString">]</span><span class="synSpecial">*</span><span class="synString"> </span><span class="synSpecial">(?=</span><span class="synString"> </span><span class="synSpecial">\n</span><span class="synString"> | </span><span class="synSpecial">\z</span><span class="synString"> </span><span class="synSpecial">)</span><span class="synString">  </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;CHARSET&gt;    </span><span class="synSpecial">\[</span><span class="synString"> </span><span class="synSpecial">\^?+</span><span class="synString"> </span><span class="synSpecial">\\?+</span><span class="synString"> </span><span class="synSpecial">\]?+</span><span class="synString"> </span><span class="synSpecial">(?:</span><span class="synString"> </span><span class="synSpecial">\[</span><span class="synString">:</span><span class="synSpecial">\w+</span><span class="synString">:</span><span class="synSpecial">\]</span><span class="synString"> | </span><span class="synSpecial">\\</span><span class="synString">[</span><span class="synSpecial">\[\]\\</span><span class="synString">] | </span><span class="synSpecial">[^]]</span><span class="synString"> </span><span class="synSpecial">)*+</span><span class="synString"> </span><span class="synSpecial">\]</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;IDENTIFIER&gt; [^</span><span class="synSpecial">\W\d</span><span class="synString">]</span><span class="synSpecial">\w*</span><span class="synString">                                   </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;CODEBLOCK&gt;  </span><span class="synSpecial">\{</span><span class="synString">  </span><span class="synSpecial">(?:</span><span class="synString"> </span><span class="synSpecial">(?&amp;CODEBLOCK)</span><span class="synString"> | </span><span class="synSpecial">.</span><span class="synString"> </span><span class="synSpecial">)*?</span><span class="synString">   </span><span class="synSpecial">\}</span><span class="synString">           </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;MODIFIERS&gt;  </span><span class="synSpecial">[adlupimsx]+</span><span class="synString"> </span><span class="synSpecial">(?:</span><span class="synString"> - </span><span class="synSpecial">[imsx]+</span><span class="synString"> </span><span class="synSpecial">)?</span>
<span class="synString">                    |  - </span><span class="synSpecial">[imsx]+</span>
<span class="synString">                    |  </span><span class="synSpecial">\^</span><span class="synString"> </span><span class="synSpecial">[alupimsx]</span>
<span class="synString">        </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;QUANTIFIER&gt; </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">(?&amp;UNSPACED_QUANTIFIER)</span><span class="synString"> </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;UNSPACED_QUANTIFIER&gt;</span>
<span class="synString">              </span><span class="synSpecial">[*][+]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'zero-or-more times (without backtracking)'          }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[*][?]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'zero-or-more times (as few as possible)'            }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[*]</span><span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'zero-or-more times (as many as possible)'           }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[+][+]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'one-or-more times (without backtracking)'           }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[+][?]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'one-or-more times (as few as possible)'             }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[+]</span><span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'one-or-more times (as many as possible)'            }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[?][+]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'one-or-zero times (without backtracking)'           }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[?][?]</span><span class="synString">         </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'zero-or-one times (as few as possible)'             }</span><span class="synSpecial">)</span>
<span class="synString">            | </span><span class="synSpecial">[?]</span><span class="synString">            </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'one-or-zero times (as many as possible)'            }</span><span class="synSpecial">)</span>
<span class="synString">            | {</span><span class="synSpecial">\d</span><span class="synString">+,?</span><span class="synSpecial">\d</span><span class="synString">*}</span><span class="synSpecial">[+]</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'the specified number of times (without backtracking)' }</span><span class="synSpecial">)</span>
<span class="synString">            | {</span><span class="synSpecial">\d</span><span class="synString">+,?</span><span class="synSpecial">\d</span><span class="synString">*}</span><span class="synSpecial">[?]</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'the specified number of times (as few as possible)'   }</span><span class="synSpecial">)</span>
<span class="synString">            | {</span><span class="synSpecial">\d</span><span class="synString">+,?</span><span class="synSpecial">\d</span><span class="synString">*}     </span><span class="synSpecial">(?</span><span class="synString">{ </span><span class="synIdentifier">$quantifier_desc</span><span class="synString"> = 'the specified number of times (as many as possible)'  }</span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">)</span>
<span class="synString">        </span><span class="synSpecial">(?</span><span class="synString">&lt;NONMETA&gt;  [</span><span class="synSpecial">\w</span><span class="synString">~`!%&amp;=:;&quot;'&lt;&gt;,/-] </span><span class="synSpecial">)</span>
<span class="synString">    </span><span class="synSpecial">)</span>
<span class="synString">    </span><span class="synStatement">}{</span>
<span class="synString">        # Which event is this???</span>
<span class="synString">        my </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">        # What are we debugging???</span>
<span class="synString">        my </span><span class="synIdentifier">$construct</span><span class="synString"> = </span><span class="synIdentifier">$+</span><span class="synString">{construct};</span>

<span class="synString">        # How deep in parens???</span>
<span class="synString">        my </span><span class="synIdentifier">$depth</span><span class="synString">  = scalar(</span><span class="synIdentifier">@paren_stack</span><span class="synString">);</span>
<span class="synString">        my </span><span class="synIdentifier">$indent</span><span class="synString"> = </span><span class="synIdentifier">$INDENT</span><span class="synString"> x </span><span class="synIdentifier">$depth</span><span class="synString">;</span>

<span class="synString">        # All events get this standard information...</span>
<span class="synString">        my %std_info = (</span>
<span class="synString">            construct_type =&gt; (first { /^_/ } keys %+),</span>
<span class="synString">            construct      =&gt; </span><span class="synIdentifier">$construct</span><span class="synString">,</span>
<span class="synString">            regex_pos      =&gt; length(</span><span class="synIdentifier">$clean_regex</span><span class="synString">),</span>
<span class="synString">            quantifier     =&gt; </span><span class="synIdentifier">$+</span><span class="synString">{quantifier} // q{},</span>
<span class="synString">            depth          =&gt; </span><span class="synIdentifier">$depth</span><span class="synString">,</span>
<span class="synString">            indent         =&gt; </span><span class="synIdentifier">$indent</span><span class="synString">,</span>
<span class="synString">        );</span>

<span class="synString">#        use Data::Dumper 'Dumper';</span>
<span class="synString">#        warn Dumper { std_info =&gt; </span><span class="synSpecial">\%</span><span class="synString">std_info, '%+' =&gt; </span><span class="synSpecial">\%</span><span class="synString">+ };</span>

<span class="synString">        # Record the construct for display...</span>
<span class="synString">        </span><span class="synIdentifier">$clean_regex</span><span class="synString"> .=</span>
<span class="synString">               exists </span><span class="synIdentifier">$+</span><span class="synString">{newline_char}      ?  (</span><span class="synIdentifier">$std_info{</span><span class="synString">construct</span><span class="synIdentifier">}</span><span class="synString"> = q{</span><span class="synSpecial">\n</span><span class="synString">} . </span><span class="synIdentifier">$std_info{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span><span class="synString">)</span>
<span class="synString">             : exists </span><span class="synIdentifier">$+</span><span class="synString">{tab_char}          ?  (</span><span class="synIdentifier">$std_info{</span><span class="synString">construct</span><span class="synIdentifier">}</span><span class="synString"> = q{</span><span class="synSpecial">\t</span><span class="synString">} . </span><span class="synIdentifier">$std_info{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span><span class="synString">)</span>
<span class="synString">             : exists </span><span class="synIdentifier">$+</span><span class="synString">{whitespace_chars}  ?  (</span><span class="synIdentifier">$std_info{</span><span class="synString">construct</span><span class="synIdentifier">}</span><span class="synString"> = q{ } . </span><span class="synIdentifier">$std_info{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span><span class="synString">)</span>
<span class="synString">             :                                 </span><span class="synIdentifier">$construct</span>
<span class="synString">             ;</span>

<span class="synString">        # Determine and remember the necessary translation...</span>
<span class="synString">        my </span><span class="synIdentifier">$translation</span><span class="synString"> = do {</span>

<span class="synString">            # Beginning and end of regex...</span>
<span class="synString">            if (exists </span><span class="synIdentifier">$+</span><span class="synString">{start}) {</span>
<span class="synString">                # Prime paren-tracking stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {};</span>

<span class="synString">                # Insert an event to report (re-)starting...</span>
<span class="synString">                _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    construct_type =&gt; '_START',</span>
<span class="synString">                    event_type     =&gt; 'pre',</span>
<span class="synString">                    depth          =&gt; 1,</span>
<span class="synString">                    lexical_scope  =&gt; </span><span class="synIdentifier">$lexical_scope</span><span class="synString">,</span>
<span class="synString">                })</span>
<span class="synString">                . '(?:';</span>
<span class="synString">            }</span>

<span class="synString">            # At end of regex (if we get here, we matched)...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{end}) {</span>
<span class="synString">                # Insert a final event to report successful match...</span>
<span class="synString">                ')'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    construct_type =&gt; '_END',</span>
<span class="synString">                    event_type     =&gt; 'post',</span>
<span class="synString">                    depth          =&gt; 1,</span>
<span class="synString">                    msg            =&gt; sub { my </span><span class="synIdentifier">$steps</span><span class="synString"> = </span><span class="synIdentifier">@{$history_of{</span><span class="synString">visual</span><span class="synIdentifier">}}</span><span class="synString">;</span>
<span class="synString">                                            &quot;Regex matched in </span><span class="synIdentifier">$steps</span><span class="synString"> step&quot; . (</span><span class="synIdentifier">$steps</span><span class="synString"> != 1 ? 's' : '');</span>
<span class="synString">                                      },</span>
<span class="synString">                })</span>
<span class="synString">                . '|'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">+1 =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    construct_type =&gt; '_END',</span>
<span class="synString">                    event_type     =&gt; 'post',</span>
<span class="synString">                    regex_failed   =&gt; 1,</span>
<span class="synString">                    depth          =&gt; 1,</span>
<span class="synString">                    msg            =&gt; sub { my </span><span class="synIdentifier">$steps</span><span class="synString"> = </span><span class="synIdentifier">@{$history_of{</span><span class="synString">visual</span><span class="synIdentifier">}}</span><span class="synString">;</span>
<span class="synString">                                            &quot;Regex failed to match after </span><span class="synIdentifier">$steps</span><span class="synString"> step&quot; . (</span><span class="synIdentifier">$steps</span><span class="synString"> != 1 ? 's' : '');</span>
<span class="synString">                                      },</span>
<span class="synString">                })</span>
<span class="synString">                . '(?!)';</span>
<span class="synString">            }</span>

<span class="synString">            # Alternatives marked by a |...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{_alternation}) {</span>
<span class="synString">                # Reset capture numbers if in reset group...</span>
<span class="synString">                if (my </span><span class="synIdentifier">$reset</span><span class="synString"> = </span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">is_branch_reset</span><span class="synIdentifier">}</span><span class="synString">) {</span>
<span class="synString">                    </span><span class="synIdentifier">$next_capture_group</span><span class="synString"> = </span><span class="synIdentifier">$reset</span><span class="synString">-1;</span>
<span class="synString">                }</span>

<span class="synString">                # We need two events, so add an extra one...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                # Insert events to indicate which side of the | we're trying now...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type =&gt; 'end',</span>
<span class="synString">                        msg        =&gt; 'End of successful alternative',</span>
<span class="synString">                        desc       =&gt; 'Or...',</span>
<span class="synString">                        indent     =&gt; </span><span class="synIdentifier">$INDENT</span><span class="synString"> x (</span><span class="synIdentifier">$depth</span><span class="synString">-1),</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type =&gt; 'start',</span>
<span class="synString">                        msg        =&gt; 'Trying next alternative',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Whitespace has to be treated specially (because it may or may not be significant...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{whitespace}) {</span>
<span class="synString">                # The two events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Two events required, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                </span><span class="synIdentifier">$construct_desc</span><span class="synString"> = join q{}, map { </span><span class="synIdentifier">$_</span><span class="synString"> eq &quot;</span><span class="synSpecial">\n</span><span class="synString">&quot; ? '</span><span class="synSpecial">\n</span><span class="synString">'</span>
<span class="synString">                                                : </span><span class="synIdentifier">$_</span><span class="synString"> eq &quot;</span><span class="synSpecial">\t</span><span class="synString">&quot; ? '</span><span class="synSpecial">\t</span><span class="synString">'</span>
<span class="synString">                                                : </span><span class="synIdentifier">$_</span><span class="synString"> eq &quot; &quot;  ? '</span><span class="synSpecial">\N</span><span class="synString">{SPACE}'</span>
<span class="synString">                                                :               </span><span class="synIdentifier">$_</span>
<span class="synString">                                                } split '', </span><span class="synIdentifier">$construct_desc</span><span class="synString">;</span>

<span class="synString">                # Insert the appropriate events...</span>
<span class="synString">                _build_whitespace_event(</span><span class="synIdentifier">$construct</span><span class="synString">, </span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        msg            =&gt; &quot;Trying literal whitespace ('</span><span class="synIdentifier">$construct_desc</span><span class="synString">') </span><span class="synIdentifier">$quantifier_desc</span><span class="synString">&quot;,</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                })</span>
<span class="synString">            }</span>

<span class="synString">            # </span><span class="synSpecial">\L</span><span class="synString"> and </span><span class="synSpecial">\U</span><span class="synString"> start case-shifted sequences...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{case_start}) {</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; &quot;Starting </span><span class="synIdentifier">$construct_desc</span><span class="synString">&quot;,</span>
<span class="synString">                        desc       =&gt; 'The start of ' . </span><span class="synIdentifier">$construct_desc</span><span class="synString">,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{case_end}) {</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; 'End of autocasing',</span>
<span class="synString">                        desc       =&gt; 'The end of autocasing',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # </span><span class="synSpecial">\Q</span><span class="synString"> starts a quoted sequence...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{quote_start}) {</span>
<span class="synString">                # Set up communication channel between </span><span class="synSpecial">\Q</span><span class="synString"> and </span><span class="synSpecial">\E</span><span class="synString">...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_pos</span><span class="synString">;</span>
<span class="synString">                </span><span class="synIdentifier">$shared_quote_pos</span><span class="synString"> = </span><span class="synSpecial">\$</span><span class="synString">shared_pos;</span>

<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type     =&gt; 'pre',</span>
<span class="synString">                        msg            =&gt; 'Starting quoted sequence',</span>
<span class="synString">                        desc           =&gt; 'The start of a quoted sequence',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synIdentifier">$shared_quote_pos</span><span class="synString">,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # </span><span class="synSpecial">\E</span><span class="synString"> ends a quoted sequence...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{quote_end}) {</span>
<span class="synString">                # Retrieve communication channel between </span><span class="synSpecial">\Q</span><span class="synString"> and </span><span class="synSpecial">\E</span><span class="synString">...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_pos</span><span class="synString"> = </span><span class="synIdentifier">$shared_quote_pos</span><span class="synString">;</span>
<span class="synString">                </span><span class="synIdentifier">$shared_quote_pos</span><span class="synString"> = undef;</span>

<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        event_type     =&gt; 'post',</span>
<span class="synString">                        msg            =&gt; 'End of quoted sequence',</span>
<span class="synString">                        desc           =&gt; 'The end of a quoted sequence',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synIdentifier">$shared_pos</span><span class="synString">,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>


<span class="synString">            # Quoted subsequences...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{quote_space}) {</span>
<span class="synString">                # The two events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'pre',</span>
<span class="synString">                        msg            =&gt; 'Trying autoquoted literal whitespace',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">                . quotemeta(</span><span class="synIdentifier">$construct</span><span class="synString">)</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'post',</span>
<span class="synString">                        msg            =&gt; 'Matched autoquoted literal whitespace',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{quote_nonspace}) {</span>
<span class="synString">                # The two events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'pre',</span>
<span class="synString">                        msg            =&gt; 'Trying an autoquoted literal character',</span>
<span class="synString">                        desc           =&gt; 'Match an autoquoted literal character',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">                . quotemeta(</span><span class="synIdentifier">$construct</span><span class="synString">)</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'post',</span>
<span class="synString">                        msg            =&gt; 'Matched a literal character',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Atoms are any elements that match and emit debugging info before and after matching...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{atom}) {</span>
<span class="synString">                # The two events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Track depth of subpattern calls...</span>
<span class="synString">                my </span><span class="synIdentifier">$is_subpattern_call</span><span class="synString"> = exists </span><span class="synIdentifier">$+</span><span class="synString">{_named_subpattern_call};</span>
<span class="synString">                my </span><span class="synIdentifier">$subpattern_call_prefix</span>
<span class="synString">                    = </span><span class="synIdentifier">$is_subpattern_call</span>
<span class="synString">                        ? q{(?{local </span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">subpattern_depth</span><span class="synString"> = </span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">subpattern_depth</span><span class="synString"> + 1})}</span>
<span class="synString">                        : q{};</span>
<span class="synString">                my </span><span class="synIdentifier">$subpattern_call_suffix</span>
<span class="synString">                    = </span><span class="synIdentifier">$is_subpattern_call</span>
<span class="synString">                        ? q{(?{local </span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">subpattern_depth</span><span class="synString"> = </span><span class="synIdentifier">$</span><span class="synType">Regexp::Debugger::</span><span class="synIdentifier">subpattern_depth</span><span class="synString"> - 1})}</span>
<span class="synString">                        : q{};</span>

<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'pre',</span>
<span class="synString">                        msg            =&gt; &quot;Trying </span><span class="synIdentifier">$construct_desc</span><span class="synString">&quot; . (length(</span><span class="synIdentifier">$quantifier_desc</span><span class="synString">) ? &quot;, </span><span class="synIdentifier">$quantifier_desc</span><span class="synString">&quot; : q{}),</span>
<span class="synString">                        desc           =&gt; &quot;Match </span><span class="synIdentifier">$construct_desc</span><span class="synString">&quot; . (length(</span><span class="synIdentifier">$quantifier_desc</span><span class="synString">) ? &quot;, </span><span class="synIdentifier">$quantifier_desc</span><span class="synString">&quot; : q{}),</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$subpattern_call_prefix</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . </span><span class="synIdentifier">$subpattern_call_suffix</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'post',</span>
<span class="synString">                        msg            =&gt; 'Matched'</span>
<span class="synString">                                        . (</span><span class="synIdentifier">$is_subpattern_call</span><span class="synString"> ? &quot; (discarding subpattern's captures)&quot;: q{}),</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Code blocks (?{...})...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{code_block}) {</span>
<span class="synString">                # Add an event beforehand to indicate execution of the block...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'action',</span>
<span class="synString">                        msg        =&gt; 'Executing code block',</span>
<span class="synString">                        desc       =&gt; 'Execute a block of code',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">            }</span>

<span class="synString">            # Code blocks that generate dynamic patterns (??{...})...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{matchable_code_block}) {</span>
<span class="synString">                # These events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Modify construct to generate but not match...</span>
<span class="synString">                substr(</span><span class="synIdentifier">$construct</span><span class="synString">, 1, 1) = q{};</span>

<span class="synString">                # Inserting three events, so add an extra two IDs...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = (</span><span class="synIdentifier">$next_event_ID</span><span class="synString">+=3);</span>
<span class="synString">                  # First event pair reports executing the block...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-4 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'action',</span>
<span class="synString">                        msg        =&gt; 'Executing code block of postponed subpattern',</span>
<span class="synString">                        desc       =&gt; &quot;Execute a code block, then match the block's final value&quot;,</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-3 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'action',</span>
<span class="synString">                        msg        =&gt; sub { &quot;Code block returned: '</span><span class="synIdentifier">$^R</span><span class="synString">'&quot; },</span>
<span class="synString">                  })</span>
<span class="synString">                  # Second event pair reports match of subpattern the block returned...</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-2 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'pre',</span>
<span class="synString">                        msg            =&gt; sub{ &quot;Trying: qr{</span><span class="synIdentifier">$^R</span><span class="synString">}&quot; },</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">                . '(??{ </span><span class="synIdentifier">$^R</span><span class="synString"> })'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable      =&gt; 1,</span>
<span class="synString">                        event_type     =&gt; 'post',</span>
<span class="synString">                        msg            =&gt; 'Matched',</span>
<span class="synString">                        shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Keep marker...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{keep_marker}) {</span>
<span class="synString">                # Insert events reporting testing the assertion, and if the test succeeds...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'action',</span>
<span class="synString">                        msg        =&gt; &quot;Forgetting everything matched to this point&quot;,</span>
<span class="synString">                        desc       =&gt; 'Pretend the final match starts here',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . '(?{ local </span><span class="synIdentifier">$</span><span class="synType">Regexp::Grammars::</span><span class="synIdentifier">match_start_pos</span><span class="synString"> = pos() })'</span>
<span class="synString">            }</span>

<span class="synString">            # Zero-width assertions...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{zero_width}) {</span>
<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                # Insert events reporting testing the assertion, and if the test succeeds...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 1,</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; &quot;Testing if </span><span class="synIdentifier">$construct_desc</span><span class="synString">&quot;,</span>
<span class="synString">                        desc       =&gt; &quot;Match only if </span><span class="synIdentifier">$construct_desc</span><span class="synString">&quot;,</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 1,</span>
<span class="synString">                        event_type =&gt; 'post',</span>
<span class="synString">                        msg        =&gt; 'Assertion satisfied',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Control verbs: (*PRUNE) (*SKIP) (*FAIL) etc...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{control}) {</span>
<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                # Insert events to report both the attempt and its success...</span>
<span class="synString">                  _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 1,</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; 'Executing a control',</span>
<span class="synString">                        desc       =&gt; 'Execute a backtracking control',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        matchable  =&gt; 1,</span>
<span class="synString">                        event_type =&gt; 'post',</span>
<span class="synString">                        msg        =&gt; 'Control succeeded',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Start of DEFINE block...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{define_block}) {</span>
<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture     =&gt; 0,</span>
<span class="synString">                    construct_type =&gt; '_DEFINE_block',</span>
<span class="synString">                    is_definition  =&gt; 1,</span>
<span class="synString">                };</span>

<span class="synString">                # Insert and event to report skipping the entire block...</span>
<span class="synString">                _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; 'Skipping definitions',</span>
<span class="synString">                        desc       =&gt; 'The start of a definition block (skipped during matching)',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span><span class="synString"> . '(?:'</span>
<span class="synString">            }</span>

<span class="synString">            # Modifier set: (?is-mx) etc...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{modifier_set}) {</span>
<span class="synString">                # Insert an event to report the change of active modifiers...</span>
<span class="synString">                _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'compile',</span>
<span class="synString">                        msg        =&gt; 'Changing modifiers',</span>
<span class="synString">                        desc       =&gt; 'Change current modifiers',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span>
<span class="synString">            }</span>

<span class="synString">            # Conditional parens: (?(COND) X | Y )...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{conditional_paren}) {</span>
<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture      =&gt; 0,</span>
<span class="synString">                    is_conditional  =&gt; 1,</span>
<span class="synString">                    is_pending      =&gt; exists </span><span class="synIdentifier">$+</span><span class="synString">{pending_condition}, # ...expecting a lookahead?</span>
<span class="synString">                    construct_type  =&gt; '_conditional_group',</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the test...</span>
<span class="synString">                  '(?:'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; 'Testing condition',</span>
<span class="synString">                    desc       =&gt; 'The start of a conditional block',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span><span class="synString">;</span>
<span class="synString">            }</span>

<span class="synString">            # Branch-reset parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{branch_reset_paren}) {</span>
<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture      =&gt; 0,</span>
<span class="synString">                    is_branch_reset =&gt; </span><span class="synIdentifier">$next_capture_group</span><span class="synString">+1,</span>
<span class="synString">                    construct_type  =&gt; '_branch_reset_group',</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the start of branch-reseting...</span>
<span class="synString">                  '(?:'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; 'Starting branch-resetting group',</span>
<span class="synString">                    desc       =&gt; 'The start of a branch-resetting group',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span><span class="synString">;</span>
<span class="synString">            }</span>

<span class="synString">            # Non-capturing parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{noncapturing_paren}) {</span>
<span class="synString">                # Do the non-capturing parens have embedded modifiers???</span>
<span class="synString">                my </span><span class="synIdentifier">$addendum</span><span class="synString"> = length(</span><span class="synIdentifier">$construct</span><span class="synString">) &gt; 3 ? ', changing modifiers' : q{};</span>

<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture     =&gt; 0,</span>
<span class="synString">                    construct_type =&gt; '_noncapture_group',</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the start of a non-capturing group...</span>
<span class="synString">                  '(?:'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; 'Starting non-capturing group' . </span><span class="synIdentifier">$addendum</span><span class="synString">,</span>
<span class="synString">                    desc       =&gt; 'The start of a non-capturing group',</span>
<span class="synString">                  })</span>
<span class="synString">                . </span><span class="synIdentifier">$construct</span><span class="synString">;</span>
<span class="synString">            }</span>

<span class="synString">            # Non-backtracking parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{non_backtracking_paren}) {</span>
<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture      =&gt; 0,</span>
<span class="synString">                    is_nonbacktrack =&gt; 1,</span>
<span class="synString">                    construct_type  =&gt; '_nonbacktracking_group',</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the start of a non-backtracking group...</span>
<span class="synString">                  '(?:'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; 'Starting non-backtracking group',</span>
<span class="synString">                    desc       =&gt; 'The start of a non-backtracking group',</span>
<span class="synString">                  })</span>
<span class="synString">                . '(?&gt;';</span>
<span class="synString">            }</span>

<span class="synString">            # Positive lookahead/lookbehind parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{lookaround_paren}) {</span>
<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture     =&gt; 0,</span>
<span class="synString">                    is_lookaround  =&gt; </span><span class="synIdentifier">$LOOKTYPE{$construct}</span><span class="synString">,</span>
<span class="synString">                    construct_type =&gt; '_lookaround',</span>
<span class="synString">                };</span>

<span class="synString">                # Is this lookaround the test of a (?(COND) X | Y) conditional???</span>
<span class="synString">                if (</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">2</span><span class="synIdentifier">]{</span><span class="synString">is_conditional</span><span class="synIdentifier">}</span><span class="synString"> &amp;&amp; </span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">2</span><span class="synIdentifier">]{</span><span class="synString">is_pending</span><span class="synIdentifier">}</span><span class="synString">) {</span>
<span class="synString">                    # If so, the test is no longer pending...</span>
<span class="synString">                    delete </span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">2</span><span class="synIdentifier">]{</span><span class="synString">is_pending</span><span class="synIdentifier">}</span><span class="synString">;</span>

<span class="synString">                    # Insert an event to report the test...</span>
<span class="synString">                      </span><span class="synIdentifier">$construct</span>
<span class="synString">                    . '(?:'</span>
<span class="synString">                    . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; 'Testing for ' . </span><span class="synIdentifier">$LOOKTYPE{$construct}</span><span class="synString">,</span>
<span class="synString">                        desc       =&gt; 'Match ' . lc </span><span class="synIdentifier">$LOOKTYPE{$construct}</span><span class="synString">,</span>
<span class="synString">                    });</span>
<span class="synString">                }</span>
<span class="synString">                else {</span>
<span class="synString">                    # Otherwise, insert an event to report the start of the lookaround...</span>
<span class="synString">                    '(?:'</span>
<span class="synString">                    . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        event_type =&gt; 'pre',</span>
<span class="synString">                        msg        =&gt; 'Starting ' . </span><span class="synIdentifier">$LOOKTYPE{$construct}</span><span class="synString">,</span>
<span class="synString">                        desc       =&gt; 'Match ' . </span><span class="synIdentifier">$LOOKTYPE{$construct}</span><span class="synString">,</span>
<span class="synString">                    })</span>
<span class="synString">                    . </span><span class="synIdentifier">$construct</span><span class="synString">;</span>
<span class="synString">                }</span>
<span class="synString">            }</span>

<span class="synString">            # Capturing parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{capturing_paren}) {</span>
<span class="synString">                # The events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Get the corresponding capture group number...</span>
<span class="synString">                </span><span class="synIdentifier">$next_capture_group</span><span class="synString">++;</span>

<span class="synString">                # Track the maximum group number (for after branch resets)...</span>
<span class="synString">                </span><span class="synIdentifier">$max_capture_group</span><span class="synString"> = max(</span><span class="synIdentifier">$max_capture_group</span><span class="synString">, </span><span class="synIdentifier">$next_capture_group</span><span class="synString">);</span>

<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture     =&gt; 1,</span>
<span class="synString">                    construct_type =&gt; '_capture_group',</span>
<span class="synString">                    capture_name   =&gt; '</span><span class="synIdentifier">$'</span><span class="synString">.</span><span class="synIdentifier">$next_capture_group</span><span class="synString">,</span>
<span class="synString">                    shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the start of capturing...</span>
<span class="synString">                  '('</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; 'Capture to </span><span class="synIdentifier">$'</span><span class="synString">.</span><span class="synIdentifier">$next_capture_group</span><span class="synString">,</span>
<span class="synString">                    desc       =&gt; &quot;The start of a capturing block (</span><span class="synSpecial">\$</span><span class="synIdentifier">$next_capture_group</span><span class="synString">)&quot;,</span>
<span class="synString">                  })</span>
<span class="synString">                . '(?:';</span>
<span class="synString">            }</span>

<span class="synString">            # Named capturing parens...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{named_capturing_paren}) {</span>
<span class="synString">                # The events communicate privately via this variable...</span>
<span class="synString">                my </span><span class="synIdentifier">$shared_str_pos</span><span class="synString">;</span>

<span class="synString">                # Named capture groups are also numbered, so get the number...</span>
<span class="synString">                </span><span class="synIdentifier">$next_capture_group</span><span class="synString">++;</span>

<span class="synString">                # Track the maximum group number (for after branch resets)...</span>
<span class="synString">                </span><span class="synIdentifier">$max_capture_group</span><span class="synString"> = max(</span><span class="synIdentifier">$max_capture_group</span><span class="synString">, </span><span class="synIdentifier">$next_capture_group</span><span class="synString">);</span>

<span class="synString">                # If this creates a new numbered capture, remember the number...</span>
<span class="synString">                if (!</span><span class="synIdentifier">@{$capture_names_for[$next_capture_group]</span><span class="synperlVarBlock">//[]</span><span class="synIdentifier">}</span><span class="synString">) {</span>
<span class="synString">                    push </span><span class="synIdentifier">@{$capture_names_for[$next_capture_group]}</span><span class="synString">, '</span><span class="synIdentifier">$'</span><span class="synString">.</span><span class="synIdentifier">$next_capture_group</span><span class="synString">;</span>
<span class="synString">                }</span>

<span class="synString">                # Add this name to the list of aliases for the same numbered capture...</span>
<span class="synString">                # (Needed because named captures in two reset branches may alias</span>
<span class="synString">                # to the same underlying numbered capture variable. See perlre)</span>
<span class="synString">                push </span><span class="synIdentifier">@{$capture_names_for[$next_capture_group]}</span><span class="synString">, '</span><span class="synIdentifier">$+</span><span class="synString">{'.</span><span class="synIdentifier">$+</span><span class="synString">{capture_name}.'}';</span>

<span class="synString">                # It's an unbalanced opening paren, so remember it on the stack...</span>
<span class="synString">                push </span><span class="synIdentifier">@paren_stack</span><span class="synString">, {</span>
<span class="synString">                    is_capture     =&gt; 1,</span>
<span class="synString">                    construct_type =&gt; '_capture_group',</span>
<span class="synString">                    capture_name   =&gt; </span><span class="synIdentifier">$capture_names_for[$next_capture_group]</span><span class="synString">,</span>
<span class="synString">                    shared_str_pos =&gt; </span><span class="synSpecial">\$</span><span class="synString">shared_str_pos,</span>
<span class="synString">                };</span>

<span class="synString">                # Insert an event to report the start of the named capture...</span>
<span class="synString">                  </span><span class="synIdentifier">$construct</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'pre',</span>
<span class="synString">                    msg        =&gt; </span><span class="synIdentifier">$capture_names_for[$next_capture_group]</span><span class="synString">,</span>
<span class="synString">                    desc       =&gt; &quot;The start of a named capturing block (also </span><span class="synSpecial">\$</span><span class="synIdentifier">$next_capture_group</span><span class="synString">)&quot;,</span>
<span class="synString">                  })</span>
<span class="synString">                . '(?:';</span>
<span class="synString">            }</span>

<span class="synString">            # Closing parens have to be deciphered...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{closing_paren}) {</span>
<span class="synString">                # The top of the paren stack tells us what kind of group we're closing...</span>
<span class="synString">                my </span><span class="synIdentifier">$paren_data</span><span class="synString"> = pop(</span><span class="synIdentifier">@paren_stack</span><span class="synString">) // { type=&gt;'unmatched closing )' };</span>

<span class="synString">                # Update the next capture group number, if after a branch reset group...</span>
<span class="synString">                if (</span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_branch_reset</span><span class="synIdentifier">}</span><span class="synString">) {</span>
<span class="synString">                    </span><span class="synIdentifier">$next_capture_group</span><span class="synString"> = </span><span class="synIdentifier">$max_capture_group</span><span class="synString">;</span>
<span class="synString">                }</span>

<span class="synString">                # Generate an appropriate message for the type of group being closed...</span>
<span class="synString">                my </span><span class="synIdentifier">$msg</span><span class="synString"> = </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_capture</span><span class="synIdentifier">}</span><span class="synString"> &amp;&amp; ref </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">capture_name</span><span class="synIdentifier">}</span>
<span class="synString">                                                         ? </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">capture_name</span><span class="synIdentifier">}</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_capture</span><span class="synIdentifier">}</span><span class="synString">      ? 'End of ' . </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">capture_name</span><span class="synIdentifier">}</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_definition</span><span class="synIdentifier">}</span><span class="synString">   ? 'End of definition block'</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_branch_reset</span><span class="synIdentifier">}</span><span class="synString"> ? 'End of branch-resetting group'</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_lookaround</span><span class="synIdentifier">}</span><span class="synString">   ? 'End of ' . </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_lookaround</span><span class="synIdentifier">}</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_conditional</span><span class="synIdentifier">}</span><span class="synString">  ? 'End of conditional group'</span>
<span class="synString">                        : </span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_nonbacktrack</span><span class="synIdentifier">}</span><span class="synString"> ? 'End of non-backtracking group'</span>
<span class="synString">                        :                                  'End of non-capturing group'</span>
<span class="synString">                        ;</span>

<span class="synString">                if (length(</span><span class="synIdentifier">$std_info{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span><span class="synString">)) {</span>
<span class="synString">                    </span><span class="synIdentifier">$msg</span><span class="synString"> .= &quot; (matching </span><span class="synIdentifier">$quantifier_desc</span><span class="synString">)&quot;;</span>
<span class="synString">                }</span>

<span class="synString">                # Two events, so add an extra ID...</span>
<span class="synString">                </span><span class="synIdentifier">$event_ID</span><span class="synString"> = </span><span class="synIdentifier">$next_event_ID</span><span class="synString">++;</span>

<span class="synString">                # Append an event reporting the completion of the group...</span>
<span class="synString">                  ')'</span>
<span class="synString">                . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString">-1 =&gt; {</span>
<span class="synString">                    %std_info,</span>
<span class="synString">                    %{</span><span class="synIdentifier">$paren_data</span><span class="synString">},</span>
<span class="synString">                    event_type =&gt; 'post',</span>
<span class="synString">                    msg        =&gt; </span><span class="synIdentifier">$msg</span><span class="synString">,</span>
<span class="synString">                    desc       =&gt; ( ref </span><span class="synIdentifier">$msg</span><span class="synString"> ? 'The end of the named capturing block' : 'The e' . substr(</span><span class="synIdentifier">$msg</span><span class="synString">,1) ),</span>
<span class="synString">                    depth      =&gt; </span><span class="synIdentifier">$depth</span><span class="synString"> - 1,</span>
<span class="synString">                    indent     =&gt; </span><span class="synIdentifier">$INDENT</span><span class="synString"> x (</span><span class="synIdentifier">$depth</span><span class="synString"> - 1),</span>
<span class="synString">                  })</span>
<span class="synString">                . (</span><span class="synIdentifier">$paren_data-&gt;{</span><span class="synString">is_nonbacktrack</span><span class="synIdentifier">}</span>
<span class="synString">                        ? '|'</span>
<span class="synString">                        . _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                            %std_info,</span>
<span class="synString">                            %{</span><span class="synIdentifier">$paren_data</span><span class="synString">},</span>
<span class="synString">                            event_type =&gt; 'failed_nonbacktracking',</span>
<span class="synString">                            msg        =&gt; 'non-backtracking group',</span>
<span class="synString">                            depth      =&gt; </span><span class="synIdentifier">$depth</span><span class="synString"> - 1,</span>
<span class="synString">                            indent     =&gt; </span><span class="synIdentifier">$INDENT</span><span class="synString"> x (</span><span class="synIdentifier">$depth</span><span class="synString"> - 1),</span>
<span class="synString">                          })</span>
<span class="synString">                        . q{(?!)}</span>
<span class="synString">                        : q{}</span>
<span class="synString">                  )</span>
<span class="synString">                . ')'</span>
<span class="synString">                . </span><span class="synIdentifier">$std_info{</span><span class="synString">quantifier</span><span class="synIdentifier">}</span><span class="synString">;</span>
<span class="synString">            }</span>

<span class="synString">            # Skip comments...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{break_comment}) {</span>
<span class="synString">                # Insert an event reporting that the break comment is being skipped...</span>
<span class="synString">                _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'break',</span>
<span class="synString">                        msg        =&gt; 'Breaking at (and skipping) comment',</span>
<span class="synString">                        desc       =&gt; 'Ignore this comment (but Regexp::Debugger will break here)',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Skip comments...</span>
<span class="synString">            elsif (exists </span><span class="synIdentifier">$+</span><span class="synString">{comment}) {</span>
<span class="synString">                # Insert an event reporting that the comment is being skipped...</span>
<span class="synString">                _build_event(</span><span class="synIdentifier">$regex_ID</span><span class="synString">, </span><span class="synIdentifier">$event_ID</span><span class="synString"> =&gt; {</span>
<span class="synString">                        %std_info,</span>
<span class="synString">                        %{</span><span class="synIdentifier">$paren_stack[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]</span><span class="synString">},</span>
<span class="synString">                        matchable  =&gt; 0,</span>
<span class="synString">                        event_type =&gt; 'skip',</span>
<span class="synString">                        msg        =&gt; 'Skipping comment',</span>
<span class="synString">                        desc       =&gt; 'Ignore this comment',</span>
<span class="synString">                  })</span>
<span class="synString">            }</span>

<span class="synString">            # Ignore (but preserve) anything else...</span>
<span class="synString">            else {</span>
<span class="synString">                </span><span class="synIdentifier">$construct</span><span class="synString">;</span>
<span class="synString">            }</span>
<span class="synString">        };</span>
<span class="synString">    </span><span class="synStatement">}exmsg</span>;

    <span class="synComment"># Remember the regex...</span>
    <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">regex_src</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$clean_regex</span>;

    <span class="synComment"># Add a preface to reset state variables in the event handler...</span>
    <span class="synIdentifier">$raw_regex</span> = <span class="synString">&quot;(?&gt;</span><span class="synSpecial">\\</span><span class="synString">A(?{Regexp::Debugger::_reset_debugger_state()})(?!))|(?:</span><span class="synIdentifier">$raw_regex</span><span class="synString">)&quot;</span>;

    <span class="synStatement">return</span> <span class="synString">&quot;(?#R_d:</span><span class="synIdentifier">$regex_ID</span><span class="synString">)&quot;</span>.<span class="synIdentifier">$raw_regex</span>;
}

<span class="synComment">#====[ Dispatch in-regex events ]================================</span>

<span class="synComment"># How big the display window is...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$MAX_WIDTH</span>  = <span class="synNumber">80</span>;
<span class="synStatement">my</span> <span class="synIdentifier">$MAX_HEIGHT</span> = <span class="synNumber">60</span>;

<span class="synComment"># What to print so as to &quot;clear&quot; the screen...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$CLEAR_SCREEN</span> = <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> x <span class="synIdentifier">$MAX_HEIGHT</span>;

<span class="synComment"># How wide is each column in event mode...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$EVENT_COL_WIDTH</span> = <span class="synNumber">15</span>;


<span class="synKeyword">sub </span><span class="synFunction">_show_if_active </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$display_mode</span>, <span class="synIdentifier">$event_desc</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># Accumulate history...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$history_to_date</span>
        = <span class="synIdentifier">@{$history_of{$data_mode}</span><span class="synperlVarBlock">//[]</span><span class="synIdentifier">}</span> ? <span class="synIdentifier">$history_of{$data_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span> : <span class="synString">q{}</span>;

    <span class="synComment"># Remember, always....</span>
    <span class="synStatement">push</span> <span class="synIdentifier">@{$history_of{$data_mode}}</span>, {
        <span class="synString">display</span> =&gt; <span class="synIdentifier">$history_to_date</span> . <span class="synIdentifier">$event_desc</span> . <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>
    };

    <span class="synComment"># Show, if appropriate...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synIdentifier">$data_mode</span>) {
        <span class="synConditional">if</span> (!<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span> || <span class="synIdentifier">$data_mode</span> <span class="synOperator">ne</span> <span class="synString">'JSON'</span>) {
            _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
            _say <span class="synIdentifier">$history_of{$data_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
        }
    }

}

<span class="synKeyword">sub </span><span class="synFunction">_show_JSON    </span>{ _show_if_active(<span class="synString">'JSON'</span>,    <span class="synIdentifier">@_</span>) }
<span class="synKeyword">sub </span><span class="synFunction">_show_event   </span>{ _show_if_active(<span class="synString">'events'</span>,  <span class="synIdentifier">@_</span>) }


<span class="synComment"># Add a new animation &quot;frame&quot;...</span>
<span class="synKeyword">sub </span><span class="synFunction">_new_visualize </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">push</span> <span class="synIdentifier">@{$history_of{$data_mode}}</span>, { <span class="synString">display</span>=&gt;<span class="synString">q{}</span>, <span class="synString">is_match</span> =&gt; <span class="synNumber">0</span> };
}

<span class="synComment"># Output the args and also add them to the current animation &quot;frame&quot;</span>
<span class="synKeyword">sub </span><span class="synFunction">_visualize </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">@output</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">state</span> <span class="synIdentifier">$NO_MATCH</span> = <span class="synNumber">0</span>;
    <span class="synStatement">state</span> <span class="synIdentifier">$NO_FAIL</span>  = <span class="synNumber">0</span>;
    _visualize_matchfail(<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$NO_MATCH</span>, <span class="synIdentifier">$NO_FAIL</span>, <span class="synIdentifier">@output</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">_visualize_matchfail </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$is_match</span>, <span class="synIdentifier">$is_fail</span>, <span class="synIdentifier">@output</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$output</span> = <span class="synStatement">join</span> <span class="synString">q{}</span>, <span class="synStatement">grep</span> <span class="synStatement">{</span><span class="synOperator">defined</span><span class="synStatement">}</span> <span class="synIdentifier">@output</span>;
    <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synIdentifier">$data_mode</span>) {
        _say <span class="synIdentifier">$output</span>;
    }
    <span class="synIdentifier">$history_of{$data_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">is_fail</span><span class="synIdentifier">}</span>   = <span class="synNumber">1</span> <span class="synConditional">if</span> <span class="synIdentifier">$is_fail</span>;
    <span class="synIdentifier">$history_of{$data_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">is_match</span><span class="synIdentifier">}</span>  = <span class="synNumber">1</span> <span class="synConditional">if</span> <span class="synIdentifier">$is_match</span>;
    <span class="synIdentifier">$history_of{$data_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>  .= <span class="synIdentifier">$output</span> . <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>;
}

<span class="synComment"># Show previous animation frames...</span>
<span class="synKeyword">sub </span><span class="synFunction">_revisualize </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$step</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># Start at the previous step unless otherwise specified...</span>
    <span class="synIdentifier">$step</span> //= max(<span class="synNumber">0</span>, <span class="synIdentifier">@{$history_of{$display_mode}}</span>-<span class="synNumber">2</span>);

    <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = <span class="synString">'-'</span>;
<span class="synLabel">    STEP:</span>
    <span class="synRepeat">while</span> (<span class="synNumber">1</span>) {
        <span class="synComment"># Did we fall out of available history???</span>
        <span class="synStatement">last</span> STEP <span class="synConditional">if</span> <span class="synIdentifier">$step</span> &gt;= <span class="synIdentifier">@{$history_of{$display_mode}}</span>;

        <span class="synComment"># Clear display and show the requested step...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> <span class="synOperator">ne</span> <span class="synString">'?'</span>) {
            _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
            _print <span class="synIdentifier">$history_of{$display_mode}[$step]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
            <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'events'</span> || <span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'JSON'</span>) {
                <span class="synConditional">if</span> (!<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>) {
                    <span class="synStatement">say</span> _info_colourer(
                        <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[</span><span class="synSpecial">\u</span><span class="synIdentifier">$display_mode</span><span class="synString"> of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span>
                      . <span class="synString">qq{         [step: </span><span class="synIdentifier">$step</span><span class="synString">]}</span>
                    );
                }
            }
        }

        <span class="synComment"># Next input (but use starting cmd if one given)...</span>
        <span class="synIdentifier">$input</span> = _interact();

        <span class="synComment"># A &lt;CTRL-C&gt; terminates the process...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cC</span><span class="synString">&quot;</span>) {
            <span class="synStatement">kill</span> <span class="synNumber">9</span>, <span class="synIdentifier">$$</span>;
        }

        <span class="synComment"># An 'x' exits the process...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'x'</span>) {
            <span class="synStatement">exit</span>(<span class="synNumber">0</span>);
        }

        <span class="synComment"># A &lt;CTRL-L&gt; redraws the screen...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cL</span><span class="synString">&quot;</span>) {
            <span class="synStatement">next</span> STEP;
        }

        <span class="synComment"># Step back (if possible)...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'-'</span>) {
            <span class="synIdentifier">$step</span> = max(<span class="synNumber">0</span>, <span class="synIdentifier">$step</span>-<span class="synNumber">1</span>);
            <span class="synStatement">next</span> STEP;
        }

        <span class="synComment"># Display explanation of regex...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'d'</span>) {
            _show_regex_description(<span class="synIdentifier">$regex_ID</span>);
            <span class="synStatement">next</span> STEP;
        }

        <span class="synComment"># Help!</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'?'</span>) {
            _show_help();
            <span class="synStatement">next</span> STEP;
        }

        <span class="synComment"># Swap to requested mode...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'v'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'visual'</span>;
            <span class="synStatement">next</span> STEP;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'h'</span>) {
            <span class="synComment"># Can we use heatmap mode?</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$heatmaps_invisible</span>) {
                <span class="synStatement">say</span> <span class="synString">'Cannot show heatmaps (Term::ANSIColor unavailable)'</span>;
                <span class="synStatement">say</span> <span class="synString">&quot;Try 'H' instead&quot;</span>;
                <span class="synIdentifier">$input</span> = <span class="synString">'?'</span>;
            }
            <span class="synComment"># If heatmaps available, check for misuse of 'h' instead of '?'...</span>
            <span class="synConditional">else</span> {
                <span class="synStatement">my</span> <span class="synIdentifier">$prompt_help</span> = <span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'heatmap'</span>;
                <span class="synIdentifier">$display_mode</span> = <span class="synString">'heatmap'</span>;
                <span class="synConditional">if</span> (<span class="synIdentifier">$prompt_help</span>) {
                    <span class="synStatement">say</span> <span class="synString">&quot;(Type '?' for help)&quot;</span>;
                }
            }
            <span class="synStatement">next</span> STEP;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'e'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'events'</span>;
            <span class="synStatement">say</span> _info_colourer(
                <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[Events of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span>
              . <span class="synString">qq{         [step: </span><span class="synIdentifier">$step</span><span class="synString">]}</span>
            );
            <span class="synStatement">next</span> STEP;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'j'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'JSON'</span>;
            <span class="synStatement">next</span> STEP;
            <span class="synStatement">say</span> _info_colourer(
                <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[JSON data of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span>
              . <span class="synString">qq{         [step: </span><span class="synIdentifier">$step</span><span class="synString">]}</span>
            );
        }

        <span class="synComment"># Continue with actual matching...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'c'</span>) {
            <span class="synRepeat">while</span> (<span class="synIdentifier">$step</span> &lt; <span class="synIdentifier">@{$history_of{$display_mode}}</span>) {
                _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
                _print <span class="synIdentifier">$history_of{$display_mode}[$step</span><span class="synperlVarMember">++</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
                _pause(<span class="synFloat">0.1</span>);
            }
            <span class="synStatement">last</span> STEP;
        }

        <span class="synComment"># Quit entirely...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'q'</span> || <span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cD</span><span class="synString">&quot;</span>) {
            <span class="synStatement">last</span> STEP;
        }

        <span class="synComment"># Take a snapshot...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'V'</span>) { _save_snapshot(<span class="synString">'full_visual'</span>,  <span class="synIdentifier">$step</span>)     ; <span class="synStatement">next</span> STEP; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'H'</span>) { _save_snapshot(<span class="synString">'full_heatmap'</span>, <span class="synIdentifier">$step</span>)     ; <span class="synStatement">next</span> STEP; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'E'</span>) { _save_snapshot(<span class="synString">'events'</span>,       <span class="synIdentifier">$step</span>)     ; <span class="synStatement">next</span> STEP; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'J'</span>) { _save_snapshot(<span class="synString">'JSON'</span>,         <span class="synIdentifier">$step</span>)     ; <span class="synStatement">next</span> STEP; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'D'</span>) { _show_regex_description(<span class="synIdentifier">$regex_ID</span>,<span class="synString">'save'</span>) ; <span class="synStatement">next</span> STEP; }

        <span class="synComment"># Step forward to match...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'m'</span>) {
            <span class="synIdentifier">$step</span>++;
            <span class="synRepeat">while</span> (!<span class="synIdentifier">$history_of{$display_mode}[$step]{</span><span class="synString">is_match</span><span class="synIdentifier">}</span>) {
                <span class="synStatement">last</span> STEP <span class="synConditional">if</span> <span class="synIdentifier">$step</span> == <span class="synIdentifier">@{$history_of{$display_mode}}</span>-<span class="synNumber">1</span>;
                <span class="synIdentifier">$step</span>++;
            }
        }

        <span class="synComment"># Step forward to fail...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'f'</span>) {
            <span class="synIdentifier">$step</span>++;
            <span class="synRepeat">while</span> (!<span class="synIdentifier">$history_of{$display_mode}[$step]{</span><span class="synString">is_fail</span><span class="synIdentifier">}</span>) {
                <span class="synStatement">last</span> STEP <span class="synConditional">if</span> <span class="synIdentifier">$step</span> == <span class="synIdentifier">@{$history_of{$display_mode}}</span>-<span class="synNumber">1</span>;
                <span class="synIdentifier">$step</span>++;
            }
        }
        <span class="synComment"># Otherwise just step forward...</span>
        <span class="synConditional">else</span> {
            <span class="synIdentifier">$step</span>++;
        }
    }

    <span class="synComment"># Return final command...</span>
    <span class="synStatement">return</span> (<span class="synIdentifier">$input</span>, <span class="synIdentifier">$step</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">_build_visualization </span>{
    <span class="synComment"># Unpack all the info needed...</span>
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$named_args_ref</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$regex_src</span>, <span class="synIdentifier">$regex_pos</span>, <span class="synIdentifier">$construct_len</span>,
        <span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$str_pos</span>,
        <span class="synIdentifier">$is_match</span>, <span class="synIdentifier">$is_fail</span>, <span class="synIdentifier">$is_trying</span>, <span class="synIdentifier">$is_capture</span>,
        <span class="synIdentifier">$backtrack</span>, <span class="synIdentifier">$forward_step</span>, <span class="synIdentifier">$nested_because</span>,
        <span class="synIdentifier">$msg</span>, <span class="synIdentifier">$colourer</span>, <span class="synIdentifier">$no_window</span>, <span class="synIdentifier">$step</span>)
                = <span class="synIdentifier">@{$named_args_ref}{</span><span class="synString">qw(</span>
<span class="synString">                    regex_ID regex_src regex_pos construct_len</span>
<span class="synString">                    str_src str_pos</span>
<span class="synString">                    is_match is_fail is_trying is_capture</span>
<span class="synString">                    backtrack forward_step nested_because</span>
<span class="synString">                    msg colourer no_window step</span>
<span class="synString">                )</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Clear screen...</span>
    _new_visualize(<span class="synIdentifier">$data_mode</span>);
    <span class="synConditional">if</span> (!<span class="synIdentifier">$no_window</span>) {
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{}</span> <span class="synRepeat">for</span> <span class="synFloat">1.</span>.<span class="synIdentifier">$MAX_HEIGHT</span>;
    }

    <span class="synComment"># Remember originals...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$raw_str_src</span>   = <span class="synIdentifier">$str_src</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$raw_regex_src</span> = <span class="synIdentifier">$regex_src</span>;

    <span class="synComment"># Unwindowed displays show the title first...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$no_window</span>) {
        _visualize <span class="synIdentifier">$data_mode</span>,
                _info_colourer(
                    <span class="synString">qq{</span><span class="synSpecial">\n</span><span class="synString">[</span><span class="synSpecial">\u</span><span class="synIdentifier">$data_mode</span><span class="synString"> of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]</span><span class="synSpecial">\n\n</span><span class="synString">}</span>
                  . <span class="synString">qq{         [step: </span><span class="synIdentifier">$step</span><span class="synString">]}</span>
                );
    }

    <span class="synComment"># Visualize capture vars, if available...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$max_name_width</span> = <span class="synNumber">1</span> + max <span class="synStatement">map</span> <span class="synStatement">{length}</span> <span class="synNumber">0</span>, <span class="synStatement">keys</span> <span class="synIdentifier">%capture</span>;
<span class="synLabel">    CAPVAR:</span>
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$name</span> (<span class="synOperator">do</span>{ <span class="synStatement">no warnings</span> <span class="synString">'numeric'</span>; <span class="synStatement">sort</span> <span class="synStatement">{</span> <span class="synStatement">substr</span>(<span class="synIdentifier">$a</span>,<span class="synNumber">1</span>) &lt;=&gt; <span class="synStatement">substr</span>(<span class="synIdentifier">$b</span>,<span class="synNumber">1</span>) <span class="synStatement">}</span> <span class="synStatement">keys</span> <span class="synIdentifier">%capture</span>}) {
        <span class="synComment"># Remove any captures that are invalidated by backtracking...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$capture{$name}{</span><span class="synString">start_pos</span><span class="synIdentifier">}</span> &gt; <span class="synIdentifier">$regex_pos</span>) {
            <span class="synStatement">delete</span> <span class="synIdentifier">@{$capture{$name}}{</span><span class="synString">'from'</span><span class="synperlVarMember">,</span><span class="synString">'to'</span><span class="synIdentifier">}</span>;
        }

        <span class="synComment"># Clean up and visualize each remaining variable...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$start</span>   = <span class="synIdentifier">$capture{$name}{</span><span class="synString">from</span><span class="synIdentifier">}</span> // <span class="synStatement">next</span> CAPVAR;
        <span class="synStatement">my</span> <span class="synIdentifier">$end</span>     = <span class="synIdentifier">$capture{$name}{</span><span class="synString">to</span><span class="synIdentifier">}</span>   // <span class="synStatement">next</span> CAPVAR;
        <span class="synStatement">my</span> <span class="synIdentifier">$cap_str</span> = _quote_ws(<span class="synStatement">substr</span>(<span class="synIdentifier">$_</span>,<span class="synIdentifier">$start</span>,<span class="synIdentifier">$end</span>-<span class="synIdentifier">$start</span>));

        <span class="synComment"># Truncate captured value to maximum width by removing middle...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$cap_len</span> = <span class="synStatement">length</span>(<span class="synIdentifier">$cap_str</span>);
        <span class="synConditional">if</span> (<span class="synIdentifier">$cap_len</span> &gt; <span class="synIdentifier">$MAX_WIDTH</span>) {
            <span class="synStatement">my</span> <span class="synIdentifier">$middle</span> = <span class="synIdentifier">$MAX_WIDTH</span>/<span class="synNumber">2</span> - <span class="synNumber">2</span>;
            <span class="synStatement">substr</span>(<span class="synIdentifier">$cap_str</span>, <span class="synIdentifier">$middle</span>, -<span class="synIdentifier">$middle</span>, <span class="synString">'....'</span>);
        }

        <span class="synComment"># Display capture var and value...</span>
        _visualize <span class="synIdentifier">$data_mode</span>,
            _info_colourer(<span class="synStatement">sprintf</span> <span class="synString">qq{%*s = '%s'}</span>, <span class="synIdentifier">$max_name_width</span>, <span class="synIdentifier">$name</span>, <span class="synIdentifier">$cap_str</span>);
    }

    <span class="synComment"># Visualize special var, if used in regex...</span>
    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{}</span>;
    <span class="synConditional">if</span> (<span class="synStatement">index</span>(<span class="synIdentifier">$raw_regex_src</span>, <span class="synString">'$^N'</span>) &gt;= <span class="synNumber">0</span> &amp;&amp; <span class="synOperator">defined</span> <span class="synIdentifier">$^N</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$special_val</span> = <span class="synIdentifier">$^N</span>;

        <span class="synComment"># Truncate captured value to maximum width by removing middle...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$cap_len</span> = <span class="synStatement">length</span>(<span class="synIdentifier">$special_val</span>);
        <span class="synConditional">if</span> (<span class="synIdentifier">$cap_len</span> &gt; <span class="synIdentifier">$MAX_WIDTH</span>) {
            <span class="synStatement">my</span> <span class="synIdentifier">$middle</span> = <span class="synIdentifier">$MAX_WIDTH</span>/<span class="synNumber">2</span> - <span class="synNumber">2</span>;
            <span class="synStatement">substr</span>(<span class="synIdentifier">$special_val</span>, <span class="synIdentifier">$middle</span>, -<span class="synIdentifier">$middle</span>, <span class="synString">'....'</span>);
        }

        <span class="synComment"># Display capture var and value...</span>
        _visualize <span class="synIdentifier">$data_mode</span>,
            _info_colourer(<span class="synStatement">sprintf</span> <span class="synString">qq{%*s = '%s'}</span>, <span class="synIdentifier">$max_name_width</span>, <span class="synString">'$^N'</span>, <span class="synIdentifier">$special_val</span>);
    }

    <span class="synComment"># Leave a gap...</span>
    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{}</span> <span class="synRepeat">for</span> <span class="synFloat">1..2</span>;

    <span class="synComment"># Show matching...</span>
    _visualize_matchfail <span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$is_match</span>, <span class="synIdentifier">$is_fail</span>;

    <span class="synComment"># Reconfigure regex within visible window...</span>
    (<span class="synIdentifier">$regex_src</span>, <span class="synIdentifier">$regex_pos</span>)
        = _make_window(
                 <span class="synString">text</span> =&gt; <span class="synIdentifier">$regex_src</span>,
                  <span class="synString">pos</span> =&gt; <span class="synIdentifier">$regex_pos</span>,
                 <span class="synString">heat</span> =&gt; <span class="synStatement">substr</span>(<span class="synIdentifier">$data_mode</span>, -<span class="synNumber">7</span>) <span class="synOperator">eq</span> <span class="synString">'heatmap'</span> ?  <span class="synIdentifier">$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span> : [],
            <span class="synString">ws_colour</span> =&gt; <span class="synStatement">substr</span>(<span class="synIdentifier">$data_mode</span>, -<span class="synNumber">7</span>) <span class="synOperator">eq</span> <span class="synString">'heatmap'</span>,
            <span class="synString">no_window</span> =&gt; <span class="synIdentifier">$no_window</span>,
        );

    <span class="synComment"># How wide is the display???</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$display_width</span>
        = <span class="synIdentifier">$no_window</span> ? <span class="synIdentifier">$regex_pos</span>
        :              min(<span class="synIdentifier">$regex_pos</span>, <span class="synIdentifier">$MAX_WIDTH</span> - <span class="synStatement">length</span>(<span class="synIdentifier">$msg</span>));

    <span class="synComment"># Draw the regex with a message and a positional marker...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$data_mode</span> <span class="synOperator">ne</span> <span class="synString">'full_heatmap'</span>) {
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$display_width</span>, <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$msg</span>);
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$regex_pos</span>    , <span class="synIdentifier">$colourer</span>-&gt;(<span class="synString">'|'</span>);
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$regex_pos</span>    , <span class="synIdentifier">$colourer</span>-&gt;(<span class="synString">'V'</span>) x (<span class="synIdentifier">$construct_len</span> || <span class="synNumber">1</span>);
    }
    <span class="synConditional">else</span> {
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$regex_pos</span> , _info_colourer(<span class="synString">'|'</span>);
        _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$regex_pos</span> , _info_colourer(<span class="synString">'V'</span> x (<span class="synIdentifier">$construct_len</span> || <span class="synNumber">1</span>) );
    }

    <span class="synComment"># Draw regex itself...</span>
    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{/}</span>, <span class="synIdentifier">$regex_src</span>, <span class="synString">q{/}</span>;

    <span class="synComment"># Leave a gap...</span>
    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span> <span class="synRepeat">for</span> <span class="synFloat">1..2</span>;

    <span class="synComment"># Create marker for any match or capture within string...</span>
    <span class="synIdentifier">$forward_step</span> = min(<span class="synIdentifier">$forward_step</span>, <span class="synIdentifier">$MAX_WIDTH</span>);
    <span class="synStatement">my</span> <span class="synIdentifier">$last_match_marker</span>
        = (<span class="synString">q{ }</span> x (<span class="synIdentifier">$str_pos</span> - max(<span class="synNumber">0</span>,<span class="synIdentifier">$forward_step</span>)))
        . ( <span class="synIdentifier">$nested_because</span> <span class="synOperator">eq</span> <span class="synString">'failed'</span>       ? <span class="synString">q{}</span>
          : <span class="synIdentifier">$is_capture</span> &amp;&amp; <span class="synIdentifier">$forward_step</span> == <span class="synNumber">1</span> ? <span class="synString">'V'</span>
          : <span class="synIdentifier">$is_capture</span> &amp;&amp; <span class="synIdentifier">$forward_step</span> &gt; <span class="synNumber">1</span>  ? <span class="synString">'</span><span class="synSpecial">\\</span><span class="synString">'</span> . (<span class="synString">'_'</span> x (<span class="synIdentifier">$forward_step</span>-<span class="synNumber">2</span>)) . <span class="synString">'/'</span>
          :                                      <span class="synString">'^'</span> x <span class="synIdentifier">$forward_step</span>
          )
        ;


    <span class="synComment"># Reconfigure string within visible window...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$match_start</span>;
    (<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$str_pos</span>, <span class="synIdentifier">$match_start</span>, <span class="synIdentifier">$last_match_marker</span>)
        = _make_window(
                 <span class="synString">text</span> =&gt; <span class="synIdentifier">$str_src</span>,
                  <span class="synString">pos</span> =&gt; <span class="synIdentifier">$str_pos</span>,
                <span class="synString">start</span> =&gt; <span class="synIdentifier">$</span><span class="synType">Regexp::Grammars::</span><span class="synIdentifier">match_start_pos</span>,
                 <span class="synString">heat</span> =&gt; <span class="synStatement">substr</span>(<span class="synIdentifier">$data_mode</span>, -<span class="synNumber">7</span>) <span class="synOperator">eq</span> <span class="synString">'heatmap'</span> ?  <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span> : [],
            <span class="synString">ws_colour</span> =&gt; <span class="synStatement">substr</span>(<span class="synIdentifier">$data_mode</span>, -<span class="synNumber">7</span>) <span class="synOperator">eq</span> <span class="synString">'heatmap'</span>,
               <span class="synString">marker</span> =&gt; <span class="synIdentifier">$last_match_marker</span>,
            <span class="synString">no_window</span> =&gt; <span class="synIdentifier">$no_window</span>,
          );

    <span class="synComment"># Trim match start position...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$match_start</span> &gt; <span class="synIdentifier">$str_pos</span>) {
        <span class="synIdentifier">$match_start</span> = <span class="synIdentifier">$str_pos</span>;
    }

    <span class="synComment"># Colour match marker...</span>
    <span class="synIdentifier">$last_match_marker</span>
        = <span class="synStatement">substr</span>(<span class="synIdentifier">$last_match_marker</span>,<span class="synNumber">0</span>,<span class="synNumber">1</span>) <span class="synOperator">eq</span> <span class="synString">'^'</span> ? _match_colourer(<span class="synIdentifier">$last_match_marker</span>, <span class="synString">'reverse'</span>)
        :                                         _info_colourer(<span class="synIdentifier">$last_match_marker</span>);

    <span class="synComment"># Draw the string with a positional marker...</span>
    _visualize <span class="synIdentifier">$data_mode</span>,
        <span class="synString">q{ }</span>, _info_colourer( <span class="synStatement">substr</span>(<span class="synString">q{ }</span> x <span class="synIdentifier">$str_pos</span> . <span class="synString">'|'</span> .  <span class="synIdentifier">$backtrack</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$MAX_WIDTH</span>-<span class="synNumber">2</span>) );
    _visualize <span class="synIdentifier">$data_mode</span>,
        <span class="synString">q{ }</span>, <span class="synString">q{ }</span> x <span class="synIdentifier">$match_start</span>, _match_colourer(<span class="synIdentifier">$MATCH_DRAG</span> x (<span class="synIdentifier">$str_pos</span>-<span class="synIdentifier">$match_start</span>)), _info_colourer(<span class="synString">'V'</span>);
    <span class="synIdentifier">$str_src</span> = <span class="synComment"># Heatmap is already coloured...</span>
               <span class="synStatement">substr</span>(<span class="synIdentifier">$data_mode</span>, -<span class="synNumber">7</span>) <span class="synOperator">eq</span> <span class="synString">'heatmap'</span> ?
                    <span class="synIdentifier">$str_src</span>

               <span class="synComment"># On failure, fail-colour to current position...</span>
             : <span class="synIdentifier">$nested_because</span> <span class="synOperator">eq</span> <span class="synString">'failed'</span> ?
                    _fail_colourer( <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$str_pos</span>), <span class="synString">'ws'</span> )
                  . _ws_colourer(   <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$str_pos</span>)          )

               <span class="synComment"># When trying, try-colour current position</span>
             : <span class="synIdentifier">$is_trying</span> ?
                    _fail_colourer(  <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$match_start</span>),                                  <span class="synString">'ws'</span> )
                  . _match_colourer( <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$match_start</span>, <span class="synIdentifier">$str_pos</span>-<span class="synIdentifier">$match_start</span>), <span class="synString">'underline'</span>, <span class="synString">'ws'</span> )
                  . _try_colourer(   <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$str_pos</span>, <span class="synNumber">1</span>), <span class="synString">'underline bold'</span>,                    <span class="synString">'ws'</span> )
                  . _ws_colourer(    <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, min(<span class="synStatement">length</span>(<span class="synIdentifier">$str_src</span>),<span class="synIdentifier">$str_pos</span>+<span class="synNumber">1</span>))                       )

             : <span class="synComment"># Otherwise, report pre-failure and current match...</span>
                    _fail_colourer(  <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$match_start</span>),                                  <span class="synString">'ws'</span> )
                  . _match_colourer( <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$match_start</span>, <span class="synIdentifier">$str_pos</span>-<span class="synIdentifier">$match_start</span>), <span class="synString">'underline'</span>, <span class="synString">'ws'</span> )
                  . _ws_colourer(    <span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span>, <span class="synIdentifier">$str_pos</span>)                                               );

    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{'}</span>, <span class="synIdentifier">$str_src</span>, <span class="synString">q{'}</span>;  <span class="synComment"># String itself</span>

    <span class="synComment"># Draw a marker for any match or capture within the string...</span>
    _visualize <span class="synIdentifier">$data_mode</span>, <span class="synString">q{ }</span>, <span class="synIdentifier">$last_match_marker</span>;

    <span class="synComment"># Windowed displays show the title last...</span>
    <span class="synConditional">if</span> (!<span class="synIdentifier">$no_window</span>) {
        _visualize <span class="synIdentifier">$data_mode</span>,
                _info_colourer(
                    <span class="synString">qq{</span><span class="synSpecial">\n</span><span class="synString">[</span><span class="synSpecial">\u</span><span class="synIdentifier">$data_mode</span><span class="synString"> of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span>
                  . <span class="synString">qq{         [step: </span><span class="synIdentifier">$step</span><span class="synString">]}</span>
                );
    }

    <span class="synComment"># Special case: full heatmaps are reported as a table too...</span>
    <span class="synConditional">if</span> ( <span class="synIdentifier">$data_mode</span> <span class="synOperator">eq</span> <span class="synString">'full_heatmap'</span> ) {
        <span class="synComment"># Tabulate regex...</span>
        _visualize <span class="synIdentifier">$data_mode</span>, _info_colourer(<span class="synString">&quot;</span><span class="synSpecial">\n\n</span><span class="synString">Heatmap for regex:</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>);
        _visualize <span class="synIdentifier">$data_mode</span>, _build_tabulated_heatmap(<span class="synIdentifier">$raw_regex_src</span>, <span class="synIdentifier">$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span>);

        <span class="synComment"># Tabulate string...</span>
        _visualize <span class="synIdentifier">$data_mode</span>, _info_colourer(<span class="synString">&quot;</span><span class="synSpecial">\n\n</span><span class="synString">Heatmap for string:</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>);
        _visualize <span class="synIdentifier">$data_mode</span>, _build_tabulated_heatmap(<span class="synIdentifier">$raw_str_src</span>, <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span>);
    }
}

<span class="synComment"># Convert a heatmapped string to a table...</span>
<span class="synStatement">my</span> <span class="synIdentifier">$TABLE_STR_WIDTH</span> = <span class="synNumber">15</span>;
<span class="synKeyword">sub </span><span class="synFunction">_build_tabulated_heatmap </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$heatmap_ref</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># Normalized data...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$max_heat</span> = max(<span class="synNumber">1</span>, <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$_</span> // <span class="synNumber">0</span> <span class="synStatement">}</span> <span class="synIdentifier">@{$heatmap_ref}</span>);
    <span class="synStatement">my</span> <span class="synIdentifier">@heat</span> = <span class="synStatement">map</span> <span class="synStatement">{</span> (<span class="synIdentifier">$_</span>//<span class="synNumber">0</span>) / <span class="synIdentifier">$max_heat</span> <span class="synStatement">}</span> <span class="synIdentifier">@{$heatmap_ref}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$count_size</span> = <span class="synStatement">length</span>(<span class="synIdentifier">$max_heat</span>);

    <span class="synComment"># Determine colours to be used...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@HEAT_COLOUR</span> = <span class="synIdentifier">@{$lexical_config-&gt;{</span><span class="synString">heatmap_col</span><span class="synIdentifier">}}</span>;

    <span class="synComment"># Accumulate graph</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@graph</span>;
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$index</span> (<span class="synFloat">0.</span>.<span class="synStatement">length</span>(<span class="synIdentifier">$str</span>)-<span class="synNumber">1</span>) {

        <span class="synComment"># Locate next char and its heat value...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$char</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$index</span>, <span class="synNumber">1</span>);
        <span class="synStatement">my</span> <span class="synIdentifier">$abs_heat</span> = <span class="synIdentifier">$heatmap_ref-&gt;[$index]</span> // <span class="synNumber">0</span>;
        <span class="synStatement">my</span> <span class="synIdentifier">$display_char</span> = <span class="synIdentifier">$char</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> ? <span class="synString">'\n'</span>
                         : <span class="synIdentifier">$char</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\t</span><span class="synString">&quot;</span> ? <span class="synString">'\t'</span>
                         :                 <span class="synIdentifier">$char</span>;

        <span class="synComment"># Graph it...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">@graph</span> &amp;&amp; <span class="synStatement">length</span>(<span class="synIdentifier">$graph[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">text</span><span class="synIdentifier">}</span> . <span class="synIdentifier">$display_char</span>) &lt; <span class="synIdentifier">$TABLE_STR_WIDTH</span> &amp;&amp; <span class="synIdentifier">$graph[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">heat</span><span class="synIdentifier">}</span> == <span class="synIdentifier">$abs_heat</span>) {
            <span class="synIdentifier">$graph[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">text</span><span class="synIdentifier">}</span> .= <span class="synIdentifier">$display_char</span>;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$char</span> <span class="synOperator">ne</span> <span class="synString">q{ }</span> || <span class="synIdentifier">$abs_heat</span> != <span class="synNumber">0</span>) {
            <span class="synStatement">my</span> <span class="synIdentifier">$rel_heat</span> = <span class="synIdentifier">$heat[$index]</span> // <span class="synNumber">0</span>;
            <span class="synStatement">push</span> <span class="synIdentifier">@graph</span>, {
                    <span class="synString">text</span> =&gt; <span class="synIdentifier">$display_char</span>,
                    <span class="synString">heat</span> =&gt; <span class="synIdentifier">$abs_heat</span>,
                <span class="synString">rel_heat</span> =&gt; <span class="synIdentifier">$rel_heat</span>,
                     <span class="synString">bar</span> =&gt; <span class="synString">q{*}</span> x ((<span class="synIdentifier">$MAX_WIDTH</span>-<span class="synIdentifier">$TABLE_STR_WIDTH</span>) * <span class="synIdentifier">$rel_heat</span>),
            };
        }
    }

    <span class="synComment"># Draw table...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$table</span>;
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$entry</span> (<span class="synIdentifier">@graph</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$colour_index</span> = <span class="synStatement">int</span>( <span class="synFloat">0.5</span> + <span class="synIdentifier">$#HEAT_COLOUR</span> * <span class="synIdentifier">$entry-&gt;{</span><span class="synString">rel_heat</span><span class="synIdentifier">}</span> );
        <span class="synIdentifier">$table</span> .=
            <span class="synString">q{    }</span> .
            Term::ANSIColor::colored(
                <span class="synStatement">substr</span>(<span class="synIdentifier">$entry-&gt;{</span><span class="synString">text</span><span class="synIdentifier">}</span> . <span class="synString">q{ }</span> x <span class="synIdentifier">$TABLE_STR_WIDTH</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$TABLE_STR_WIDTH</span>) .
                <span class="synStatement">sprintf</span>(<span class="synString">&quot;| %-*s |%s</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>, <span class="synIdentifier">$count_size</span>, <span class="synIdentifier">$entry-&gt;{</span><span class="synString">heat</span><span class="synIdentifier">}</span> || <span class="synString">q{ }</span>, <span class="synIdentifier">$entry-&gt;{</span><span class="synString">bar</span><span class="synIdentifier">}</span>),
                <span class="synIdentifier">$HEAT_COLOUR[$colour_index]</span>
            );
    }

    <span class="synStatement">return</span> <span class="synIdentifier">$table</span>;
}

<span class="synComment"># These need to be localized within regexes, so have to be package vars...</span>
<span class="synStatement">our</span>   <span class="synIdentifier">$subpattern_depth</span>; <span class="synComment"># ...how many levels down in named subpatterns?</span>

<span class="synComment"># Reset debugger variables at start of match...</span>
<span class="synKeyword">sub </span><span class="synFunction">_reset_debugger_state </span>{
    <span class="synIdentifier">$prev_regex_pos</span>   = <span class="synNumber">0</span>;     <span class="synComment"># ...start of regex</span>
    <span class="synIdentifier">$prev_str_pos</span>     = <span class="synNumber">0</span>;     <span class="synComment"># ...start of string</span>
    <span class="synIdentifier">$pre_is_pending</span>   = <span class="synOperator">undef</span>; <span class="synComment"># ...no try is pending</span>
    <span class="synIdentifier">$interaction_mode</span> = <span class="synString">'s'</span>;   <span class="synComment"># ...always start in step-by-step mode</span>
    <span class="synIdentifier">$interaction_quit</span> = <span class="synNumber">0</span>;     <span class="synComment"># ...reset quit command for each regex</span>
    <span class="synIdentifier">$subpattern_depth</span> = <span class="synNumber">0</span>;     <span class="synComment"># ...start at top level of named subcalls</span>

    <span class="synIdentifier">$</span><span class="synType">Regexp::Grammars::</span><span class="synIdentifier">match_start_pos</span>  = <span class="synNumber">0</span>;     <span class="synComment"># ...start matching at start of string</span>

    <span class="synComment"># Also leave a gap in the event history and JSON representations...</span>
    _show_event <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">display_mode</span><span class="synIdentifier">}</span>, <span class="synString">q{}</span>;
    _show_JSON  <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">display_mode</span><span class="synIdentifier">}</span>, <span class="synString">q{}</span>;
}


<span class="synComment"># Set up a JSON encoder...</span>
<span class="synStatement">my</span> (<span class="synIdentifier">$JSON_encoder</span>, <span class="synIdentifier">$JSON_decoder</span>);
<span class="synPreProc">BEGIN </span>{
    (<span class="synIdentifier">$JSON_encoder</span>, <span class="synIdentifier">$JSON_decoder</span>) =
        <span class="synStatement">eval</span>{ <span class="synStatement">require</span> JSON::XS;   } ? <span class="synOperator">do</span> {
                                         <span class="synStatement">my</span> <span class="synIdentifier">$json</span> = JSON::XS-&gt;new-&gt;utf8(<span class="synNumber">1</span>)-&gt;pretty(<span class="synNumber">1</span>);
                                         (
                                             <span class="synKeyword">sub </span>{ <span class="synStatement">return</span> <span class="synIdentifier">$json-&gt;encode</span>(<span class="synStatement">shift</span>) },
                                             <span class="synKeyword">sub </span>{ <span class="synStatement">return</span> <span class="synIdentifier">$json-&gt;decode</span>(<span class="synStatement">shift</span>) },
                                         )
                                      }
      : <span class="synStatement">eval</span>{ <span class="synStatement">require</span> JSON;       } ? <span class="synOperator">do</span> {
                                         <span class="synStatement">my</span> <span class="synIdentifier">$json</span> = JSON-&gt;new-&gt;pretty(<span class="synNumber">1</span>);
                                         (
                                             <span class="synKeyword">sub </span>{ <span class="synStatement">return</span> <span class="synIdentifier">$json-&gt;encode</span>(<span class="synStatement">shift</span>) },
                                             <span class="synKeyword">sub </span>{ <span class="synStatement">return</span> <span class="synIdentifier">$json-&gt;decode</span>(<span class="synStatement">shift</span>) },
                                         )
                                      }
      : <span class="synStatement">eval</span>{ <span class="synStatement">require</span> <span class="synFloat">5.014</span>;
              <span class="synStatement">require</span> JSON::DWIW; } ? (
                                         <span class="synKeyword">sub </span>{ JSON::DWIW-&gt;to_json(<span class="synStatement">shift</span>,   {<span class="synString">pretty</span>=&gt;<span class="synNumber">1</span>}) },
                                         <span class="synKeyword">sub </span>{ JSON::DWIW-&gt;from_json(<span class="synStatement">shift</span>, {<span class="synString">pretty</span>=&gt;<span class="synNumber">1</span>}) },
                                      )
      : <span class="synStatement">eval</span>{ <span class="synStatement">require</span> JSON::Syck; } ? (
                                         \<span class="synIdentifier">&amp;</span><span class="synType">JSON::Syck::</span><span class="synIdentifier">Dump</span>,
                                         \<span class="synIdentifier">&amp;</span><span class="synType">JSON::Syck::</span><span class="synIdentifier">Load</span>,
                                      )
      :                               (
                                        <span class="synKeyword">sub </span>{ <span class="synString">'{}'</span> },
                                        <span class="synKeyword">sub </span>{  {}  },
                                      );
}

<span class="synComment"># Report some activity within the regex match...</span>
<span class="synKeyword">sub </span><span class="synFunction">_report_event </span>{
    <span class="synComment"># Did the user quit the interactive debugger???</span>
    <span class="synStatement">return</span> <span class="synConditional">if</span> <span class="synIdentifier">$interaction_quit</span>;

    <span class="synComment"># What are we matching....</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$str_src</span> = <span class="synIdentifier">$_</span>;

    <span class="synComment"># Which regex? Which event? Where in the string? Is this a recursive call?</span>
    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$event_ID</span>, <span class="synIdentifier">$str_pos</span>, <span class="synIdentifier">%opt</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$nested_because</span>  = <span class="synIdentifier">$opt{</span><span class="synString">nested_because</span><span class="synIdentifier">}</span> // <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$non_interactive</span> = <span class="synIdentifier">$opt{</span><span class="synString">non_iteractive</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Locate state info for this event...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$state_ref</span> = <span class="synIdentifier">$state{$regex_ID}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$event_ref</span> = <span class="synIdentifier">$state_ref-&gt;{$event_ID}</span>;

    <span class="synComment"># Unpack the necessary info...</span>
    <span class="synStatement">my</span> (<span class="synIdentifier">$matchable</span>, <span class="synIdentifier">$is_capture</span>, <span class="synIdentifier">$event_type</span>, <span class="synIdentifier">$construct</span>)
        = <span class="synIdentifier">@{$event_ref}{</span><span class="synString">qw&lt; matchable is_capture event_type construct&gt;</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> (<span class="synIdentifier">$construct_type</span>, <span class="synIdentifier">$quantifier</span>, <span class="synIdentifier">$regex_pos</span>, <span class="synIdentifier">$capture_name</span>, <span class="synIdentifier">$msg</span>)
        = <span class="synIdentifier">@{$event_ref}{</span><span class="synString">qw&lt; construct_type quantifier regex_pos capture_name msg&gt;</span><span class="synIdentifier">}</span>;
    <span class="synIdentifier">$construct_type</span> //= <span class="synString">q{}</span>;

    <span class="synComment"># Reset display_mode, capture variables, and starting position on every restart...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_START'</span>) {
        <span class="synIdentifier">%capture</span> = ();
        <span class="synIdentifier">$</span><span class="synType">Regexp::Grammars::</span><span class="synIdentifier">match_start_pos</span> = <span class="synStatement">pos</span>();
        <span class="synIdentifier">$lexical_config</span> = <span class="synIdentifier">$config[$event_ref-&gt;{</span><span class="synString">lexical_scope</span><span class="synIdentifier">}]</span>;

        <span class="synComment"># Reset display mode only on start (i.e. not on restart)...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$str_pos</span> == <span class="synNumber">0</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">display_mode</span><span class="synIdentifier">}</span>;
        }
    }

    <span class="synComment"># Ignore final failure messages, except at the very end...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$event_ref-&gt;{</span><span class="synString">regex_failed</span><span class="synIdentifier">}</span>) {
        <span class="synStatement">return</span> <span class="synConditional">if</span> (<span class="synIdentifier">$str_pos</span>//<span class="synNumber">0</span>) &lt; <span class="synStatement">length</span>(<span class="synIdentifier">$str_src</span>);
    }

    <span class="synComment"># This variable allows us to query the start position of a submatch when at the end of the submatch...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$shared_str_pos_ref</span> = <span class="synIdentifier">$event_ref-&gt;{</span><span class="synString">shared_str_pos</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Use the shared string pos on failure...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$nested_because</span> <span class="synOperator">eq</span> <span class="synString">'failed'</span>) {
        <span class="synIdentifier">$str_pos</span> = <span class="synIdentifier">${$shared_str_pos_ref</span><span class="synperlVarBlock"> // \</span><span class="synIdentifier">$prev_str_pos}</span> // <span class="synIdentifier">$str_pos</span>;
    }

    <span class="synComment"># Flatten aliased capture name(s)...</span>
    <span class="synConditional">if</span> (<span class="synOperator">ref</span> <span class="synIdentifier">$capture_name</span>) {
        <span class="synIdentifier">$capture_name</span> = <span class="synStatement">join</span> <span class="synString">' and '</span>, <span class="synIdentifier">@{$capture_name}</span>
    }

    <span class="synComment"># If we've matched, what did we match???</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$forward_step</span> = <span class="synNumber">0</span>; <span class="synComment"># ... will eventually contain how far forward we stepped</span>
    <span class="synConditional">if</span> ((<span class="synIdentifier">$matchable</span> || <span class="synIdentifier">$is_capture</span>) &amp;&amp; <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'post'</span> &amp;&amp; <span class="synIdentifier">$construct</span> <span class="synOperator">ne</span> <span class="synString">'|'</span>) {
        <span class="synIdentifier">$forward_step</span> = <span class="synIdentifier">$str_pos</span> - (<span class="synIdentifier">$shared_str_pos_ref</span> ? <span class="synIdentifier">${$shared_str_pos_ref}</span> : <span class="synIdentifier">$str_pos</span>);
    }

    <span class="synStatement">my</span> <span class="synIdentifier">$backtrack</span> = <span class="synString">q{}</span>;        <span class="synComment"># ...will store the arrow demonstrating the backtracking</span>

    <span class="synComment"># Are we backtracking?</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$str_backtrack_len</span>   = min(<span class="synIdentifier">$EVENT_COL_WIDTH</span>-<span class="synNumber">1</span>, <span class="synIdentifier">$prev_str_pos</span>-<span class="synIdentifier">$str_pos</span>);
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_backtrack_len</span> = min(<span class="synIdentifier">$EVENT_COL_WIDTH</span>-<span class="synNumber">1</span>, <span class="synIdentifier">$prev_regex_pos</span>-<span class="synIdentifier">$regex_pos</span>);
    <span class="synStatement">my</span> <span class="synIdentifier">$event_str</span>           = <span class="synString">'&lt;'</span> . <span class="synString">'~'</span> x <span class="synIdentifier">$str_backtrack_len</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$event_regex</span>         = <span class="synString">'&lt;'</span> . <span class="synString">'~'</span> x <span class="synIdentifier">$regex_backtrack_len</span>;
    <span class="synConditional">if</span> (<span class="synIdentifier">$nested_because</span> <span class="synOperator">ne</span> <span class="synString">'failed'</span>) {
        <span class="synComment"># Generate backtracking arrow...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$str_pos</span> &lt; (<span class="synIdentifier">$prev_str_pos</span>//<span class="synNumber">0</span>)) {
            <span class="synIdentifier">$backtrack</span> = <span class="synString">'&lt;'</span> . <span class="synString">'~'</span> x (<span class="synIdentifier">$prev_str_pos</span>-<span class="synIdentifier">$str_pos</span>-<span class="synNumber">1</span>);
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$regex_pos</span> &lt; (<span class="synIdentifier">$prev_regex_pos</span>//<span class="synNumber">0</span>)) {
            <span class="synIdentifier">$backtrack</span> = <span class="synString">' '</span>;
        }

        <span class="synComment"># Remember where we were...</span>
        <span class="synIdentifier">$prev_str_pos</span>   = <span class="synIdentifier">$str_pos</span>;
        <span class="synIdentifier">$prev_regex_pos</span> = <span class="synIdentifier">$regex_pos</span>;
    }

    <span class="synComment"># Was there a failed pending attempt???</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$pending_event_ID</span> = <span class="synIdentifier">$pre_is_pending</span>;
    <span class="synIdentifier">$pre_is_pending</span> = <span class="synOperator">undef</span>;
    <span class="synConditional">if</span> ((<span class="synIdentifier">$event_type</span> <span class="synOperator">ne</span> <span class="synString">'post'</span> || <span class="synIdentifier">$backtrack</span>) &amp;&amp; <span class="synOperator">defined</span> <span class="synIdentifier">$pending_event_ID</span>) {
        _report_event(<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$pending_event_ID</span>, <span class="synOperator">undef</span>, <span class="synString">nested_because</span>=&gt;<span class="synString">'failed'</span>);
    }

    <span class="synComment"># Get the source code of the regex...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_src</span> = <span class="synIdentifier">$state_ref-&gt;{</span><span class="synString">regex_src</span><span class="synIdentifier">}</span>;

    <span class="synComment"># How long is this piece of the regex???</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$construct_len</span> = <span class="synStatement">length</span> <span class="synIdentifier">$construct</span>;

    <span class="synComment"># Build msg if it's dynamic...</span>
    <span class="synConditional">if</span> (<span class="synOperator">ref</span>(<span class="synIdentifier">$msg</span>) <span class="synOperator">eq</span> <span class="synString">'CODE'</span>) {
        <span class="synIdentifier">$msg</span> = <span class="synIdentifier">$msg</span>-&gt;();
    }

    <span class="synComment"># Construct status message (if necessary)...</span>
    <span class="synIdentifier">$msg</span> = <span class="synIdentifier">$nested_because</span> <span class="synOperator">eq</span> <span class="synString">'failed'</span>        ?  <span class="synString">q{Failed}</span>
         : <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'pre'</span>  &amp;&amp; <span class="synOperator">ref</span> <span class="synIdentifier">$msg</span>  ?  <span class="synString">'Capture to '</span> . <span class="synStatement">join</span> <span class="synString">' and '</span>, <span class="synIdentifier">@{$msg}</span>
         : <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'post'</span> &amp;&amp; <span class="synOperator">ref</span> <span class="synIdentifier">$msg</span>  ?  <span class="synString">'End of '</span> . <span class="synStatement">join</span> <span class="synString">' and '</span>, <span class="synIdentifier">@{$msg}</span>
         : <span class="synOperator">defined</span> <span class="synIdentifier">$msg</span>                       ?  <span class="synIdentifier">$msg</span>
         : <span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_START'</span>        ?  <span class="synString">q{Starting regex match}</span>
         :                                       <span class="synString">q{}</span>
         ;

    <span class="synComment"># Report back-tracking occurred (but not when returning from named subpatterns)...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$backtrack</span> &amp;&amp; <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'failed_nonbacktracking'</span>) {
        <span class="synIdentifier">$msg</span> = <span class="synString">q{Back-tracking past }</span> . <span class="synStatement">lc</span>(<span class="synIdentifier">$msg</span>) . <span class="synString">q{ without rematching}</span>;
    }
    <span class="synConditional">elsif</span> (<span class="synIdentifier">$backtrack</span> &amp;&amp; <span class="synIdentifier">$construct_type</span> <span class="synOperator">ne</span> <span class="synString">'_named_subpattern_call'</span>) {
        <span class="synIdentifier">$msg</span> = <span class="synString">q{Back-tracked within regex and re}</span> . <span class="synStatement">lc</span>(<span class="synIdentifier">$msg</span>);
    }

    <span class="synComment"># Track trying and matching...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$is_match</span>    = <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'matched'</span>)   &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'Matched'</span>)   &gt;= <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$is_rematch</span>  = <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'rematched'</span>) &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'Rematched'</span>) &gt;= <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$is_trying</span>   = <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'trying'</span>)    &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'Trying'</span>)    &gt;= <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$is_skip</span>     = <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'skipping'</span>)  &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'Skipping'</span>)  &gt;= <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$is_fail</span>     = <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'failed'</span>)    &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>, <span class="synString">'Failed'</span>)    &gt;= <span class="synNumber">0</span>;

    <span class="synComment"># Track string heatmap...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$forward_step</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">@str_range</span> = <span class="synIdentifier">$str_pos</span>-<span class="synIdentifier">$forward_step</span>+<span class="synNumber">1</span> .. <span class="synIdentifier">$str_pos</span>-<span class="synNumber">1</span>;
        <span class="synIdentifier">$_</span>++ <span class="synRepeat">for</span> <span class="synIdentifier">@{$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}}[@str_range]</span>;
    }
    <span class="synConditional">elsif</span> (<span class="synIdentifier">$is_trying</span>) {
        <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}[$str_pos]</span>++;
    }

    <span class="synComment"># Trace regex heatmap...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$is_rematch</span> || !<span class="synIdentifier">$is_match</span> &amp;&amp; !<span class="synIdentifier">$is_fail</span> &amp;&amp; !<span class="synIdentifier">$is_skip</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">@regex_range</span> = <span class="synIdentifier">$regex_pos</span>..<span class="synIdentifier">$regex_pos</span>+<span class="synStatement">length</span>(<span class="synIdentifier">$construct</span>)-<span class="synNumber">1</span>;
        <span class="synIdentifier">$_</span>++ <span class="synRepeat">for</span> <span class="synIdentifier">@{$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}}[@regex_range]</span>;
    }

    <span class="synComment"># Track start and end positions for each capture...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_capture_group'</span>) {
        <span class="synConditional">if</span> (<span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'pre'</span>) {
            <span class="synIdentifier">$capture{$capture_name}{</span><span class="synString">from</span><span class="synIdentifier">}</span>      = <span class="synIdentifier">$str_pos</span>;
            <span class="synIdentifier">$capture{$capture_name}{</span><span class="synString">start_pos</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$regex_pos</span>;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'post'</span>) {
            <span class="synIdentifier">$capture{$capture_name}{</span><span class="synString">to</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$str_pos</span>;
        }
    }

    <span class="synComment"># Remember when a match/fail is pending...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$is_pending</span> = <span class="synIdentifier">$matchable</span>
                  &amp;&amp; <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'pre'</span>
                  &amp;&amp; <span class="synIdentifier">$construct_type</span> <span class="synOperator">ne</span> <span class="synString">'_named_subpattern_call'</span>;
    <span class="synConditional">if</span> (<span class="synIdentifier">$is_pending</span>) {
        <span class="synComment"># Pre- and post- events have adjacent IDs so add 1 to get post ID...</span>
        <span class="synIdentifier">$pre_is_pending</span> = <span class="synIdentifier">$event_ID</span> + <span class="synNumber">1</span>;
    }

    <span class="synComment"># Send starting position to corresponding post- event...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$shared_str_pos_ref</span> &amp;&amp; <span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'pre'</span> &amp;&amp; <span class="synIdentifier">$construct</span> <span class="synOperator">ne</span> <span class="synString">'|'</span>) {
        <span class="synIdentifier">${$shared_str_pos_ref}</span> = <span class="synIdentifier">$str_pos</span>;
    }

    <span class="synComment"># Compute indent for message (from paren depth + subcall depth)...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$indent</span> = <span class="synIdentifier">$INDENT</span> x (<span class="synIdentifier">$event_ref-&gt;{</span><span class="synString">depth</span><span class="synIdentifier">}</span> + <span class="synIdentifier">$subpattern_depth</span>);

    <span class="synComment"># Indicate any backtracking...</span>
    <span class="synConditional">if</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$event_str</span>) &gt; <span class="synNumber">1</span> || <span class="synStatement">length</span>(<span class="synIdentifier">$event_regex</span>) &gt; <span class="synNumber">1</span>) {
        <span class="synIdentifier">$event_str</span>   = <span class="synString">q{}</span> <span class="synConditional">if</span> <span class="synStatement">length</span>(<span class="synIdentifier">$event_str</span>) == <span class="synNumber">1</span>;
        <span class="synIdentifier">$event_regex</span> = <span class="synString">q{}</span> <span class="synConditional">if</span> <span class="synStatement">length</span>(<span class="synIdentifier">$event_regex</span>) == <span class="synNumber">1</span>;
        <span class="synStatement">my</span> <span class="synIdentifier">$backtrack_msg</span>
            = <span class="synIdentifier">$event_str</span> &amp;&amp; <span class="synIdentifier">$event_regex</span> ? <span class="synString">'Back-tracking in both regex and string'</span>
            : <span class="synIdentifier">$event_str</span>                 ? <span class="synString">'Back-tracking '</span> . <span class="synIdentifier">$str_backtrack_len</span>
                                           . <span class="synString">' character'</span>
                                           . (<span class="synIdentifier">$str_backtrack_len</span> == <span class="synNumber">1</span> ? <span class="synString">q{}</span> : <span class="synString">'s'</span>)
                                           . <span class="synString">' in string'</span>
            :                              <span class="synString">&quot;Back-tracking in regex&quot;</span>
            ;
        <span class="synIdentifier">$backtrack_msg</span> = _info_colourer(<span class="synIdentifier">$backtrack_msg</span>);
        <span class="synIdentifier">$event_regex</span> .= <span class="synString">q{ }</span> x (<span class="synIdentifier">$EVENT_COL_WIDTH</span> - <span class="synStatement">length</span> <span class="synIdentifier">$event_regex</span>);
        <span class="synIdentifier">$event_str</span>   .= <span class="synString">q{ }</span> x (<span class="synIdentifier">$EVENT_COL_WIDTH</span> - <span class="synStatement">length</span> <span class="synIdentifier">$event_str</span>);
        _show_event <span class="synIdentifier">$display_mode</span>,
                    <span class="synStatement">sprintf</span>(<span class="synString">&quot;%s | %s | %s&quot;</span>,
                             _info_colourer(<span class="synIdentifier">$event_str</span>),
                                  _info_colourer(<span class="synIdentifier">$event_regex</span>),
                                       <span class="synIdentifier">$indent</span> . <span class="synIdentifier">$backtrack_msg</span>);
    }

    <span class="synComment"># Colour the message...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$colourer</span> = _colourer_for(<span class="synIdentifier">$msg</span>);

    <span class="synComment"># Log (and perhaps display) event...</span>
    _show_event <span class="synIdentifier">$display_mode</span>,
               <span class="synStatement">sprintf</span>(<span class="synString">&quot;%-s | %-</span><span class="synIdentifier">${EVENT_COL_WIDTH}</span><span class="synString">s | %s&quot;</span>,
                        _ws_colourer(<span class="synStatement">substr</span>(<span class="synIdentifier">$str_src</span> . (<span class="synString">q{ }</span> x <span class="synIdentifier">$EVENT_COL_WIDTH</span>), <span class="synIdentifier">$str_pos</span>, <span class="synIdentifier">$EVENT_COL_WIDTH</span>)),
                            <span class="synStatement">substr</span>(<span class="synIdentifier">$regex_src</span>, <span class="synIdentifier">$regex_pos</span>, <span class="synIdentifier">$EVENT_COL_WIDTH</span>),
                                <span class="synIdentifier">$indent</span> . <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$msg</span>));

    <span class="synComment"># Display event mode line, if appropriate...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'events'</span> &amp;&amp; !<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>) {
        <span class="synStatement">say</span> _info_colourer( <span class="synString">qq{</span><span class="synSpecial">\n</span><span class="synString">[Events of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span> );
    }

    <span class="synComment"># Generate (and perhaps display) the JSON...</span>
    {
        <span class="synComment"># The data we're encoding...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$data</span> = {
            <span class="synString">regex_pos</span> =&gt; <span class="synIdentifier">$regex_pos</span>,
            <span class="synString">str_pos</span>   =&gt; <span class="synIdentifier">$str_pos</span>,
            <span class="synString">event</span>     =&gt; { <span class="synIdentifier">%{$event_ref}</span>, <span class="synString">msg</span> =&gt; <span class="synIdentifier">$msg</span> },
        };

        <span class="synComment"># But sanitize any procedural msg...</span>
        <span class="synConditional">if</span> (<span class="synOperator">ref</span> <span class="synIdentifier">$data-&gt;{</span><span class="synString">event</span><span class="synIdentifier">}{</span><span class="synString">msg</span><span class="synIdentifier">}</span> <span class="synOperator">eq</span> <span class="synString">'CODE'</span>) {
            <span class="synStatement">delete</span> <span class="synIdentifier">$data-&gt;{</span><span class="synString">event</span><span class="synIdentifier">}{</span><span class="synString">msg</span><span class="synIdentifier">}</span>;
        }

        <span class="synComment"># And sanitize any reference to internal communications channel...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$starting_str_pos</span> = <span class="synStatement">delete</span> <span class="synIdentifier">$data-&gt;{</span><span class="synString">event</span><span class="synIdentifier">}{</span><span class="synString">shared_str_pos</span><span class="synIdentifier">}</span>;
        <span class="synConditional">if</span> (<span class="synOperator">ref</span> <span class="synIdentifier">$starting_str_pos</span> <span class="synOperator">eq</span> <span class="synString">'SCALAR'</span> &amp;&amp; <span class="synIdentifier">${$starting_str_pos}</span> &amp;&amp; <span class="synIdentifier">${$starting_str_pos}</span> <span class="synOperator">ne</span> <span class="synIdentifier">$str_pos</span>) {
            <span class="synIdentifier">$data-&gt;{</span><span class="synString">starting_str_pos</span><span class="synIdentifier">}</span> = <span class="synIdentifier">${$starting_str_pos}</span>;
        }

        <span class="synStatement">my</span> <span class="synIdentifier">$json_rep</span> = <span class="synIdentifier">$JSON_encoder</span>-&gt;(<span class="synIdentifier">$data</span>);

        <span class="synComment"># Display opening delimiter at start...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_START'</span> &amp;&amp; <span class="synIdentifier">$str_pos</span> == <span class="synNumber">0</span>) {
            _show_JSON <span class="synIdentifier">$display_mode</span>, <span class="synString">'['</span>;
        }

        <span class="synComment"># Display event data (with comma, if needed)...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$comma</span> = <span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_END'</span> ? <span class="synString">q{}</span> : <span class="synString">q{,}</span>;
        _show_JSON <span class="synIdentifier">$display_mode</span>, <span class="synString">qq{    </span><span class="synIdentifier">$json_rep$comma</span><span class="synString">}</span>;

        <span class="synComment"># Display closing delimiter at end...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_END'</span>) {
            _show_JSON <span class="synIdentifier">$display_mode</span>, <span class="synString">']'</span>;
        }

        <span class="synComment"># Display mode line...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'JSON'</span> &amp;&amp; !<span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>) {
            <span class="synStatement">say</span> _info_colourer( <span class="synString">qq{</span><span class="synSpecial">\n</span><span class="synString">[JSON data of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span> );
        }
    }

    <span class="synComment"># Build and display (if appropriate) the &quot;2D&quot; visualizations...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">%data</span> = (
        <span class="synString">regex_ID</span>       =&gt;  <span class="synIdentifier">$regex_ID</span>,
        <span class="synString">regex_src</span>      =&gt;  <span class="synIdentifier">$regex_src</span>,
        <span class="synString">regex_pos</span>      =&gt;  <span class="synIdentifier">$regex_pos</span>,
        <span class="synString">construct_len</span>  =&gt;  <span class="synIdentifier">$construct_len</span>,
        <span class="synString">str_src</span>        =&gt;  <span class="synIdentifier">$str_src</span>,
        <span class="synString">str_pos</span>        =&gt;  <span class="synIdentifier">$str_pos</span>,
        <span class="synString">is_match</span>       =&gt;  <span class="synIdentifier">$is_match</span>,
        <span class="synString">is_fail</span>        =&gt;  <span class="synIdentifier">$is_fail</span>,
        <span class="synString">is_trying</span>      =&gt;  <span class="synIdentifier">$is_trying</span>,
        <span class="synString">is_capture</span>     =&gt;  <span class="synIdentifier">$is_capture</span>,
        <span class="synString">backtrack</span>      =&gt;  <span class="synIdentifier">$backtrack</span>,
        <span class="synString">forward_step</span>   =&gt;  <span class="synIdentifier">$forward_step</span>,
        <span class="synString">nested_because</span> =&gt;  <span class="synIdentifier">$nested_because</span>,
        <span class="synString">msg</span>            =&gt;  <span class="synIdentifier">$msg</span>,
        <span class="synString">colourer</span>       =&gt;  <span class="synIdentifier">$colourer</span>,
        <span class="synString">step</span>           =&gt;  <span class="synStatement">scalar</span> <span class="synIdentifier">@{$history_of{</span><span class="synString">visual</span><span class="synIdentifier">}</span><span class="synperlVarBlock">||[]</span><span class="synIdentifier">}</span>,
    );
    _build_visualization(<span class="synString">'visual'</span>,  \<span class="synIdentifier">%data</span>);
    _build_visualization(<span class="synString">'heatmap'</span>, \<span class="synIdentifier">%data</span>);

    <span class="synIdentifier">$data{</span><span class="synString">no_window</span><span class="synIdentifier">}</span> = <span class="synNumber">1</span>;
    _build_visualization(<span class="synString">'full_visual'</span>,  \<span class="synIdentifier">%data</span>);
    _build_visualization(<span class="synString">'full_heatmap'</span>, \<span class="synIdentifier">%data</span>);

    <span class="synComment"># Do any interaction...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$input</span>;
<span class="synLabel">    INPUT:</span>
    <span class="synRepeat">while</span> (!<span class="synIdentifier">$non_interactive</span>) {
        <span class="synComment"># Adaptive rate of display when skipping interactions...</span>
        <span class="synStatement">state</span> <span class="synIdentifier">$skip_rate</span> = <span class="synFloat">0.1</span>;
        <span class="synStatement">state</span> <span class="synIdentifier">$MIN_SKIP_RATE</span> = <span class="synFloat">0.001</span>;
        <span class="synIdentifier">$skip_rate</span> = max(<span class="synIdentifier">$MIN_SKIP_RATE</span>, <span class="synIdentifier">$skip_rate</span> * <span class="synFloat">0.98</span>);
        _pause(<span class="synIdentifier">$skip_rate</span>);

        <span class="synComment"># Skip interactions if current mode does not require them...</span>
        <span class="synStatement">last</span> INPUT <span class="synConditional">if</span> <span class="synIdentifier">$event_type</span> <span class="synOperator">ne</span> <span class="synString">'break'</span> &amp;&amp; (
                           <span class="synComment"># Skip-to-match mode...</span>
                           <span class="synIdentifier">$interaction_mode</span> <span class="synOperator">eq</span> <span class="synString">'m'</span>
                        &amp;&amp; !<span class="synIdentifier">$is_match</span>
                        &amp;&amp; <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'Back-tracked'</span>) &lt; <span class="synNumber">0</span>
                      ||
                           <span class="synComment"># Skip-to-fail mode...</span>
                           <span class="synIdentifier">$interaction_mode</span> <span class="synOperator">eq</span> <span class="synString">'f'</span>
                        &amp;&amp; !<span class="synIdentifier">$is_fail</span>
                      ||
                           <span class="synComment"># Skip-to-end mode...</span>
                           <span class="synIdentifier">$interaction_mode</span> <span class="synOperator">eq</span> <span class="synString">'c'</span>
                        &amp;&amp; <span class="synIdentifier">$construct_type</span> <span class="synOperator">ne</span> <span class="synString">'_END'</span>
                    );

        <span class="synComment"># Reset adaptive skip rate on any interaction...</span>
        <span class="synIdentifier">$skip_rate</span> = <span class="synFloat">0.1</span>;

        <span class="synComment"># Reset to step mode on a break...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$event_type</span> <span class="synOperator">eq</span> <span class="synString">'break'</span>) {
            <span class="synIdentifier">$interaction_mode</span> = <span class="synString">'s'</span>;
        }

        <span class="synComment"># Do what, John???</span>
        <span class="synIdentifier">$input</span> = _interact();

        <span class="synComment"># A &lt;CTRL-C&gt; terminates the process...</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cC</span><span class="synString">&quot;</span>) {
            <span class="synStatement">kill</span> <span class="synNumber">9</span>, <span class="synIdentifier">$$</span>;
        }

        <span class="synComment"># An 'x' exits the process...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'x'</span>) {
            <span class="synStatement">exit</span>(<span class="synNumber">0</span>);
        }

        <span class="synComment"># A &lt;CTRL-L&gt; redraws the screen...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cL</span><span class="synString">&quot;</span>) {
            _print <span class="synIdentifier">$history_of{$display_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
            <span class="synConditional">if</span> (<span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'events'</span> || <span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'JSON'</span>) {
                <span class="synStatement">say</span> _info_colourer( <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[</span><span class="synSpecial">\u</span><span class="synIdentifier">$display_mode</span><span class="synString"> of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span> );
            }
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Display explanation of regex...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'d'</span>) {
            _show_regex_description(<span class="synIdentifier">$regex_ID</span>);
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Help!</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'?'</span>) {
            _show_help();
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Quit all debugging???</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'q'</span> || <span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cD</span><span class="synString">&quot;</span>) {
            <span class="synIdentifier">$interaction_quit</span> = <span class="synNumber">1</span>;
            <span class="synStatement">last</span> INPUT;
        }

        <span class="synComment"># Step backwards...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'-'</span>) {
            (<span class="synIdentifier">$input</span>) = _revisualize(<span class="synIdentifier">$regex_ID</span>);
            <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'q'</span> || <span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\cD</span><span class="synString">&quot;</span>) {
                <span class="synIdentifier">$interaction_quit</span> = <span class="synNumber">1</span>;
                <span class="synStatement">last</span> INPUT;
            }
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Switch between visualizer/event/heatmap/JSON modes...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'v'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'visual'</span>;
            _print <span class="synIdentifier">$history_of{</span><span class="synString">'visual'</span><span class="synIdentifier">}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
            <span class="synStatement">next</span> INPUT;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'h'</span>) {
            <span class="synComment"># Can we use heatmap mode?</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$heatmaps_invisible</span>) {
                <span class="synStatement">say</span> <span class="synString">'Cannot show heatmaps (Term::ANSIColor unavailable)'</span>;
                <span class="synStatement">say</span> <span class="synString">&quot;Try 'H' instead&quot;</span>;
                <span class="synIdentifier">$input</span> = <span class="synString">'?'</span>;
            }
            <span class="synComment"># If heatmaps available, check for misuse of 'h' instead of '?'...</span>
            <span class="synConditional">else</span> {
                <span class="synStatement">my</span> <span class="synIdentifier">$prompt_help</span> = <span class="synIdentifier">$display_mode</span> <span class="synOperator">eq</span> <span class="synString">'heatmap'</span>;
                <span class="synIdentifier">$display_mode</span> = <span class="synString">'heatmap'</span>;
                _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
                _print <span class="synIdentifier">$history_of{</span><span class="synString">'heatmap'</span><span class="synIdentifier">}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
                <span class="synConditional">if</span> (<span class="synIdentifier">$prompt_help</span>) {
                    <span class="synStatement">say</span> <span class="synString">&quot;(Type '?' for help)&quot;</span>;
                }
            }
            <span class="synStatement">next</span> INPUT;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'e'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'events'</span>;
            _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
            _print <span class="synIdentifier">$history_of{</span><span class="synString">'events'</span><span class="synIdentifier">}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
            <span class="synStatement">say</span> _info_colourer( <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[Events of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span> );
            <span class="synStatement">next</span> INPUT;
        }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'j'</span>) {
            <span class="synIdentifier">$display_mode</span> = <span class="synString">'JSON'</span>;
            _print <span class="synIdentifier">$CLEAR_SCREEN</span>;
            _print <span class="synIdentifier">$history_of{</span><span class="synString">'JSON'</span><span class="synIdentifier">}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
            <span class="synStatement">say</span> _info_colourer( <span class="synString">qq{</span><span class="synSpecial">\n\n</span><span class="synString">[JSON data of regex at </span><span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span><span class="synString">]}</span> );
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Take a snapshot...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'V'</span>) { _save_snapshot(<span class="synString">'full_visual'</span>)             ; <span class="synStatement">next</span> INPUT; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'H'</span>) { _save_snapshot(<span class="synString">'full_heatmap'</span>)            ; <span class="synStatement">next</span> INPUT; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'E'</span>) { _save_snapshot(<span class="synString">'events'</span>)                  ; <span class="synStatement">next</span> INPUT; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'J'</span>) { _save_snapshot(<span class="synString">'JSON'</span>)                    ; <span class="synStatement">next</span> INPUT; }
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'D'</span>) { _show_regex_description(<span class="synIdentifier">$regex_ID</span>,<span class="synString">'save'</span>) ; <span class="synStatement">next</span> INPUT; }

        <span class="synComment"># Require an explicit quit request at end of match...</span>
<span class="synComment">#        elsif ($construct_type eq '_END') {</span>
<span class="synComment">#            print $history_of{$display_mode}[-1]{display};</span>
<span class="synComment">#            say Term::ANSIColor::colored(&quot;(type 'q' to leave visualization)&quot;, $ERR_COL);</span>
<span class="synComment">#            next INPUT;</span>
<span class="synComment">#        }</span>

        <span class="synComment"># Change of interaction mode???</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> ~~ [<span class="synString">'f'</span>,<span class="synString">'m'</span>,<span class="synString">'s'</span>,<span class="synString">'c'</span>]) {
            <span class="synIdentifier">$interaction_mode</span> = <span class="synIdentifier">$input</span>;
            <span class="synStatement">last</span> INPUT;
        }

        <span class="synComment"># Otherwise, move on...</span>
        <span class="synConditional">else</span> {
            <span class="synStatement">last</span> INPUT;
        }
    }

    <span class="synComment"># At end of debugging, save data to file (if requested), and clean up...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$construct_type</span> <span class="synOperator">eq</span> <span class="synString">'_END'</span>) {
        _save_to_fh(<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$str_src</span>);

        <span class="synIdentifier">%history_of</span> = ();
        <span class="synIdentifier">$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span> = [];
        <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span> = [];
    }

    <span class="synStatement">return</span> <span class="synIdentifier">$input</span>;
}

<span class="synComment"># Dump all history and config data to a stream...</span>
<span class="synKeyword">sub </span><span class="synFunction">_save_to_fh </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$str_src</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># No-op if not saving to file...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$fh</span> = <span class="synStatement">delete</span> <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>
        <span class="synOperator">or</span> <span class="synStatement">return</span>;

    <span class="synComment"># Extract data to correct level...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$match_heatmap</span>  = <span class="synStatement">delete</span> <span class="synIdentifier">$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$string_heatmap</span> = <span class="synStatement">delete</span> <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$location</span>       = <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_display</span>  = <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">regex_src</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_original</span> = <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">raw_regex</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Ensure print prints everything...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$prev_select</span> = <span class="synStatement">select</span> <span class="synIdentifier">$fh</span>;
    <span class="synStatement">local</span> <span class="synIdentifier">$|</span>=<span class="synNumber">1</span>;

    <span class="synComment"># Encode and print...</span>
    <span class="synStatement">print</span> <span class="synStatement">{</span><span class="synIdentifier">$fh</span><span class="synStatement">}</span> <span class="synIdentifier">$JSON_encoder</span>-&gt;({
        <span class="synString">regex_ID</span>       =&gt; <span class="synIdentifier">$regex_ID</span>,
        <span class="synString">regex_location</span> =&gt; <span class="synIdentifier">$location</span>,
        <span class="synString">regex_original</span> =&gt; <span class="synIdentifier">$regex_original</span>,
        <span class="synString">regex_display</span>  =&gt; <span class="synIdentifier">$regex_display</span>,
        <span class="synString">string_display</span> =&gt; <span class="synIdentifier">$str_src</span>,
        <span class="synString">config</span>         =&gt; <span class="synIdentifier">$lexical_config</span>,
        <span class="synString">match_data</span>     =&gt; <span class="synIdentifier">$JSON_decoder</span>-&gt;(<span class="synIdentifier">$history_of{</span><span class="synString">JSON</span><span class="synIdentifier">}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>),
        <span class="synString">match_heatmap</span>  =&gt; <span class="synIdentifier">$match_heatmap</span>,
        <span class="synString">string_heatmap</span> =&gt; <span class="synIdentifier">$string_heatmap</span>,
        <span class="synString">visualization</span>  =&gt; \<span class="synIdentifier">%history_of</span>,
    }), <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>;

    <span class="synComment"># Restore filehandles...</span>
    <span class="synStatement">select</span> <span class="synIdentifier">$prev_select</span>;
    <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$fh</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_show_regex_description </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$save</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># How wide to display regex components...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$MAX_DISPLAY</span> = <span class="synNumber">20</span>;

    <span class="synComment"># The info we're displaying...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$info</span> = <span class="synIdentifier">$state{$regex_ID}</span>;

    <span class="synComment"># Coloured separator...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$separator</span> = <span class="synIdentifier">$save</span> ? <span class="synString">q{}</span>
                  :         Term::ANSIColor::colored(
                                <span class="synString">q{ }</span> x <span class="synIdentifier">$MAX_WIDTH</span> . <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>,
                                <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">desc_sep_col</span><span class="synIdentifier">}</span>
                            );

    <span class="synComment"># Direct the output...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$STDOUT</span>;
    <span class="synConditional">if</span> (<span class="synIdentifier">$save</span>) {
        <span class="synIdentifier">$STDOUT</span> = _prompt_for_file(<span class="synString">'description'</span>);
    }
    <span class="synConditional">else</span> {
        <span class="synStatement">my</span> <span class="synIdentifier">$pager</span>  = <span class="synIdentifier">$ENV{</span><span class="synString">PAGER</span><span class="synIdentifier">}</span> // <span class="synString">'more'</span>;
        <span class="synConditional">if</span> (<span class="synIdentifier">$pager</span> <span class="synOperator">eq</span> <span class="synString">'less'</span>) {
            <span class="synIdentifier">$pager</span> .= <span class="synString">' -R'</span>;
        }
        <span class="synStatement">open</span> <span class="synIdentifier">$STDOUT</span>, <span class="synString">'|-'</span>, <span class="synIdentifier">$pager</span> <span class="synOperator">or</span> <span class="synStatement">return</span>;
    }

    <span class="synComment"># Build the display...</span>
    <span class="synStatement">say</span> <span class="synStatement">{</span><span class="synIdentifier">$STDOUT</span><span class="synStatement">}</span>
        <span class="synIdentifier">$separator</span>
      . <span class="synStatement">join</span> <span class="synString">q{}</span>,
        <span class="synStatement">map</span> <span class="synStatement">{</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$indent</span>    = <span class="synIdentifier">$info-&gt;{$_}{</span><span class="synString">indent</span><span class="synIdentifier">}</span>;
            <span class="synStatement">my</span> <span class="synIdentifier">$construct</span> = <span class="synStatement">sprintf</span>(<span class="synString">'%-*s'</span>, <span class="synIdentifier">$MAX_DISPLAY</span>, <span class="synIdentifier">$indent</span> . <span class="synIdentifier">$info-&gt;{$_}{</span><span class="synString">construct</span><span class="synIdentifier">}</span>);
            <span class="synStatement">my</span> <span class="synIdentifier">$desc</span>      = <span class="synIdentifier">$indent</span> . <span class="synIdentifier">$info-&gt;{$_}{</span><span class="synString">desc</span><span class="synIdentifier">}</span>;

            <span class="synComment"># Decorate according to destination...</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$save</span>) {
                <span class="synIdentifier">$desc</span> = <span class="synString">'#'</span> . <span class="synIdentifier">$desc</span>
            }
            <span class="synConditional">else</span> {
                <span class="synIdentifier">$construct</span> = Term::ANSIColor::colored(<span class="synIdentifier">$construct</span>, <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">desc_regex_col</span><span class="synIdentifier">}</span>);
                <span class="synIdentifier">$desc</span>      = Term::ANSIColor::colored(<span class="synIdentifier">$desc</span>,      <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">desc_text_col</span><span class="synIdentifier">}</span>);
            }

            <span class="synComment"># Format and return...</span>
            <span class="synConditional">if</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$indent</span> . <span class="synIdentifier">$info-&gt;{$_}{</span><span class="synString">construct</span><span class="synIdentifier">}</span>) &gt; <span class="synNumber">20</span>) {
                  <span class="synIdentifier">$construct</span> . <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>
                . <span class="synString">q{ }</span> x (<span class="synIdentifier">$MAX_DISPLAY</span>+<span class="synNumber">2</span>) . <span class="synString">&quot;</span><span class="synIdentifier">$desc</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>
                . <span class="synIdentifier">$separator</span>
            }
            <span class="synConditional">else</span> {
                  <span class="synString">&quot;</span><span class="synIdentifier">$construct</span><span class="synString">  </span><span class="synIdentifier">$desc</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>
                . <span class="synIdentifier">$separator</span>
            }
        <span class="synStatement">}</span>
        <span class="synStatement">sort</span> <span class="synStatement">{</span> <span class="synIdentifier">$a</span> &lt;=&gt; <span class="synIdentifier">$b</span> <span class="synStatement">}</span>
        <span class="synStatement">grep</span> <span class="synStatement">{</span> <span class="synStatement">/</span><span class="synString">^</span><span class="synSpecial">\d+</span><span class="synString">$</span><span class="synStatement">/</span> &amp;&amp; <span class="synStatement">exists</span> <span class="synIdentifier">$info-&gt;{$_}{</span><span class="synString">desc</span><span class="synIdentifier">}</span> <span class="synStatement">}</span>
        <span class="synStatement">keys</span> <span class="synIdentifier">%$info</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_show_help </span>{
    <span class="synStatement">say</span> <span class="synString">&lt;&lt;'END_HELP';</span>
<span class="synString">________________________________________________/ Help \______</span>

<span class="synString">  Motion:    s : step forwards</span>
<span class="synString">             - : step backwards</span>
<span class="synString">             m : continue to next partial match</span>
<span class="synString">             f : continue to next partial failure</span>
<span class="synString">             c : continue to end of full match</span>
<span class="synString">         &lt;RET&gt; : repeat last motion</span>

<span class="synString">  Display:   v : change to visualization</span>
<span class="synString">             e : change to event log</span>
<span class="synString">             h : change to heatmaps</span>
<span class="synString">             j : change to JSON representation</span>
<span class="synString">             d : describe the regex in detail</span>

<span class="synString">  Snapshot:  V : take snapshot of current visualization</span>
<span class="synString">             E : take snapshot of current event log</span>
<span class="synString">             H : take snapshot of current heatmaps</span>
<span class="synString">             J : take snapshot of current JSON representation</span>
<span class="synString">             D : take snapshot of regex description</span>

<span class="synString">  Control:   q : quit debugger and continue program</span>
<span class="synString">             x : exit debugger and terminate program</span>

<span class="synString">______________________________________________________________</span>
<span class="synString">END_HELP</span>
}

<span class="synComment"># Take a snapshot of the current debugger state...</span>
<span class="synStatement">my</span> <span class="synIdentifier">@ERR_MODE</span> = ( <span class="synString">-timeout</span> =&gt; <span class="synNumber">10</span>, <span class="synString">-style</span> =&gt; <span class="synIdentifier">$ERR_COL</span>, -single);

<span class="synKeyword">sub </span><span class="synFunction">_prompt_for_file </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>) = <span class="synIdentifier">@_</span>;

    <span class="synConditional">if</span> (!<span class="synStatement">eval</span> { <span class="synStatement">require</span> Time::HiRes; }) {
        *Time::HiRes::time = <span class="synKeyword">sub </span>{ <span class="synStatement">time</span> };
    }

    <span class="synComment"># Default target for save...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$open_mode</span> = <span class="synString">'&gt;'</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$filename</span>  = <span class="synString">'rxrx_'</span> . <span class="synIdentifier">$data_mode</span> . <span class="synString">'_'</span> . Time::HiRes::time();

    <span class="synComment"># Request a filename...</span>
    <span class="synStatement">print</span> <span class="synString">&quot;Save </span><span class="synIdentifier">$data_mode</span><span class="synString"> snapshot as: &quot;</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = _interact();

    <span class="synComment"># Default to paged-to-screen...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>) {
        <span class="synStatement">say</span> <span class="synString">'&lt;screen&gt;'</span>;
        <span class="synIdentifier">$open_mode</span> = <span class="synString">'|-'</span>;
        <span class="synIdentifier">$filename</span>  = <span class="synIdentifier">$ENV{</span><span class="synString">PAGER</span><span class="synIdentifier">}</span> // <span class="synString">'more'</span>;
        <span class="synConditional">if</span> (<span class="synIdentifier">$filename</span> <span class="synOperator">eq</span> <span class="synString">'less'</span>) {
            <span class="synIdentifier">$filename</span> .= <span class="synString">' -R'</span>;
        }
    }

    <span class="synComment"># &lt;TAB&gt; selects precomputed filename...</span>
    <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\t</span><span class="synString">&quot;</span>) {
        <span class="synStatement">say</span> <span class="synIdentifier">$filename</span>;
        _pause(<span class="synNumber">2</span>);
    }

    <span class="synComment"># Otherwise, use whatever they type...</span>
    <span class="synConditional">else</span> {
        <span class="synIdentifier">$filename</span> = <span class="synIdentifier">$input</span>;
        <span class="synStatement">print</span> <span class="synIdentifier">$input</span>;
        <span class="synIdentifier">$filename</span> .= <span class="synStatement">readline</span> *STDIN;
        <span class="synStatement">chomp</span> <span class="synIdentifier">$filename</span>;
    }

    <span class="synComment"># Set up the output stream...</span>
    <span class="synStatement">open</span> <span class="synStatement">my</span> <span class="synIdentifier">$fh</span>, <span class="synIdentifier">$open_mode</span>, <span class="synIdentifier">$filename</span> <span class="synOperator">or</span> <span class="synOperator">do</span> {
        <span class="synStatement">say</span> Term::ANSIColor::colored(<span class="synString">&quot;Can't open </span><span class="synIdentifier">$filename</span><span class="synString">: </span><span class="synIdentifier">$!</span><span class="synString">&quot;</span>, <span class="synIdentifier">$ERR_COL</span>);
        <span class="synStatement">say</span> Term::ANSIColor::colored(<span class="synString">&quot;(Hit any key to continue)&quot;</span>, <span class="synIdentifier">$ERR_COL</span>);
        _interact();
        <span class="synStatement">return</span>;
    };

    <span class="synStatement">return</span> <span class="synIdentifier">$fh</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_save_snapshot </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$data_mode</span>, <span class="synIdentifier">$step</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$step</span> //= -<span class="synNumber">1</span>;

    <span class="synComment"># Open the save target...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$fh</span> = _prompt_for_file(<span class="synIdentifier">$data_mode</span>);

    <span class="synComment"># Output current state (appropriately trimmed)...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$state</span> = <span class="synIdentifier">$history_of{$data_mode}[$step]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;
    <span class="synRepeat">while</span> (<span class="synStatement">substr</span>(<span class="synIdentifier">$state</span>, <span class="synNumber">0</span>, <span class="synNumber">1</span>) <span class="synOperator">eq</span> <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>) {
        <span class="synStatement">substr</span>(<span class="synIdentifier">$state</span>, <span class="synNumber">0</span>, <span class="synNumber">1</span>, <span class="synString">q{}</span>);
    }
    <span class="synStatement">print</span> <span class="synStatement">{</span><span class="synIdentifier">$fh</span><span class="synStatement">}</span> <span class="synIdentifier">$state</span>;

    <span class="synComment"># JSON output may be partial...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$data_mode</span> <span class="synOperator">eq</span> <span class="synString">'JSON'</span> &amp;&amp; <span class="synStatement">substr</span>(<span class="synIdentifier">$state</span>, -<span class="synNumber">2</span>) <span class="synOperator">eq</span> <span class="synString">&quot;,</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>) {
        <span class="synStatement">print</span> <span class="synStatement">{</span><span class="synIdentifier">$fh</span><span class="synStatement">}</span> <span class="synString">&quot;    { MATCH_INCOMPLETE =&gt; 1 }</span><span class="synSpecial">\n</span><span class="synString">]</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>;
    }

    <span class="synComment"># Clean up...</span>
    <span class="synStatement">close</span> <span class="synIdentifier">$fh</span>;

    <span class="synComment"># Restore previous visuals...</span>
    _print <span class="synIdentifier">$history_of{$display_mode}[</span><span class="synperlVarMember">-</span><span class="synNumber">1</span><span class="synIdentifier">]{</span><span class="synString">display</span><span class="synIdentifier">}</span>;

    <span class="synStatement">return</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_build_heatmap </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$count_ref</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># Determine colours to be used...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">@HEAT_COLOUR</span> = <span class="synIdentifier">@{$lexical_config-&gt;{</span><span class="synString">heatmap_col</span><span class="synIdentifier">}}</span>;

    <span class="synComment"># Normalize counts to match @HEAT_COLOUR entries...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$max</span> = max <span class="synNumber">1</span>, <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synIdentifier">$_</span> // <span class="synNumber">0</span> <span class="synStatement">}</span> <span class="synIdentifier">@{$count_ref}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">@count</span> = <span class="synStatement">map</span> <span class="synStatement">{</span> <span class="synStatement">int</span>( <span class="synFloat">0.5</span> + <span class="synIdentifier">$#HEAT_COLOUR</span> * (<span class="synIdentifier">$_</span>//<span class="synNumber">0</span>) / <span class="synIdentifier">$max</span> ) <span class="synStatement">}</span> <span class="synIdentifier">@{$count_ref}</span>;

    <span class="synComment"># Colour each character...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$heatmap</span> = <span class="synString">q{}</span>;
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$n</span> (<span class="synFloat">0.</span>.<span class="synStatement">length</span>(<span class="synIdentifier">$str</span>)-<span class="synNumber">1</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$heat</span> = <span class="synIdentifier">$HEAT_COLOUR[$count[$n]</span><span class="synperlVarMember"> // </span><span class="synNumber">0</span><span class="synIdentifier">]</span>;
        <span class="synIdentifier">$heatmap</span> .= _ws_colourer(<span class="synStatement">substr</span>(<span class="synIdentifier">$str</span>,<span class="synIdentifier">$n</span>,<span class="synNumber">1</span>), <span class="synIdentifier">$heat</span>);
    }

    <span class="synStatement">return</span> <span class="synIdentifier">$heatmap</span>;
}

<span class="synComment"># Extract a window-into-string to fit it on screen...</span>
<span class="synKeyword">sub </span><span class="synFunction">_make_window </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">%arg</span> = <span class="synIdentifier">@_</span>;

    <span class="synStatement">my</span> <span class="synIdentifier">$src</span>       =    <span class="synIdentifier">$arg{</span><span class="synString">text</span><span class="synIdentifier">}</span>  // <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$pos</span>       =    <span class="synIdentifier">$arg{</span><span class="synString">pos</span><span class="synIdentifier">}</span>   // <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$start_pos</span> =    <span class="synIdentifier">$arg{</span><span class="synString">start</span><span class="synIdentifier">}</span> // <span class="synNumber">0</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">@heatmap</span>   = <span class="synIdentifier">@{</span><span class="synperlVarBlock"> </span><span class="synIdentifier">$arg{</span><span class="synString">heat</span><span class="synIdentifier">}</span><span class="synperlVarBlock">  // [] </span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$ws_colour</span> =    <span class="synIdentifier">$arg{</span><span class="synString">ws_colour</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$window</span>    =   !<span class="synIdentifier">$arg{</span><span class="synString">no_window</span><span class="synIdentifier">}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$marker</span>    =   <span class="synIdentifier">$arg{</span><span class="synString">marker</span><span class="synIdentifier">}</span>;

    <span class="synComment"># Extend heatmap and marker to length of text...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">@heatmap</span>) {
        <span class="synStatement">push</span> <span class="synIdentifier">@heatmap</span>, (<span class="synNumber">0</span>) x (<span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) - <span class="synIdentifier">@heatmap</span>);
    }
    <span class="synConditional">if</span> (<span class="synIdentifier">$marker</span>) {
        <span class="synIdentifier">$marker</span> .= <span class="synString">q{ }</span> x (<span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) - <span class="synStatement">length</span>(<span class="synIdentifier">$marker</span>));
    }

    <span class="synComment"># Crop to window, if necessary...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">$window</span>) {

        <span class="synComment"># How big is the space we have to fill???</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$window_width</span> = <span class="synIdentifier">$MAX_WIDTH</span> - <span class="synNumber">2</span>; <span class="synComment"># ...allow 2 chars for delimiters</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$mid_window</span> = <span class="synIdentifier">$MAX_WIDTH</span>/<span class="synNumber">2</span>;

        <span class="synComment"># Only modify values if content longer than window...</span>
        <span class="synConditional">if</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) &gt; <span class="synIdentifier">$window_width</span>) {
            <span class="synComment"># At the start of the string, chop off the end...</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$pos</span> &lt;= <span class="synIdentifier">$mid_window</span>) {
                <span class="synConditional">if</span> (<span class="synIdentifier">$marker</span>) {
                    <span class="synIdentifier">$marker</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$marker</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$window_width</span>);
                }
                <span class="synIdentifier">$src</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>, <span class="synNumber">0</span>, <span class="synIdentifier">$window_width</span>);
                <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>,-<span class="synNumber">3</span>,<span class="synNumber">3</span>,<span class="synString">q{...}</span>);
            }
            <span class="synComment"># At the end of the string, chop off the start...</span>
            <span class="synConditional">elsif</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) - <span class="synIdentifier">$pos</span> &lt; <span class="synIdentifier">$mid_window</span>) {
                <span class="synIdentifier">$pos</span>       = <span class="synIdentifier">$window_width</span> - <span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) + <span class="synIdentifier">$pos</span>;
                <span class="synIdentifier">$start_pos</span> = <span class="synIdentifier">$window_width</span> - <span class="synStatement">length</span>(<span class="synIdentifier">$src</span>) + <span class="synIdentifier">$start_pos</span>;
                <span class="synConditional">if</span> (<span class="synIdentifier">@heatmap</span>) {
                    <span class="synIdentifier">@heatmap</span> = <span class="synIdentifier">@heatmap[</span><span class="synStatement">length</span><span class="synperlVarMember">(</span><span class="synIdentifier">$src</span><span class="synperlVarMember">)-</span><span class="synIdentifier">$window_width</span><span class="synperlVarMember">..</span><span class="synIdentifier">$#heatmap]</span>;
                }
                <span class="synConditional">if</span> (<span class="synIdentifier">$marker</span>) {
                    <span class="synIdentifier">$marker</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$marker</span>, <span class="synStatement">length</span>(<span class="synIdentifier">$src</span>)-<span class="synIdentifier">$window_width</span>, <span class="synIdentifier">$window_width</span>);
                }
                <span class="synIdentifier">$src</span>       = <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>, -<span class="synIdentifier">$window_width</span>);
                <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>,<span class="synNumber">0</span>,<span class="synNumber">3</span>,<span class="synString">q{...}</span>);
            }
            <span class="synComment"># In the middle of the string, centre the window on the position...</span>
            <span class="synConditional">else</span> {
                <span class="synIdentifier">$src</span>        = <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>, <span class="synIdentifier">$pos</span>-<span class="synIdentifier">$mid_window</span>+<span class="synNumber">1</span>, <span class="synIdentifier">$window_width</span>);
                <span class="synConditional">if</span> (<span class="synIdentifier">@heatmap</span>) {
                    <span class="synIdentifier">@heatmap</span>= <span class="synStatement">splice</span>(<span class="synIdentifier">@heatmap</span>, <span class="synIdentifier">$pos</span>-<span class="synIdentifier">$mid_window</span>+<span class="synNumber">1</span>, <span class="synIdentifier">$window_width</span>);
                }
                <span class="synConditional">if</span> (<span class="synIdentifier">$marker</span>) {
                    <span class="synIdentifier">$marker</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$marker</span>, <span class="synIdentifier">$pos</span>-<span class="synIdentifier">$mid_window</span>+<span class="synNumber">1</span>, <span class="synIdentifier">$window_width</span>);
                }
                <span class="synIdentifier">$start_pos</span> -= <span class="synIdentifier">$pos</span>;
                <span class="synIdentifier">$pos</span>        = <span class="synIdentifier">$window_width</span>/<span class="synNumber">2</span>;
                <span class="synIdentifier">$start_pos</span> += <span class="synIdentifier">$pos</span>;
                <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>,<span class="synNumber">0</span>,<span class="synNumber">3</span>,<span class="synString">q{...}</span>);
                <span class="synStatement">substr</span>(<span class="synIdentifier">$src</span>,-<span class="synNumber">3</span>,<span class="synNumber">3</span>,<span class="synString">q{...}</span>);
            }
        }
    }

    <span class="synComment"># Convert to heatmap, if requested...</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">@heatmap</span>) {
        <span class="synIdentifier">$src</span> = _build_heatmap(<span class="synIdentifier">$src</span>, \<span class="synIdentifier">@heatmap</span>);
    }
    <span class="synConditional">elsif</span> (<span class="synIdentifier">$ws_colour</span>) {
        <span class="synIdentifier">$src</span> = _ws_colourer(<span class="synIdentifier">$src</span>);
    }

    <span class="synComment"># Trim trailing whitespace from marker...</span>
    <span class="synRepeat">while</span> (<span class="synIdentifier">$marker</span> &amp;&amp; <span class="synStatement">substr</span>(<span class="synIdentifier">$marker</span>,-<span class="synNumber">1</span>) <span class="synOperator">eq</span> <span class="synString">q{ }</span>) {
        <span class="synStatement">substr</span>(<span class="synIdentifier">$marker</span>, -<span class="synNumber">1</span>) = <span class="synString">q{}</span>;
    }

    <span class="synStatement">return</span> (<span class="synIdentifier">$src</span>, <span class="synIdentifier">$pos</span>, max(<span class="synIdentifier">$start_pos</span>,<span class="synNumber">0</span>), <span class="synIdentifier">$marker</span>);
}

<span class="synComment"># Colour message appropriately...</span>
<span class="synKeyword">sub </span><span class="synFunction">_fail_colourer  </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$ws_colouring</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$colourer</span> = <span class="synIdentifier">$ws_colouring</span> ? \<span class="synIdentifier">&amp;_ws_colourer</span> : \<span class="synIdentifier">&amp;</span><span class="synType">Term::ANSIColor::</span><span class="synIdentifier">colored</span>;
    <span class="synStatement">return</span> <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">fail_col</span><span class="synIdentifier">}</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">_info_colourer  </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$ws_colouring</span>) = <span class="synIdentifier">@_</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$colourer</span> = <span class="synIdentifier">$ws_colouring</span> ? \<span class="synIdentifier">&amp;_ws_colourer</span> : \<span class="synIdentifier">&amp;</span><span class="synType">Term::ANSIColor::</span><span class="synIdentifier">colored</span>;
    <span class="synStatement">return</span> <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">info_col</span><span class="synIdentifier">}</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">_try_colourer </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$extras</span>, <span class="synIdentifier">$ws_colouring</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$extras</span> //= <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$colourer</span> = <span class="synIdentifier">$ws_colouring</span> ? \<span class="synIdentifier">&amp;_ws_colourer</span> : \<span class="synIdentifier">&amp;</span><span class="synType">Term::ANSIColor::</span><span class="synIdentifier">colored</span>;
    <span class="synStatement">return</span> <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$str</span>, <span class="synString">&quot;</span><span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">try_col</span><span class="synIdentifier">}</span><span class="synString"> </span><span class="synIdentifier">$extras</span><span class="synString">&quot;</span>);
}

<span class="synKeyword">sub </span><span class="synFunction">_match_colourer </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$extras</span>, <span class="synIdentifier">$ws_colouring</span>) = <span class="synIdentifier">@_</span>;
    <span class="synIdentifier">$extras</span> //= <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$colourer</span> = <span class="synIdentifier">$ws_colouring</span> ? \<span class="synIdentifier">&amp;_ws_colourer</span> : \<span class="synIdentifier">&amp;</span><span class="synType">Term::ANSIColor::</span><span class="synIdentifier">colored</span>;
    <span class="synStatement">return</span> <span class="synIdentifier">$colourer</span>-&gt;(<span class="synIdentifier">$str</span>, <span class="synString">&quot;</span><span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">match_col</span><span class="synIdentifier">}</span><span class="synString"> </span><span class="synIdentifier">$extras</span><span class="synString">&quot;</span>);
}

<span class="synStatement">my</span> <span class="synIdentifier">%DISPLAY_FOR</span> = (
    <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> =&gt; <span class="synString">'n'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\t</span><span class="synString">&quot;</span> =&gt; <span class="synString">'t'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\r</span><span class="synString">&quot;</span> =&gt; <span class="synString">'r'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\f</span><span class="synString">&quot;</span> =&gt; <span class="synString">'f'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\b</span><span class="synString">&quot;</span> =&gt; <span class="synString">'b'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\a</span><span class="synString">&quot;</span> =&gt; <span class="synString">'a'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\e</span><span class="synString">&quot;</span> =&gt; <span class="synString">'e'</span>,
    <span class="synString">&quot;</span><span class="synSpecial">\0</span><span class="synString">&quot;</span> =&gt; <span class="synString">'0'</span>,
);

<span class="synKeyword">sub </span><span class="synFunction">_ws_colourer </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$str</span>, <span class="synIdentifier">$colour_scheme</span>) = <span class="synIdentifier">@_</span>;

    <span class="synComment"># How to colour the text...</span>
    <span class="synIdentifier">$colour_scheme</span> //= <span class="synString">'clear'</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$ws_colour_scheme</span> = <span class="synString">&quot;</span><span class="synIdentifier">$colour_scheme</span><span class="synString"> </span><span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">ws_col</span><span class="synIdentifier">}</span><span class="synString">&quot;</span>;

    <span class="synComment"># Accumulate the text...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$coloured_str</span> = <span class="synString">q{}</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$prefix</span> = <span class="synString">q{}</span>;

    <span class="synComment"># Step through char-by-char...</span>
<span class="synLabel">    CHAR:</span>
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$n</span> (<span class="synFloat">0.</span>.<span class="synStatement">length</span>(<span class="synIdentifier">$str</span>)-<span class="synNumber">1</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$char</span> = <span class="synStatement">substr</span>(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$n</span>, <span class="synNumber">1</span>);

        <span class="synComment"># If it's special, handle it...</span>
        <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$special_char</span> (<span class="synStatement">keys</span> <span class="synIdentifier">%DISPLAY_FOR</span>) {
            <span class="synConditional">if</span> (<span class="synIdentifier">$char</span> <span class="synOperator">eq</span> <span class="synIdentifier">$special_char</span>) {
                <span class="synConditional">if</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$prefix</span>)) {
                    <span class="synIdentifier">$coloured_str</span> .= Term::ANSIColor::colored(<span class="synIdentifier">$prefix</span>, <span class="synIdentifier">$colour_scheme</span>);
                    <span class="synIdentifier">$prefix</span> = <span class="synString">q{}</span>;
                }
                <span class="synIdentifier">$coloured_str</span> .= Term::ANSIColor::colored(<span class="synIdentifier">$DISPLAY_FOR{$special_char}</span>, <span class="synIdentifier">$ws_colour_scheme</span>);
                <span class="synStatement">next</span> CHAR;
            }
        }

        <span class="synComment"># Otherwise, accumulate it...</span>
        <span class="synIdentifier">$prefix</span> .= <span class="synIdentifier">$char</span>;
    }

    <span class="synComment"># Clean up any remaining text...</span>
    <span class="synConditional">if</span> (<span class="synStatement">length</span>(<span class="synIdentifier">$prefix</span>)) {
        <span class="synIdentifier">$coloured_str</span> .= Term::ANSIColor::colored(<span class="synIdentifier">$prefix</span>, <span class="synIdentifier">$colour_scheme</span>);
    }

    <span class="synStatement">return</span> <span class="synIdentifier">$coloured_str</span>;
}

<span class="synKeyword">sub </span><span class="synFunction">_colourer_for </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$msg</span> = <span class="synStatement">shift</span>;

    <span class="synConditional">if</span> (<span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'forgetting'</span>) &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'Forgetting'</span>) &gt;= <span class="synNumber">0</span>) {
        <span class="synStatement">return</span> \<span class="synIdentifier">&amp;_info_colourer</span>;
    }
    <span class="synConditional">if</span> (<span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'try'</span>) &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'Try'</span>) &gt;= <span class="synNumber">0</span>) {
        <span class="synStatement">return</span> \<span class="synIdentifier">&amp;_try_colourer</span>;
    }
    <span class="synConditional">if</span> (<span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'failed'</span>) &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'Failed'</span>) &gt;= <span class="synNumber">0</span>) {
        <span class="synStatement">return</span> \<span class="synIdentifier">&amp;_fail_colourer</span>;
    }
    <span class="synConditional">if</span> (<span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'matched'</span>) &gt;= <span class="synNumber">0</span> || <span class="synStatement">index</span>(<span class="synIdentifier">$msg</span>,<span class="synString">'Matched'</span>) &gt;= <span class="synNumber">0</span>) {
        <span class="synStatement">return</span> \<span class="synIdentifier">&amp;_match_colourer</span>;
    }
    <span class="synStatement">return</span> \<span class="synIdentifier">&amp;_info_colourer</span>;
}

<span class="synComment"># Set up interaction as spiffily as possible...</span>

<span class="synConditional">if</span> (<span class="synStatement">eval</span>{ <span class="synStatement">require</span> Term::ReadKey }) {
    *_interact = <span class="synKeyword">sub </span>{
        <span class="synComment"># No interactions when piping output to a filehandle...</span>
        <span class="synStatement">return</span> <span class="synString">'c'</span> <span class="synConditional">if</span> <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>;

        <span class="synComment"># Otherwise grab a single key and return it...</span>
        Term::ReadKey::ReadMode(<span class="synString">'raw'</span>);
        <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = Term::ReadKey::ReadKey(<span class="synNumber">0</span>);
        Term::ReadKey::ReadMode(<span class="synString">'restore'</span>);
        <span class="synStatement">return</span> <span class="synIdentifier">$input</span>;
    }
}
<span class="synConditional">else</span> {
    *_interact = <span class="synKeyword">sub </span>{
        <span class="synComment"># No interactions when piping output to a filehandle...</span>
        <span class="synStatement">return</span> <span class="synString">'c'</span> <span class="synConditional">if</span> <span class="synIdentifier">$lexical_config-&gt;{</span><span class="synString">save_to_fh</span><span class="synIdentifier">}</span>;

        <span class="synComment"># Otherwise return the first letter typed...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = <span class="synStatement">readline</span>;
        <span class="synStatement">return</span> <span class="synStatement">substr</span>(<span class="synIdentifier">$input</span>, <span class="synNumber">0</span>, <span class="synNumber">1</span>);
    }
}


<span class="synComment">#====[ REPL (a.k.a. rxrx) ]=======================</span>

<span class="synComment"># Deal with v5.16 weirdness...</span>
<span class="synPreProc">BEGIN </span>{
    <span class="synConditional">if</span> (<span class="synIdentifier">$]</span> &gt;= <span class="synFloat">5.016</span>) {
        <span class="synStatement">require</span> feature;
        feature-&gt;<span class="synStatement">import</span>(<span class="synString">'evalbytes'</span>);
        *evaluate = \<span class="synIdentifier">&amp;</span><span class="synType">CORE::</span><span class="synIdentifier">evalbytes</span>;
    }
    <span class="synConditional">else</span> {
        *evaluate = <span class="synKeyword">sub</span>{ <span class="synStatement">eval</span> <span class="synStatement">shift</span> };
    }
}

<span class="synStatement">my</span> <span class="synIdentifier">$FROM_START</span> = <span class="synNumber">0</span>;

<span class="synKeyword">sub </span><span class="synFunction">rxrx </span>{
    <span class="synComment"># Handle: rxrx &lt;filename&gt;</span>
    <span class="synConditional">if</span> (<span class="synIdentifier">@_</span>) {
        <span class="synStatement">local</span> <span class="synIdentifier">@ARGV</span> = <span class="synIdentifier">@_</span>;

        <span class="synComment"># If file is a debugger dump, decode and step through it...</span>
        <span class="synStatement">my</span> <span class="synIdentifier">$filetext</span> = <span class="synOperator">do</span> { <span class="synStatement">local</span> <span class="synIdentifier">$/</span>; &lt;&gt; };
        <span class="synStatement">my</span> <span class="synIdentifier">$dumped_data</span> = <span class="synStatement">eval</span> { <span class="synIdentifier">$JSON_decoder</span>-&gt;(<span class="synIdentifier">$filetext</span>) };
        <span class="synConditional">if</span> (<span class="synOperator">ref</span>(<span class="synIdentifier">$dumped_data</span>) <span class="synOperator">eq</span> <span class="synString">'HASH'</span> &amp;&amp; <span class="synOperator">defined</span> <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">regex_ID</span><span class="synIdentifier">}</span> ) {
            <span class="synComment"># Reconstruct internal state...</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$regex_ID</span>                = <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">regex_ID</span><span class="synIdentifier">}</span>;
            <span class="synIdentifier">%history_of</span>                 = <span class="synIdentifier">%{</span><span class="synperlVarBlock2"> </span><span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">visualization</span><span class="synIdentifier">}</span><span class="synperlVarBlock2"> </span><span class="synIdentifier">}</span>;
            <span class="synIdentifier">$history_of{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span>  = <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">match_heatmap</span><span class="synIdentifier">}</span>;
            <span class="synIdentifier">$history_of{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">string_heatmap</span><span class="synIdentifier">}</span>;
            <span class="synIdentifier">$display_mode</span>               = <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">config</span><span class="synIdentifier">}{</span><span class="synString">display_mode</span><span class="synIdentifier">}</span>;
            <span class="synIdentifier">$state{$regex_ID}{</span><span class="synString">location</span><span class="synIdentifier">}</span> = <span class="synIdentifier">$dumped_data-&gt;{</span><span class="synString">regex_location</span><span class="synIdentifier">}</span>;

            <span class="synComment"># Display...</span>
            <span class="synStatement">my</span> <span class="synIdentifier">$step</span> = <span class="synIdentifier">$FROM_START</span>;
            <span class="synStatement">my</span> <span class="synIdentifier">$cmd</span>;
            <span class="synRepeat">while</span> (<span class="synNumber">1</span>) {
                (<span class="synIdentifier">$cmd</span>, <span class="synIdentifier">$step</span>) = _revisualize(<span class="synIdentifier">$regex_ID</span>, <span class="synIdentifier">$step</span>);
                <span class="synStatement">last</span> <span class="synConditional">if</span> <span class="synIdentifier">$cmd</span> =~ <span class="synStatement">/</span><span class="synSpecial">[q]</span><span class="synStatement">/i</span>;
                <span class="synIdentifier">$step</span> = min(<span class="synIdentifier">$step</span>, <span class="synIdentifier">@{$history_of{</span><span class="synString">visual</span><span class="synIdentifier">}}</span>-<span class="synNumber">1</span>);
            }
            <span class="synStatement">exit</span>;
        }

        <span class="synComment"># Otherwise, assume it's a perl source file and debug it...</span>
        <span class="synConditional">else</span> {
            <span class="synStatement">exec</span> <span class="synIdentifier">$^X</span>, <span class="synString">'-MRegexp::Debugger'</span>, <span class="synIdentifier">@_</span>
                <span class="synOperator">or</span> <span class="synStatement">die</span> <span class="synString">&quot;Couldn't invoke perl: </span><span class="synIdentifier">$!</span><span class="synString">&quot;</span>;
        }
    }

    <span class="synComment"># Otherwise, be interactive...</span>

    <span class="synComment"># Track input history...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$str_history</span>   = [];
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_history</span> = [];

    <span class="synComment"># Start with empty data...</span>
    <span class="synStatement">my</span> <span class="synIdentifier">$input_regex</span> = <span class="synString">''</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$regex</span>       = <span class="synString">''</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$regex_flags</span> = <span class="synString">''</span>;
    <span class="synStatement">my</span> <span class="synIdentifier">$string</span>      = <span class="synString">''</span>;

    <span class="synComment"># And display it...</span>
    _display(<span class="synIdentifier">$string</span>, <span class="synIdentifier">$input_regex</span>,<span class="synString">q{}</span>);

<span class="synLabel">    INPUT:</span>
    <span class="synRepeat">while</span> (<span class="synNumber">1</span>) {
        <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = _prompt(<span class="synString">'&gt;'</span>);

        <span class="synComment"># String history mode?</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> =~ <span class="synStatement">/</span><span class="synString">^</span><span class="synSpecial">['&quot;]</span><span class="synString">$</span><span class="synStatement">/</span>) {
            <span class="synIdentifier">$input</span> = _rxrx_history(<span class="synIdentifier">$str_history</span>);
        }

        <span class="synComment"># Regex history mode?</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> <span class="synOperator">eq</span> <span class="synString">'/'</span>) {
            <span class="synIdentifier">$input</span> = _rxrx_history(<span class="synIdentifier">$regex_history</span>);
        }

        <span class="synComment"># Are we updating the regex or string???</span>
        <span class="synConditional">if</span> (<span class="synIdentifier">$input</span> =~ <span class="synStatement">m{</span><span class="synString">^ </span><span class="synSpecial">(?</span><span class="synString">&lt;cmd&gt; </span><span class="synSpecial">[/&quot;'])</span><span class="synString">  </span><span class="synSpecial">(?</span><span class="synString">&lt;data&gt; </span><span class="synSpecial">.*?)</span><span class="synString"> </span><span class="synSpecial">(?</span><span class="synString">&lt;endcmd&gt; </span><span class="synSpecial">\k&lt;cmd&gt;</span><span class="synString"> </span><span class="synSpecial">(?</span><span class="synString">&lt;flags&gt; </span><span class="synSpecial">[imsxlaud]*)</span><span class="synString"> </span><span class="synSpecial">)?</span><span class="synString"> </span><span class="synSpecial">\s*</span><span class="synString">  </span><span class="synSpecial">\z</span><span class="synString"> </span><span class="synStatement">}x</span>) {

            <span class="synComment"># Compile and save the new regex...</span>
            <span class="synConditional">if</span> (<span class="synIdentifier">$+</span>{cmd} <span class="synOperator">eq</span> <span class="synString">q{/}</span>) {
                <span class="synConditional">if</span> (<span class="synIdentifier">$+</span>{data} <span class="synOperator">eq</span> <span class="synString">q{}</span>) {
                    <span class="synStatement">state</span> <span class="synIdentifier">$NULL_REGEX</span> = <span class="synStatement">eval</span> <span class="synString">q{use Regexp::Debugger; qr{(?#NULL)}; }</span>;
                    <span class="synIdentifier">$regex</span> = <span class="synIdentifier">$NULL_REGEX</span>;
                }
                <span class="synConditional">else</span> {
                    <span class="synIdentifier">$input_regex</span> = <span class="synIdentifier">$+</span>{data};
                    <span class="synIdentifier">$regex_flags</span> = <span class="synIdentifier">$+</span>{flags} // <span class="synString">'x'</span>;
                    <span class="synIdentifier">$regex</span> = evaluate <span class="synString">qq{</span><span class="synSpecial">\n</span><span class="synString"># line 0 rxrx</span><span class="synSpecial">\n</span><span class="synString">use Regexp::Debugger; qr{</span><span class="synIdentifier">$+</span><span class="synString">{data}}</span><span class="synIdentifier">$regex_flags</span><span class="synString">;}</span>;
                }

                <span class="synComment"># Report any errors...</span>
                <span class="synStatement">print</span> <span class="synString">&quot;</span><span class="synIdentifier">$@</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> <span class="synIdentifier">$@</span>;
                <span class="synStatement">print</span> <span class="synString">&quot;Invalid input</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> !<span class="synOperator">defined</span> <span class="synIdentifier">$regex</span>;

                <span class="synComment"># Remember it...</span>
                <span class="synStatement">push</span> <span class="synIdentifier">@{$regex_history}</span>, <span class="synIdentifier">$input</span>;
            }

            <span class="synComment"># Otherwise compile the string (interpolated or not)...</span>
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$+</span>{cmd} <span class="synOperator">eq</span> <span class="synString">q{&quot;}</span>) {
                <span class="synIdentifier">$string</span> = evaluate <span class="synString">qq{&quot;</span><span class="synIdentifier">$+</span><span class="synString">{data}&quot;}</span>;

                <span class="synComment"># Report any errors...</span>
                <span class="synStatement">print</span> <span class="synString">&quot;</span><span class="synIdentifier">$@</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> <span class="synIdentifier">$@</span>;
                <span class="synStatement">print</span> <span class="synString">&quot;Invalid input</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> !<span class="synOperator">defined</span> <span class="synIdentifier">$string</span>;

                <span class="synComment"># Remember it...</span>
                <span class="synStatement">push</span> <span class="synIdentifier">@{$str_history}</span>, <span class="synIdentifier">$input</span>;
            }
            <span class="synConditional">elsif</span> (<span class="synIdentifier">$+</span>{cmd} <span class="synOperator">eq</span> <span class="synString">q{'}</span>) {
                <span class="synIdentifier">$string</span> = evaluate <span class="synString">qq{'</span><span class="synIdentifier">$+</span><span class="synString">{data}'}</span>;

                <span class="synComment"># Report any errors...</span>
                <span class="synStatement">print</span> <span class="synString">&quot;</span><span class="synIdentifier">$@</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> <span class="synIdentifier">$@</span>;
                <span class="synStatement">print</span> <span class="synString">&quot;Invalid input</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> <span class="synConditional">if</span> !<span class="synOperator">defined</span> <span class="synIdentifier">$string</span>;

                <span class="synComment"># Remember it...</span>
                <span class="synStatement">push</span> <span class="synIdentifier">@{$str_history}</span>, <span class="synIdentifier">$input</span>;
            }
        }

        <span class="synComment"># Quit if quitting requested...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> =~ <span class="synStatement">/</span><span class="synString">^ </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">[xXqQ]</span><span class="synStatement">/x</span>) {
            <span class="synStatement">say</span> <span class="synString">q{}</span>;
            <span class="synStatement">last</span> INPUT;
        }

        <span class="synComment"># Help...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> =~ <span class="synStatement">/</span><span class="synString">^ </span><span class="synSpecial">\s*</span><span class="synString"> </span><span class="synSpecial">[?hH]</span><span class="synStatement">/x</span>) {
            <span class="synStatement">print</span> <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> x <span class="synNumber">2</span>;
            <span class="synStatement">say</span> <span class="synString">'____________________________________________/ Help \____'</span>;
            <span class="synStatement">say</span> <span class="synString">'                                         '</span>;
            <span class="synStatement">say</span> <span class="synString">'     / : Enter a pattern'</span>;
            <span class="synStatement">say</span> <span class="synString">&quot;     ' : Enter a new literal string&quot;</span>;
            <span class="synStatement">say</span> <span class="synString">'     &quot; : Enter a new double-quoted string'</span>;
            <span class="synConditional">if</span> (<span class="synStatement">eval</span> { <span class="synStatement">require</span> IO::Prompter }) {
                <span class="synStatement">say</span> <span class="synString">''</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-R : History completion - move backwards one input'</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-N : History completion - move forwards one input'</span>;
                <span class="synStatement">say</span> <span class="synString">''</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-B : Cursor motion - move back one character'</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-F : Cursor motion - move forwards one character'</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-A : Cursor motion - move to start of input'</span>;
                <span class="synStatement">say</span> <span class="synString">'CTRL-E : Cursor motion - move to end of input'</span>;
            }
            <span class="synStatement">say</span> <span class="synString">''</span>;
            <span class="synStatement">say</span> <span class="synString">'     m : Match current string against current pattern'</span>;
            <span class="synStatement">say</span> <span class="synString">''</span>;
            <span class="synStatement">say</span> <span class="synString">'q or x : quit debugger and exit'</span>;
            <span class="synStatement">next</span> INPUT;
        }

        <span class="synComment"># Visualize the match...</span>
        <span class="synConditional">elsif</span> (<span class="synIdentifier">$input</span> =~ <span class="synStatement">/</span><span class="synString">m</span><span class="synStatement">/i</span>) {
            <span class="synIdentifier">$string</span> =~ <span class="synIdentifier">$regex</span>;
        }

        <span class="synComment"># Redisplay the new regex and/or string...</span>
        <span class="synConditional">if</span> (<span class="synOperator">defined</span> <span class="synIdentifier">$string</span> &amp;&amp; <span class="synOperator">defined</span> <span class="synIdentifier">$input_regex</span>) {
            _display(<span class="synIdentifier">$string</span>, <span class="synIdentifier">$input_regex</span>, <span class="synIdentifier">$regex_flags</span>);
        }
    }
}

<span class="synComment"># Lay out the regex and string as does Regexp::Debugger...</span>
<span class="synKeyword">sub </span><span class="synFunction">_display </span>{
    <span class="synStatement">my</span> (<span class="synIdentifier">$string</span>, <span class="synIdentifier">$regex</span>, <span class="synIdentifier">$flags</span>) = <span class="synIdentifier">@_</span>;

    <span class="synStatement">say</span> <span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span> x <span class="synNumber">100</span>;
    <span class="synStatement">say</span> Term::ANSIColor::colored(<span class="synString">'regex:'</span>, <span class="synString">'white'</span>);
    <span class="synStatement">say</span> <span class="synString">qq{/</span><span class="synIdentifier">$regex</span><span class="synString">/</span><span class="synIdentifier">$flags</span><span class="synSpecial">\n\n\n</span><span class="synString">}</span>;
    <span class="synStatement">say</span> Term::ANSIColor::colored(<span class="synString">'string:'</span>, <span class="synString">'white'</span>);
    <span class="synStatement">say</span> <span class="synString">q{'}</span> . _ws_colourer(<span class="synIdentifier">$string</span>) . <span class="synString">qq{'</span><span class="synSpecial">\n\n\n</span><span class="synString">}</span>;
}


<span class="synComment"># Make whitespace characters visible (without using a regex)...</span>
<span class="synKeyword">sub </span><span class="synFunction">_quote_ws </span>{
    <span class="synStatement">my</span> <span class="synIdentifier">$str</span> = <span class="synStatement">shift</span>;

    <span class="synStatement">my</span> <span class="synIdentifier">$index</span>;
    <span class="synRepeat">for</span> <span class="synStatement">my</span> <span class="synIdentifier">$ws_char</span> ( [<span class="synString">&quot;</span><span class="synSpecial">\n</span><span class="synString">&quot;</span>=&gt;<span class="synString">'\n'</span>], [<span class="synString">&quot;</span><span class="synSpecial">\t</span><span class="synString">&quot;</span>=&gt;<span class="synString">'\n'</span>] ) {
<span class="synLabel">        SEARCH:</span>
        <span class="synRepeat">while</span> (<span class="synNumber">1</span>) {
            <span class="synIdentifier">$index</span> = <span class="synStatement">index</span>(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$ws_char-&gt;[</span><span class="synNumber">0</span><span class="synIdentifier">]</span>);
            <span class="synStatement">last</span> SEARCH <span class="synConditional">if</span> <span class="synIdentifier">$index</span> &lt; <span class="synNumber">0</span>;
            <span class="synStatement">substr</span>(<span class="synIdentifier">$str</span>, <span class="synIdentifier">$index</span>, <span class="synNumber">1</span>, <span class="synIdentifier">$ws_char-&gt;[</span><span class="synNumber">1</span><span class="synIdentifier">]</span>);
        }
    }

    <span class="synStatement">return</span> <span class="synIdentifier">$str</span>;
}

<span class="synComment"># Hi-res sleep...</span>
<span class="synKeyword">sub </span><span class="synFunction">_pause </span>{
    <span class="synStatement">select</span> <span class="synOperator">undef</span>, <span class="synOperator">undef</span>, <span class="synOperator">undef</span>, <span class="synStatement">shift</span>;
}

<span class="synComment"># Simple prompter...</span>
*_prompt = <span class="synStatement">eval</span> { <span class="synStatement">require</span> IO::Prompter }
    ? <span class="synKeyword">sub </span>{
            <span class="synStatement">return</span> IO::Prompter::prompt(<span class="synIdentifier">@_</span>)
      }
    : <span class="synKeyword">sub </span>{
            <span class="synStatement">my</span> (<span class="synIdentifier">$prompt</span>) = <span class="synIdentifier">@_</span>;

            <span class="synStatement">print</span> <span class="synString">&quot;</span><span class="synIdentifier">$prompt</span><span class="synString"> &quot;</span>;
            <span class="synStatement">my</span> <span class="synIdentifier">$input</span> = <span class="synStatement">readline</span> *STDIN;
            <span class="synStatement">chomp</span> <span class="synIdentifier">$input</span>;
            <span class="synStatement">return</span> <span class="synIdentifier">$input</span>;
      };


<span class="synNumber">1</span>; <span class="synComment"># Magic true value required at end of module</span>
<span class="synComment">__END__</span>

<span class="synStatement">=head1</span><span class="synString"> NAME</span>

<span class="synperlPOD">Regexp::Debugger - Visually debug regexes in-place</span>


<span class="synStatement">=head1</span><span class="synString"> VERSION</span>

<span class="synperlPOD">This document describes Regexp::Debugger version 0.001016</span>


<span class="synStatement">=head1</span><span class="synString"> SYNOPSIS</span>

<span class="synPreProc">    use Regexp::Debugger;</span>


<span class="synStatement">=head1</span><span class="synString"> DESCRIPTION</span>

<span class="synperlPOD">When you load this module, any regex in the same lexical scope will be visually</span>
<span class="synperlPOD">(and interactively) debugged as it matches.</span>


<span class="synStatement">=head1</span><span class="synString"> INTERFACE</span>

<span class="synperlPOD">The module itself provides no API.</span>
<span class="synperlPOD">You load it and the debugger is automatically</span>
<span class="synperlPOD">activated in that lexical scope.</span>

<span class="synperlPOD">The debugger offers the following commands:</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;?&gt;</span>

<span class="synperlPOD">: Print a help message listing these commands</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;s&gt;</span>

<span class="synperlPOD">: Step forwards</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;-&gt;</span>

<span class="synperlPOD">: Step backwards</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;m&gt;</span>

<span class="synperlPOD">: Continue forward to the next event that matches something</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;f&gt;</span>

<span class="synperlPOD">: Continue forward to the next event that fails to match something</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;c&gt;</span>

<span class="synperlPOD">: Continue forward until the regex matches or completely backtracks</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; &lt;RETURN&gt;/&lt;ENTER&gt; &gt;&gt;</span>

<span class="synperlPOD">: Repeat the previous command</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;v&gt;</span>

<span class="synperlPOD">: Switch to visualization mode</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;h&gt;</span>

<span class="synperlPOD">: Switch to heatmapped visualization log</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;e&gt;</span>

<span class="synperlPOD">: Switch to the event log</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;j&gt;</span>

<span class="synperlPOD">: Switch to the underlying JSON data</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;d&gt;</span>

<span class="synperlPOD">: Describe each component of the regex in detail</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;V&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;H&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;H&gt;</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;J&gt;</span>

<span class="synperlPOD">: Take a snapshot of the corresponding display mode.</span>

<span class="synperlPOD">When prompted for a filename:</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; &lt;RET&gt; &gt;&gt;</span>

<span class="synperlPOD">...prints the snapshot to the terminal</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; &lt;TAB&gt; &gt;&gt;</span>

<span class="synperlPOD">...prints the snapshot to a file named &quot;./rxrx_</span><span class="synIdentifier">I&lt;DISPLAY_MODE&gt;</span><span class="synperlPOD">_</span><span class="synIdentifier">I&lt;TIMESTAMP&gt;</span><span class="synperlPOD">&quot;</span>

<span class="synStatement">=item</span><span class="synString"> Anything else</span>

<span class="synperlPOD">...prints the snapshot to that file</span>

<span class="synStatement">=back</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;q&gt;</span>

<span class="synperlPOD">: Quit the debugger and finish matching this regex without any further</span>
<span class="synPreProc">  visualization. The program continues to execute and other regexes may</span>
<span class="synPreProc">  still be debugged.</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;x&gt;</span>

<span class="synperlPOD">: Exit the debugger and the entire program immediately.</span>

<span class="synStatement">=back</span>

<span class="synStatement">=head1</span><span class="synString"> CONFIGURATION</span>

<span class="synperlPOD">You can configure the debugger by setting up a </span><span class="synIdentifier">F&lt;.rxrx&gt;</span><span class="synperlPOD"> file in</span>
<span class="synperlPOD">in the current directory or in your home directory. This configuration</span>
<span class="synperlPOD">consists of </span><span class="synIdentifier">I&lt;key&gt;</span><span class="synperlPOD">:</span><span class="synIdentifier">I&lt;value&gt;</span><span class="synperlPOD"> pairs</span>
<span class="synperlPOD">(everything else in the file is silently ignored).</span>

<span class="synStatement">=head2</span><span class="synString"> Display mode configuration</span>

<span class="synperlPOD">If the </span><span class="synIdentifier">C&lt;C&lt;'display'&gt;&gt;</span><span class="synperlPOD"> key is specified, the debugger starts in that</span>
<span class="synperlPOD">mode. The four available modes are:</span>

<span class="synPreProc">    # Show dynamic visualization of matching (the default)...</span>
<span class="synPreProc">    display : visual</span>

<span class="synPreProc">    # Show dynamic heatmap visualization of matching...</span>
<span class="synPreProc">    display : heatmap</span>

<span class="synPreProc">    # Show multi-line matching event log...</span>
<span class="synPreProc">    display : events</span>

<span class="synPreProc">    # Show JSON encoding of matching process...</span>
<span class="synPreProc">    display : JSON</span>


<span class="synStatement">=head2</span><span class="synString"> Whitespace display configuration</span>

<span class="synperlPOD">Normally, the debugger compacts whitespaces in the regex down to a</span>
<span class="synperlPOD">single space character, but you can configure that with the</span>
<span class="synIdentifier">C&lt;show_ws&gt;</span><span class="synperlPOD"> key:</span>

<span class="synPreProc">    # Compact whitespace and comments to a single space (the default)...</span>
<span class="synPreProc">    show_ws : compact</span>

<span class="synPreProc">    # Compact whitespace, but show comments, newlines (\n), and tabs (\t)...</span>
<span class="synPreProc">    show_ws : visible</span>

<span class="synPreProc">    # Don't compact whitespace, and show newlines and tabs as \n and \t...</span>
<span class="synPreProc">    show_ws : original</span>


<span class="synStatement">=head2</span><span class="synString"> Colour configuration</span>

<span class="synperlPOD">The following keys reconfigure the colours with which the debugger</span>
<span class="synperlPOD">displays various information:</span>

<span class="synStatement">=head3</span><span class="synString"> Colours for debugging information</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;try_col&gt;</span>

<span class="synperlPOD">The colour in which attempts to match part of the regex are reported</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;match_col&gt;</span>

<span class="synperlPOD">The colour in which successful matches of part of the regex are reported</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;fail_col&gt;</span>

<span class="synperlPOD">The colour in which unsuccessful matches of part of the regex are reported</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;ws_col&gt;</span>

<span class="synperlPOD">The colour in which special characters (such as &quot;\n&quot;, &quot;\t&quot;, &quot;\e&quot;, etc.)</span>
<span class="synperlPOD">are reported (as single letters: 'n', 't', 'e', etc.)</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;info_col&gt;</span>

<span class="synperlPOD">The colour in which other information is reported</span>

<span class="synStatement">=back</span>

<span class="synStatement">=head3</span><span class="synString"> Colours for regex descriptions</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;desc_regex_col&gt;</span>

<span class="synperlPOD">The colour in which components of the regex are displayed</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;desc_text_col&gt;</span>

<span class="synperlPOD">The colour in which descriptions of regex components are displayed</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synIdentifier">C&lt;desc_sep_col&gt;</span>

<span class="synperlPOD">The colour in which separators between component descriptions are displayed.</span>

<span class="synStatement">=back</span>

<span class="synStatement">=head3</span><span class="synString"> Colours for heatmaps</span>

<span class="synperlPOD">Any key that starts with </span><span class="synIdentifier">C&lt;heatmap&gt;</span><span class="synperlPOD">... is treated as a specifier for an</span>
<span class="synperlPOD">equal part of the total range of each heatmap.</span>

<span class="synperlPOD">These names are sorted (numerically, if possible; otherwise</span>
<span class="synperlPOD">alphabetically) and the corresponding values are then used to display</span>
<span class="synperlPOD">equal percentiles from the heatmap.</span>

<span class="synperlPOD">For example (using numeric sorting):</span>

<span class="synPreProc">    heatmap_0_colour      : cyan   on_black   #  0-33rd  percentile</span>
<span class="synPreProc">    heatmap_50_colour     : yellow on_black   # 34-66th  percentile</span>
<span class="synPreProc">    heatmap_100_colour    : red    on_black   # 67-100th percentile</span>

<span class="synperlPOD">Or, equivalently (using alphabetic sorting):</span>

<span class="synPreProc">    heatmap_infrequent    : cyan   on_black   #  0-33rd  percentile</span>
<span class="synPreProc">    heatmap_more_frequent : yellow on_black   # 34-66th  percentile</span>
<span class="synPreProc">    heatmap_very_frequent : red    on_black   # 67-100th percentile</span>


<span class="synStatement">=head3</span><span class="synString"> Colour specifications</span>

<span class="synperlPOD">The colour values that may be used in any of the above colour</span>
<span class="synperlPOD">specifications are any combination of the following (i.e. the</span>
<span class="synperlPOD">colour specifiers supported by the Term::ANSIColor module):</span>

<span class="synPreProc">         clear           reset             bold            dark</span>
<span class="synPreProc">         faint           underline         underscore      blink</span>
<span class="synPreProc">         reverse         concealed</span>

<span class="synPreProc">         black           red               green           yellow</span>
<span class="synPreProc">         blue            magenta           cyan            white</span>
<span class="synPreProc">         bright_black    bright_red        bright_green    bright_yellow</span>
<span class="synPreProc">         bright_blue     bright_magenta    bright_cyan     bright_white</span>

<span class="synPreProc">         on_black        on_red            on_green        on_yellow</span>
<span class="synPreProc">         on_blue         on_magenta        on_cyan         on_white</span>
<span class="synPreProc">         on_bright_black on_bright_red     on_bright_green on_bright_yellow</span>
<span class="synPreProc">         on_bright_blue  on_bright_magenta on_bright_cyan  on_bright_white</span>


<span class="synperlPOD">The default colour configurations are:</span>

<span class="synPreProc">    try_col    :  bold magenta  on_black</span>
<span class="synPreProc">    match_col  :  bold cyan     on_black</span>
<span class="synPreProc">    fail_col   :       yellow   on_red</span>
<span class="synPreProc">    ws_col     :  bold blue     underline</span>
<span class="synPreProc">    info_col   :       white    on_black</span>

<span class="synPreProc">    desc_regex_col  :  white    on_black</span>
<span class="synPreProc">    desc_text_col   :  cyan     on_black</span>
<span class="synPreProc">    desc_sep_col    :  blue     on_black underline</span>

<span class="synPreProc">    heatmap__20th_percentile  :  white   on_black</span>
<span class="synPreProc">    heatmap__40th_percentile  :  cyan    on_blue</span>
<span class="synPreProc">    heatmap__60th_percentile  :  blue    on_cyan</span>
<span class="synPreProc">    heatmap__80th_percentile  :  red     on_yellow</span>
<span class="synPreProc">    heatmap_100th_percentile  :  yellow  on_red</span>


<span class="synStatement">=head2</span><span class="synString"> Output configuration</span>

<span class="synperlPOD">Normally Regexp::Debugger sends its visualizations to the terminal</span>
<span class="synperlPOD">and expects input from the same device.</span>

<span class="synperlPOD">However, you can configure the module to output its information</span>
<span class="synperlPOD">(in standard JSON format) to a nominated file instead, using the</span>
<span class="synIdentifier">C&lt;'save_to'&gt;</span><span class="synperlPOD"> option:</span>

<span class="synPreProc">    save_to : filename_to_save_data_to.json</span>

<span class="synperlPOD">Data saved in this way may be re-animated using the </span><span class="synIdentifier">C&lt;rxrx&gt;</span><span class="synperlPOD"> utility,</span>
<span class="synperlPOD">or by calling </span><span class="synIdentifier">C&lt;Regexp::Debugger::rxrx()&gt;</span><span class="synperlPOD"> directly. (See: L&lt;&quot;Command-line</span>
<span class="synperlPOD">debugging&quot;&gt; for details).</span>


<span class="synStatement">=head2</span><span class="synString"> Configuration API</span>

<span class="synperlPOD">You can also configure the debugger on a program-by-program basis, by</span>
<span class="synperlPOD">passing any of the above key/value pairs when the module is loaded.</span>

<span class="synperlPOD">For example:</span>

<span class="synPreProc">    use Regexp::Debugger  fail =&gt; 'bold red',  whitespace =&gt; 'compact';</span>

<span class="synperlPOD">Note that any configuration specified in the user's </span><span class="synIdentifier">F&lt;.rxrx&gt;</span><span class="synperlPOD"> file</span>
<span class="synperlPOD">is overridden by an explicit specification of this type.</span>

<span class="synperlPOD">The commonest use of this mechanism is to dump regex debugging</span>
<span class="synperlPOD">information from an non-interactive program:</span>

<span class="synPreProc">    use Regexp::Debugger  save_to =&gt; 'regex_debugged.json';</span>

<span class="synperlPOD">Note that, when </span><span class="synIdentifier">C&lt;'save_to'&gt;</span><span class="synperlPOD"> is specified within a program, the value</span>
<span class="synperlPOD">supplied does not have to be a string specifying the filename. You can</span>
<span class="synperlPOD">also provide an actual filehandle (or equivalent). For example:</span>

<span class="synPreProc">    use Regexp::Debugger save_to =&gt; IO::Socket::INET-&gt;new(</span>
<span class="synPreProc">                                        Proto     =&gt; &quot;tcp&quot;,</span>
<span class="synPreProc">                                        PeerAddr  =&gt; 'localhost:666',</span>
<span class="synPreProc">                                    );</span>


<span class="synStatement">=head1</span><span class="synString"> COMMAND-LINE DEBUGGING</span>

<span class="synperlPOD">The module provides a non-exported subroutine (</span><span class="synIdentifier">C&lt;rxrx()&gt;</span><span class="synperlPOD">) that</span>
<span class="synperlPOD">implements a useful command-line regex debugging utility.</span>

<span class="synperlPOD">The utility can be invoked with:</span>

<span class="synPreProc">    perl -MRegexp::Debugger -E 'Regexp::Debugger::rxrx\(@ARGV\)'</span>

<span class="synperlPOD">which is usually aliased in the shell to </span><span class="synIdentifier">C&lt;rxrx&gt;</span><span class="synperlPOD"> (and will be referred</span>
<span class="synperlPOD">to by that name hereafter).</span>


<span class="synStatement">=head2</span><span class="synString"> Regex debugging REPL</span>

<span class="synperlPOD">When called without any arguments, </span><span class="synIdentifier">C&lt;rxrx&gt;</span><span class="synperlPOD"> initiates a simple REPL</span>
<span class="synperlPOD">that allows the user to type in regexes and strings and debug matches</span>
<span class="synperlPOD">between them:</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synperlPOD">Any line starting with a </span><span class="synIdentifier">C&lt;/&gt;</span><span class="synperlPOD"> is treated as a new regex to match with.</span>
<span class="synperlPOD">The closing </span><span class="synIdentifier">C&lt;/&gt;</span><span class="synperlPOD"> may be omitted. If the closing </span><span class="synIdentifier">C&lt;/&gt;</span><span class="synperlPOD"> is supplied, any</span>
<span class="synperlPOD">one or more of the following flags may be specified immediately after</span>
<span class="synperlPOD">it: </span><span class="synIdentifier">C&lt;x&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;i&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;m&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;s&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;a&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;u&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;d&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;l&gt;</span><span class="synperlPOD">.</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synperlPOD">Any line starting with a </span><span class="synIdentifier">C&lt;'&gt;</span><span class="synperlPOD"> or </span><span class="synIdentifier">C&lt;&quot;&gt;</span><span class="synperlPOD"> is treated as a new string to match</span>
<span class="synperlPOD">against. The corresponding closing delimiter may be omitted.</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synperlPOD">Any line beginning with </span><span class="synIdentifier">C&lt;m&gt;</span><span class="synperlPOD"> causes the REPL to match the current regex</span>
<span class="synperlPOD">against the current string, visualizing the match in the usual way.</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synperlPOD">Any line beginning with </span><span class="synIdentifier">C&lt;q&gt;</span><span class="synperlPOD"> or </span><span class="synIdentifier">C&lt;x&gt;</span><span class="synperlPOD"> causes the REPL to quit and exit.</span>

<span class="synStatement">=item</span><span class="synString"> *</span>

<span class="synperlPOD">Any line beginning with </span><span class="synIdentifier">C&lt;?&gt;</span><span class="synperlPOD"> invokes the help listing for the REPL.</span>

<span class="synStatement">=back</span>

<span class="synperlPOD">If the IO::Prompter module (version 0.004 or later) is available, the</span>
<span class="synperlPOD">input process remembers its history, which you can recall by typing</span>
<span class="synIdentifier">C&lt;CTRL-R&gt;</span><span class="synperlPOD">. Repeated </span><span class="synIdentifier">C&lt;CTRL-R&gt;</span><span class="synperlPOD">'s step successively backwards through earlier</span>
<span class="synperlPOD">inputs. </span><span class="synIdentifier">C&lt;CTRL-N&gt;</span><span class="synperlPOD"> steps successfully forward again.</span>
<span class="synperlPOD">You can then use </span><span class="synIdentifier">C&lt;CTRL-B&gt;</span><span class="synperlPOD">/</span><span class="synIdentifier">C&lt;CTRL-F&gt;</span><span class="synperlPOD">/</span><span class="synIdentifier">C&lt;CTRL-A&gt;</span><span class="synperlPOD">/</span><span class="synIdentifier">C&lt;CTRL-E&gt;</span><span class="synperlPOD"> to move the</span>
<span class="synperlPOD">cursor around the line of recalled input, to delete or insert</span>
<span class="synperlPOD">characters. This is useful for modifying and retrying a recently entered</span>
<span class="synperlPOD">regex or string.</span>


<span class="synStatement">=head2</span><span class="synString"> Debugging regexes from a dumped session</span>

<span class="synperlPOD">When called with a filename, </span><span class="synIdentifier">C&lt;rxrx&gt;</span><span class="synperlPOD"> first checks whether the file</span>
<span class="synperlPOD">contains a JSON dump of a previous debugging, in which case it replays</span>
<span class="synperlPOD">the visualization of that regex match interactively.</span>

<span class="synperlPOD">This is useful for debugging non-interactive programs where the</span>
<span class="synIdentifier">C&lt;'save_to'&gt;</span><span class="synperlPOD"> option was used (see </span><span class="synIdentifier">L&lt;&quot;Output configuration&quot;&gt;</span><span class="synperlPOD"> and</span>
<span class="synIdentifier">L&lt;&quot;Configuration API&quot;&gt;</span><span class="synperlPOD">).</span>

<span class="synperlPOD">In this mode, all the features of the interactive debugger (as listed</span>
<span class="synperlPOD">under </span><span class="synIdentifier">L&lt;&quot;INTERFACE&quot;&gt;</span><span class="synperlPOD">) are fully available: you can step forwards and</span>
<span class="synperlPOD">backwards through the match, skip to the successful submatch or a</span>
<span class="synperlPOD">breakpoint, swap visualization modes, and take snapshots.</span>


<span class="synStatement">=head2</span><span class="synString"> Wrap-around regex debugging</span>

<span class="synperlPOD">When called with the name of a file that does </span><span class="synIdentifier">I&lt;not&gt;</span><span class="synperlPOD"> contain a JSON</span>
<span class="synperlPOD">dump, </span><span class="synIdentifier">C&lt;rxrx&gt;</span><span class="synperlPOD"> attempts to execute the file as a Perl program, with</span>
<span class="synperlPOD">Regexp::Debugger enabled at the top level. In other words:</span>

<span class="synPreProc">    rxrx prog.pl</span>

<span class="synperlPOD">is a convenient shorthand for:</span>

<span class="synPreProc">    perl -MRegexp::Debugger prog.pl</span>



<span class="synStatement">=head1</span><span class="synString"> LIMITATIONS</span>

<span class="synStatement">=head2</span><span class="synString"> </span><span class="synIdentifier">C&lt;/x&gt;</span><span class="synString">-mode comments</span>

<span class="synperlPOD">Due to limitations in the Perl </span><span class="synIdentifier">C&lt;overload::constant()&gt;</span><span class="synperlPOD"> mechanism, the</span>
<span class="synperlPOD">current implementation cannot always distinguish whether a regex has an</span>
<span class="synperlPOD">external /x modifier (and hence, what whitespace and comment characters</span>
<span class="synperlPOD">mean). Whitespace is handled correctly in almost all cases, but</span>
<span class="synperlPOD">comments are not.</span>

<span class="synperlPOD">When processing a </span><span class="synIdentifier">C&lt;# comment to end of line&gt;</span><span class="synperlPOD"> within a regex, the module</span>
<span class="synperlPOD">currently assumes a </span><span class="synIdentifier">C&lt;/x&gt;</span><span class="synperlPOD"> is in effect at start of the regex. This will cause</span>
<span class="synperlPOD">erroneous behaviour if an unescaped </span><span class="synIdentifier">C&lt;#&gt;</span><span class="synperlPOD"> is used in a non-</span><span class="synIdentifier">C&lt;/x&gt;</span><span class="synperlPOD"> regex.</span>
<span class="synperlPOD">Note that this limitation is likely to be corrected in a future release.</span>

<span class="synperlPOD">This limitation does not affect the handling of comments in</span>
<span class="synIdentifier">C&lt;(?x:...)&gt;</span><span class="synperlPOD"> and </span><span class="synIdentifier">C&lt;(?-x:...)&gt;</span><span class="synperlPOD"> blocks within the regex. These are</span>
<span class="synperlPOD">always correctly handled, so explicitly using one of these blocks</span>
<span class="synperlPOD">is a reliable workaround...as is always using the </span><span class="synIdentifier">C&lt;/x&gt;</span><span class="synperlPOD"> modifier</span>
<span class="synperlPOD">on every debugged regex.</span>

<span class="synperlPOD">As regards whitespace, the one case where the current implementation</span>
<span class="synperlPOD">does not always correctly infer behaviour is where whitespace is used to</span>
<span class="synperlPOD">separate a repetition qualifier from the atom it qualifies in a non-</span><span class="synIdentifier">C&lt;/x&gt;</span>
<span class="synperlPOD">regex, such as:</span>

<span class="synPreProc">    / x + /</span>

<span class="synperlPOD">Because the module defaults to assuming that regexes always have </span><span class="synIdentifier">C&lt;/x&gt;</span><span class="synperlPOD"> applied,</span>
<span class="synperlPOD">this is always interpreted as:</span>

<span class="synPreProc">    /\ x+\ /x</span>

<span class="synperlPOD">rather than what it really is, namely:</span>

<span class="synPreProc">    /\ x\ +\ /</span>

<span class="synperlPOD">The most reliable workaround for the time being is either to always use</span>
<span class="synIdentifier">C&lt;/x&gt;</span><span class="synperlPOD"> on any regex, or never to separate repetition qualifiers from</span>
<span class="synperlPOD">their preceding atoms.</span>


<span class="synStatement">=head2</span><span class="synString"> Multiple 'save_to' with the same target</span>

<span class="synperlPOD">At present, making the same file the target of two successive </span><span class="synIdentifier">C&lt;save_to&gt;</span><span class="synperlPOD"> requests</span>
<span class="synperlPOD">causes the second JSON data structure to overwrite the first.</span>

<span class="synperlPOD">This limitation will be removed in a subsequent release (but this will</span>
<span class="synperlPOD">certainly involve a small change to the structure of the JSON data that</span>
<span class="synperlPOD">is written, even when only one </span><span class="synIdentifier">C&lt;save_to&gt;</span><span class="synperlPOD"> is specified).</span>


<span class="synStatement">=head2</span><span class="synString"> Variable interpolations</span>

<span class="synperlPOD">The module handles the interpolation of strings correctly,</span>
<span class="synperlPOD">expanding them in-place before debugging begins.</span>

<span class="synperlPOD">However, it currently does not correctly handle the interpolation</span>
<span class="synperlPOD">of </span><span class="synIdentifier">C&lt;qr&gt;</span><span class="synperlPOD">'d regexes. That is, this:</span>

<span class="synPreProc">    use Regexp::Debugger;</span>

<span class="synPreProc">    my $ident = qr{ [^\W\d]\w* }x;      # a qr'd regex...</span>

<span class="synPreProc">    $str =~ m{ ($ident) : (.*) }xms;    # ...interpolated into another regex</span>

<span class="synperlPOD">does not work correctly...and usually will not even compile.</span>

<span class="synperlPOD">It is expected that this limitation will be removed in a future</span>
<span class="synperlPOD">release, however it may only be possible to fix the problem for more</span>
<span class="synperlPOD">recent versions of Perl (i.e. 5.14 and later) in which the regex engine</span>
<span class="synperlPOD">is re-entrant.</span>


<span class="synStatement">=head1</span><span class="synString"> DIAGNOSTICS</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; Odd number of configuration args after &quot;use Regexp::Debugger&quot; &gt;&gt;</span>

<span class="synperlPOD">The module expects configuration arguments (see </span><span class="synIdentifier">L&lt;&quot;Configuration API&quot;&gt;</span><span class="synperlPOD">)</span>
<span class="synperlPOD">to be passed as </span><span class="synIdentifier">C&lt;&lt; key =&gt; value &gt;&gt;</span><span class="synperlPOD"> pairs. You passed something else.</span>


<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; Unknown 'show_ws' option: %s &gt;&gt;</span>

<span class="synperlPOD">The only valid options for the </span><span class="synIdentifier">C&lt;'show_ws'&gt;</span><span class="synperlPOD"> configuration option are</span>
<span class="synIdentifier">C&lt;'compact'&gt;</span><span class="synperlPOD">, </span><span class="synIdentifier">C&lt;'visible'&gt;</span><span class="synperlPOD">, or </span><span class="synIdentifier">C&lt;'original'&gt;</span><span class="synperlPOD">.</span>
<span class="synperlPOD">You specified something else (or misspelled one of the above).</span>


<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; Unknown 'display' option: %s &gt;&gt;</span>

<span class="synperlPOD">The only valid options for the </span><span class="synIdentifier">C&lt;'display'&gt;</span><span class="synperlPOD"> configuration option are</span>
<span class="synIdentifier">C&lt;'visual'&gt;</span><span class="synperlPOD"> or </span><span class="synIdentifier">C&lt;'heatmap'&gt;</span><span class="synperlPOD"> or </span><span class="synIdentifier">C&lt;'events'&gt;</span><span class="synperlPOD"> or </span><span class="synIdentifier">C&lt;'JSON'&gt;</span><span class="synperlPOD">.</span>
<span class="synperlPOD">You specified something else (or misspelled one of the above).</span>

<span class="synStatement">=item</span><span class="synString"> </span><span class="synIdentifier">C&lt;&lt; Invalid 'save_to' option: %s (%s) &gt;&gt;</span>

<span class="synperlPOD">The value associated with the </span><span class="synIdentifier">C&lt;'save_to'&gt;</span><span class="synperlPOD"> option is expected</span>
<span class="synperlPOD">to be a filehandle opened for writing, or else a string containing</span>
<span class="synperlPOD">the name of a file that can be opened for writing. You either passed</span>
<span class="synperlPOD">an unopened filehandle, an unwritable filename, or something that</span>
<span class="synperlPOD">wasn't a plausible file. Alternatively, if you passed a filepath,</span>
<span class="synperlPOD">was the directory not accessible to, or writeable by, you?</span>

<span class="synStatement">=back</span>


<span class="synStatement">=head1</span><span class="synString"> DEPENDENCIES</span>

<span class="synperlPOD">This module only works with Perl 5.10.1 and later.</span>

<span class="synperlPOD">The following modules are used when available:</span>

<span class="synStatement">=over</span>

<span class="synStatement">=item</span><span class="synString"> Term::ANSIColor</span>

<span class="synperlPOD">Text colouring only works if this module can be loaded.</span>
<span class="synperlPOD">Otherwise, all output will be monochromatic.</span>

<span class="synStatement">=item</span><span class="synString"> Win32::Console::ANSI</span>

<span class="synperlPOD">Under Windows, text colouring also requires that this module can be loaded.</span>
<span class="synperlPOD">Otherwise, all output will be monochromatic.</span>

<span class="synStatement">=item</span><span class="synString"> File::HomeDir</span>

<span class="synperlPOD">If it can't find a useful value for </span><span class="synIdentifier">C&lt;$ENV{HOME}&gt;</span><span class="synperlPOD">, Regexp::Debugger</span>
<span class="synperlPOD">attempts to use this module to determine the user's home directory,</span>
<span class="synperlPOD">in order to search for a </span><span class="synIdentifier">F&lt;.rxrx&gt;</span><span class="synperlPOD"> config file.</span>

<span class="synStatement">=item</span><span class="synString"> JSON::XS</span>

<span class="synStatement">=item</span><span class="synString"> JSON</span>

<span class="synStatement">=item</span><span class="synString"> JSON::DWIW</span>

<span class="synStatement">=item</span><span class="synString"> JSON::Syck</span>

<span class="synperlPOD">JSON output (i.e. for the </span><span class="synIdentifier">C&lt;'save_to'&gt;</span><span class="synperlPOD"> option) is only</span>
<span class="synperlPOD">possible if one of these modules can be loaded.</span>
<span class="synperlPOD">Otherwise, all JSON output will default to an empty </span><span class="synIdentifier">C&lt;{}&gt;</span><span class="synperlPOD">.</span>


<span class="synStatement">=item</span><span class="synString"> Term::ReadKey</span>

<span class="synperlPOD">Single-character interactions only work if this module can be loaded.</span>
<span class="synperlPOD">Otherwise, all command interactions will require a </span><span class="synIdentifier">C&lt;&lt; &lt;RETURN&gt; &gt;&gt;</span>
<span class="synperlPOD">after them.</span>


<span class="synStatement">=item</span><span class="synString"> Time::HiRes</span>

<span class="synperlPOD">Autogenerated timestamps (e.g. for snapshots) will only be sub-second</span>
<span class="synperlPOD">accurate if this module can be loaded. Otherwise, all timestamps will</span>
<span class="synperlPOD">only be to the nearest second.</span>

<span class="synStatement">=back</span>


<span class="synStatement">=head1</span><span class="synString"> INCOMPATIBILITIES</span>

<span class="synperlPOD">None reported, but this module will almost certainly not play nicely</span>
<span class="synperlPOD">with any other that modifies regexes using </span><span class="synIdentifier">C&lt;overload::constant&gt;</span><span class="synperlPOD">.</span>


<span class="synStatement">=head1</span><span class="synString"> BUGS AND LIMITATIONS</span>

<span class="synperlPOD">No bugs have been reported.</span>

<span class="synperlPOD">Please report any bugs or feature requests to</span>
<span class="synIdentifier">C&lt;bug-regexp-debugger@rt.cpan.org&gt;</span><span class="synperlPOD">, or through the web interface at</span>
<span class="synIdentifier">L&lt;http://rt.cpan.org&gt;</span><span class="synperlPOD">.</span>


<span class="synStatement">=head1</span><span class="synString"> AUTHOR</span>

<span class="synperlPOD">Damian Conway  </span><span class="synIdentifier">C&lt;&lt; &lt;DCONWAY@CPAN.org&gt; &gt;&gt;</span>


<span class="synStatement">=head1</span><span class="synString"> LICENCE AND COPYRIGHT</span>

<span class="synperlPOD">Copyright (c) 2011-2012, Damian Conway </span><span class="synIdentifier">C&lt;&lt; &lt;DCONWAY@CPAN.org&gt; &gt;&gt;</span><span class="synperlPOD">. All rights reserved.</span>

<span class="synperlPOD">This module is free software; you can redistribute it and/or</span>
<span class="synperlPOD">modify it under the same terms as Perl itself. See </span><span class="synIdentifier">L&lt;perlartistic&gt;</span><span class="synperlPOD">.</span>


<span class="synStatement">=head1</span><span class="synString"> DISCLAIMER OF WARRANTY</span>

<span class="synperlPOD">BECAUSE THIS SOFTWARE IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY</span>
<span class="synperlPOD">FOR THE SOFTWARE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN</span>
<span class="synperlPOD">OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES</span>
<span class="synperlPOD">PROVIDE THE SOFTWARE &quot;AS IS&quot; WITHOUT WARRANTY OF ANY KIND, EITHER</span>
<span class="synperlPOD">EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="synperlPOD">WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE</span>
<span class="synperlPOD">ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH</span>
<span class="synperlPOD">YOU. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL</span>
<span class="synperlPOD">NECESSARY SERVICING, REPAIR, OR CORRECTION.</span>

<span class="synperlPOD">IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING</span>
<span class="synperlPOD">WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR</span>
<span class="synperlPOD">REDISTRIBUTE THE SOFTWARE AS PERMITTED BY THE ABOVE LICENCE, BE</span>
<span class="synperlPOD">LIABLE TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL,</span>
<span class="synperlPOD">OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE</span>
<span class="synperlPOD">THE SOFTWARE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING</span>
<span class="synperlPOD">RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A</span>
<span class="synperlPOD">FAILURE OF THE SOFTWARE TO OPERATE WITH ANY OTHER SOFTWARE), EVEN IF</span>
<span class="synperlPOD">SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF</span>
<span class="synperlPOD">SUCH DAMAGES.</span>
</pre>

 </body>
</html>
